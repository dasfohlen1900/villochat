<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VilloChat - Pro Max</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #075e54; 
            --bg: #f0f2f5; 
            --text-main: 'Inter', sans-serif;
            --text-heading: 'Playfair Display', serif;
        }
        
        body { font-family: var(--text-main); margin: 0; background: var(--bg); height: 100vh; overflow: hidden; color: #333; }
        h2, .header { font-family: var(--text-heading); letter-spacing: 0.5px; }

        /* Toasts */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
        .toast { background: #333; color: white; padding: 12px 24px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: 0.3s; transform: translateY(-20px); }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* Auth Bereich */
        #auth-area { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .auth-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 340px; }
        .tabs { display: flex; margin-bottom: 25px; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 12px; cursor: pointer; text-align: center; color: #999; }
        .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); font-weight: 500; }
        
        input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-family: var(--text-main); outline: none; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 12px; font-family: var(--text-main); }

        /* App Layout */
        #chat-area { display: none; height: 100vh; }
        #sidebar { width: 340px; background: white; border-right: 1px solid #eee; display: flex; flex-direction: column; }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; background: #f7f7f7; }
        .header { padding: 20px; background: white; color: var(--primary); border-bottom: 1px solid #eee; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        #contacts-list { flex-grow: 1; overflow-y: auto; }
        .contact-item { padding: 18px 20px; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: 0.2s; }
        .contact-item:hover { background: #fcfcfc; }
        
        #messages-container { flex-grow: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; }
        
        .msg { padding: 10px 16px; border-radius: 12px; margin-bottom: 15px; max-width: 75%; font-size: 15px; line-height: 1.4; position: relative; }
        .msg-info { font-size: 10px; margin-bottom: 4px; font-weight: 600; opacity: 0.7; display: block; }
        .msg-time { font-size: 9px; margin-top: 4px; display: block; text-align: right; opacity: 0.6; }
        
        .sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }

        #input-area { padding: 20px; background: white; display: flex; gap: 12px; border-top: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="auth-area">
        <div class="auth-box">
            <h2 style="color: var(--primary); margin: 0 0 20px 0; text-align: center;">VilloChat</h2>
            <div class="tabs">
                <div id="tab-login" class="tab active" onclick="switchTab('login')">Login</div>
                <div id="tab-register" class="tab" onclick="switchTab('register')">Neu hier?</div>
            </div>
            <input type="text" id="v-username" placeholder="Nutzername">
            <input type="text" id="v-pin" placeholder="PIN (xxxx-xxxx)" maxlength="9">
            <button id="btn-auth">Anmelden</button>
        </div>
    </div>

    <div id="chat-area">
        <div id="sidebar">
            <div class="header">
                <span id="my-name-display">Profil</span>
                <button onclick="logout()" style="width: auto; padding: 6px 12px; background: #f0f0f0; color: #666; font-size: 11px; margin:0;">Logout</button>
            </div>
            <div style="padding: 15px; display: flex; gap: 8px;">
                <input type="text" id="search-input" placeholder="Name suchen...">
                <button id="btn-search" style="width: 50px; margin:0;">+</button>
            </div>
            <div id="contacts-list"></div>
        </div>
        <div id="main-chat">
            <div id="chat-header" class="header" style="color: #333;">Wähle einen Chat</div>
            <div id="messages-container"></div>
            <div id="input-area">
                <input type="text" id="msg-input" placeholder="Nachricht...">
                <button id="btn-send" style="width: 100px; margin:0;">Senden</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onChildAdded, query, orderByChild, startAt, endAt, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3wZU09SzNh7xZFPFjPHR9nhDCWkGzj7E",
            authDomain: "villochat.firebaseapp.com",
            databaseURL: "https://villochat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "villochat",
            storageBucket: "villochat.firebasestorage.app",
            messagingSenderId: "257561919332",
            appId: "1:257561919332:web:712d942c2f2e07169e8471"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentMode = 'login', myUsername = "", activeChatId = null;

        function notify(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast'; toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        window.switchTab = (mode) => {
            currentMode = mode;
            document.getElementById('tab-login').className = mode === 'login' ? 'tab active' : 'tab';
            document.getElementById('tab-register').className = mode === 'register' ? 'tab active' : 'tab';
            document.getElementById('btn-auth').innerText = mode === 'login' ? 'Anmelden' : 'Konto erstellen';
        };

        document.getElementById('v-pin').addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 4) val = val.slice(0, 4) + '-' + val.slice(4, 8);
            e.target.value = val;
        });

        document.getElementById('btn-auth').onclick = async () => {
            const user = document.getElementById('v-username').value.trim();
            const pin = document.getElementById('v-pin').value;
            if (!/^[a-zA-Z0-9.\-_*]+$/.test(user)) return notify("Name ungültig!");
            if (!/^\d{4}-\d{4}$/.test(pin)) return notify("PIN Format: 1234-5678");

            const userRef = ref(db, 'accounts/' + user);
            const snap = await get(userRef);

            if (currentMode === 'register') {
                if (snap.exists()) return notify("Name belegt!");
                await set(userRef, { username: user, pin: pin, id: user.toLowerCase() });
                notify("Erstellt! Bitte einloggen."); switchTab('login');
            } else {
                if (!snap.exists() || snap.val().pin !== pin) return notify("Daten falsch!");
                await signInAnonymously(auth); myUsername = user;
                localStorage.setItem('villo_session', user); showApp();
            }
        };

        function showApp() {
            document.getElementById('auth-area').style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            document.getElementById('my-name-display').innerText = myUsername;
            syncContacts();
        }

        // Live-Synchronisation der Kontakte (für Auto-Add von anderen)
        function syncContacts() {
            const contactsRef = ref(db, `accounts/${myUsername}/contacts`);
            onValue(contactsRef, (snap) => {
                const list = document.getElementById('contacts-list');
                list.innerHTML = ""; // Liste neu aufbauen bei Änderung
                if (snap.exists()) {
                    Object.values(snap.val()).forEach(name => renderContactUI(name));
                }
            });
        }

        document.getElementById('btn-search').onclick = async () => {
            const searchStr = document.getElementById('search-input').value.trim().toLowerCase();
            if (!searchStr) return;

            const q = query(ref(db, 'accounts'), orderByChild('id'), startAt(searchStr), endAt(searchStr + "\uf8ff"));
            const snap = await get(q);

            if (snap.exists()) {
                const results = snap.val();
                let foundAny = false;
                for (let key in results) {
                    const foundName = results[key].username;
                    if (foundName !== myUsername) {
                        addContactGegenseitig(foundName);
                        foundAny = true;
                    }
                }
                if (foundAny) {
                    notify("Kontakt(e) hinzugefügt!");
                    document.getElementById('search-input').value = "";
                } else notify("Niemand neues gefunden.");
            } else notify("Keine Treffer.");
        };

        // Der Kern des Auto-Adds
        async function addContactGegenseitig(targetName) {
            // 1. In MEINE Liste (falls noch nicht da)
            const myContRef = ref(db, `accounts/${myUsername}/contacts`);
            const mySnap = await get(myContRef);
            let ichHabeIhn = mySnap.exists() ? Object.values(mySnap.val()).includes(targetName) : false;
            if(!ichHabeIhn) push(myContRef, targetName);

            // 2. In SEINE Liste (Auto-Add bei ihm)
            const hisContRef = ref(db, `accounts/${targetName}/contacts`);
            const hisSnap = await get(hisContRef);
            let erHatMich = hisSnap.exists() ? Object.values(hisSnap.val()).includes(myUsername) : false;
            if(!erHatMich) push(hisContRef, myUsername);
        }

        function renderContactUI(name) {
            const list = document.getElementById('contacts-list');
            const div = document.createElement('div');
            div.className = 'contact-item'; div.innerText = name;
            div.onclick = () => startChat(name);
            list.appendChild(div);
        }

        function startChat(targetName) {
            activeChatId = myUsername < targetName ? `${myUsername}_${targetName}` : `${targetName}_${myUsername}`;
            document.getElementById('chat-header').innerText = targetName;
            const container = document.getElementById('messages-container');
            container.innerHTML = "";
            
            const chatRef = ref(db, 'chats/' + activeChatId);
            onChildAdded(chatRef, (snap) => {
                const m = snap.val();
                renderMessage(m);
            });
        }

        function renderMessage(m) {
            const container = document.getElementById('messages-container');
            const d = document.createElement('div');
            const isMe = m.sender === myUsername;
            const timeStr = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            d.className = 'msg ' + (isMe ? 'sent' : 'received');
            d.innerHTML = `
                <span class="msg-info">${isMe ? 'Du' : m.sender}</span>
                ${m.text}
                <span class="msg-time">${timeStr}</span>
            `;
            container.appendChild(d);
            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('btn-send').onclick = () => {
            const input = document.getElementById('msg-input');
            if (!input.value.trim() || !activeChatId) return;
            push(ref(db, 'chats/' + activeChatId), { 
                sender: myUsername, 
                text: input.value, 
                timestamp: Date.now() 
            });
            input.value = "";
        };

        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'msg-input') document.getElementById('btn-send').click();
                if (document.activeElement.id === 'search-input') document.getElementById('btn-search').click();
                if (document.activeElement.id === 'v-pin' || document.activeElement.id === 'v-username') document.getElementById('btn-auth').click();
            }
        });

        window.logout = () => { localStorage.removeItem('villo_session'); location.reload(); };
        window.onload = () => { const s = localStorage.getItem('villo_session'); if (s) { myUsername = s; showApp(); } };
    </script>
</body>
</html>
