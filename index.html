<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>VilloChat - Version 5.6</title>
    
    <!-- Standard Favicon (multiple formats for compatibility) -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABMLAAATCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¬</text></svg>">
    <link rel="icon" type="image/png" sizes="16x16" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¬</text></svg>">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23075e54%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2270%22 text-anchor=%22middle%22>ğŸ’¬</text></svg>">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23075e54%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2270%22 text-anchor=%22middle%22>ğŸ’¬</text></svg>">
    <link rel="apple-touch-icon" sizes="144x144" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23075e54%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2270%22 text-anchor=%22middle%22>ğŸ’¬</text></svg>">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23075e54%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2270%22 text-anchor=%22middle%22>ğŸ’¬</text></svg>">
    <link rel="apple-touch-icon" sizes="76x76" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23075e54%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2270%22 text-anchor=%22middle%22>ğŸ’¬</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23075e54%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2270%22 text-anchor=%22middle%22>ğŸ’¬</text></svg>">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVmlsbG9DaGF0Iiwic2hvcnRfbmFtZSI6IlZpbGxvQ2hhdCIsImRlc2NyaXB0aW9uIjoiUmVhbHRpbWUtQ2hhdC1BcHAgbWl0IEZpcmViYXNlIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmMGYyZjUiLCJ0aGVtZV9jb2xvciI6IiMwNzVlNTQiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHJlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzA3NWU1NCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzcwJyBmb250LXNpemU9JzcwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJz7wn5KsPC90ZXh0Pjwvc3ZnPiIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VilloChat">
    <meta name="application-name" content="VilloChat">
    <meta name="theme-color" content="#075e54">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --primary: #075e54; 
            --bg: #f0f2f5; 
            --white: #ffffff; 
            --text-main: 'Inter', 'Noto Color Emoji', sans-serif; 
            --text-heading: 'Playfair Display', 'Noto Color Emoji', serif;
            --msg-font-size: 15px;
            --my-bubble-color: #dcf8c6;
            --bubble-radius: 12px;
            --sidebar-width: 350px;
        }
        
        /* Dark Mode Variables â€” Improved contrast & readability */
        body.dark-mode {
            --primary: #25d366;
            --bg: #0b141a;
            --white: #1f2c33;
            --text-color: #e9edef;
            --msg-sent: #005c4b;
            --msg-received: #1f2c33;
            --border-color: #2d3a41;
            --input-bg: #2a3942;
        }

        /* Dark Mode â€” extended rules */
        body.dark-mode .modal {
            background: #1f2c33;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        body.dark-mode .overlay {
            background: rgba(0,0,0,0.75);
        }
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select {
            background: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: rgba(255,255,255,0.3);
        }
        body.dark-mode button {
            border-color: var(--border-color);
        }
        body.dark-mode .dropdown-menu {
            background: #233038;
            border-color: var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        body.dark-mode .menu-item:hover {
            background: rgba(255,255,255,0.06);
        }
        body.dark-mode .msg-context-menu {
            background: #233038;
            border-color: var(--border-color);
            box-shadow: 0 4px 24px rgba(0,0,0,0.6);
        }
        body.dark-mode .msg-context-item:hover {
            background: rgba(255,255,255,0.07);
        }
        body.dark-mode .contact-item:hover {
            background: rgba(255,255,255,0.05);
        }
        body.dark-mode .contact-item.active {
            background: rgba(37,211,102,0.12);
        }
        body.dark-mode .reply-quote {
            background: rgba(255,255,255,0.06);
            border-color: var(--primary);
        }
        body.dark-mode mark {
            background: rgba(255,230,0,0.35);
            color: var(--text-color);
        }
        body.dark-mode .pinned-msg-bar {
            background: #1a2b34;
            border-color: var(--border-color);
        }
        body.dark-mode #emoji-picker-container {
            background: #1a2b34;
            border-color: var(--border-color);
        }
        
        body {
            --text-color: #000;
            --msg-sent: #dcf8c6;
            --msg-received: #ffffff;
            --border-color: #e0e0e0;
            --input-bg: #ffffff;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: var(--text-main); 
            margin: 0; 
            background: var(--bg); 
            height: 100vh; 
            overflow: hidden;
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Allow selection only in input fields */
        input, textarea, #emoji-search, #chat-search-input, #search-input, #alias-input {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        /* Overlays */
        .overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 5000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal {
            animation: slideUp 0.25s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 18px; height: 18px;
            border: 2px solid rgba(0,0,0,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        body.dark-mode .loading-spinner {
            border-color: rgba(255,255,255,0.15);
            border-top-color: var(--primary);
        }
        
        .modal { 
            background: var(--white); 
            width: 100%; 
            max-width: 400px; 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        .modal-header { 
            padding: 15px 20px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .modal-body { padding: 20px; }

        /* Layout */
        #chat-area { display: none; height: 100vh; width: 100vw; overflow: hidden; position: relative; }
        #sidebar { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            left: 0; 
            top: 0; 
            background: var(--white); 
            z-index: 10; 
            transition: 0.3s ease; 
            display: flex; 
            flex-direction: column; 
        }
        #main-chat { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            left: 100%; 
            top: 0; 
            background: #e5ddd5; 
            z-index: 20; 
            transition: 0.3s ease; 
            display: flex; 
            flex-direction: column; 
        }
        
        body.dark-mode #main-chat {
            background: #0b141a;
        }

        /* Mobile View State */
        .chat-open #sidebar { transform: translateX(-20%); }
        .chat-open #main-chat { transform: translateX(-100%); }

        /* Desktop View */
        @media (min-width: 768px) {
            #chat-area { display: flex !important; position: relative; }
            #sidebar { position: relative; width: var(--sidebar-width); min-width: 250px; max-width: 600px; transform: none !important; border-right: 1px solid var(--border-color); }
            #main-chat { position: relative; width: calc(100% - var(--sidebar-width)); left: 0; transform: none !important; }
            .back-btn { display: none; }
            
            /* Focus mode */
            body.focus-mode #sidebar { display: none; }
            body.focus-mode #main-chat { width: 100%; }
        }
        
        /* Resize handle */
        #resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            z-index: 100;
            background: transparent;
        }
        #resize-handle:hover {
            background: var(--primary);
            opacity: 0.3;
        }
        @media (max-width: 767px) {
            #resize-handle { display: none; }
        }

        .header { 
            padding: 15px 20px; 
            background: var(--white); 
            color: var(--primary); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            min-height: 70px; 
            z-index: 30; 
        }
        .header h2 { font-family: var(--text-heading); font-size: 20px; margin: 0; flex-grow: 1; }
        
        #contacts-list { flex-grow: 1; overflow-y: auto; background: var(--white); }
        .contact-item { 
            padding: 12px 20px; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            position: relative;
        }
        .contact-item:hover { background: var(--bg); }
        
        /* Pinned Contact Styling */
        .contact-item.pinned {
            background: linear-gradient(90deg, var(--primary) 0%, transparent 100%);
            background-size: 4px 100%;
            background-repeat: no-repeat;
            background-position: left;
        }

        /* Avatare */
        .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            margin-right: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-family: var(--text-heading); 
            text-transform: uppercase; 
            font-size: 18px; 
            flex-shrink: 0;
            position: relative;
        }
        
        /* Online Status Indicator */
        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: #25d366;
            border: 2px solid var(--white);
            border-radius: 50%;
        }
        
        /* Unread Badge */
        .unread-badge {
            background: #dc3545;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        /* Pin Icon */
        .pin-icon {
            font-size: 14px;
            margin-left: 5px;
            opacity: 0.6;
        }

        /* Schreibt-Status */
        #typing-status { 
            font-size: 12px; 
            font-style: italic; 
            color: var(--primary); 
            padding: 5px 20px; 
            min-height: 22px; 
        }

        /* Datums-Trenner */
        .date-separator { 
            text-align: center; 
            margin: 15px 0; 
            font-size: 12px; 
            color: #888; 
        }
        .date-separator span { 
            background: #e5ddd5; 
            padding: 5px 12px; 
            border-radius: 8px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        
        body.dark-mode .date-separator span {
            background: #182229;
            color: #aaa;
        }

        #messages-container { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }
        .msg { 
            padding: 10px 14px; 
            border-radius: var(--bubble-radius);
            margin-bottom: 10px; 
            max-width: 85%; 
            font-size: var(--msg-font-size);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            word-wrap: break-word;
            transition: background-color 0.15s ease, transform 0.1s ease;
        }
        .msg:hover {
            background-color: rgba(0,0,0,0.02) !important;
        }
        body.dark-mode .msg:hover {
            background-color: rgba(255,255,255,0.03) !important;
        }
        .sent { 
            align-self: flex-end; 
            background: var(--my-bubble-color);
            border-bottom-right-radius: 2px; 
        }
        .received { 
            align-self: flex-start; 
            background: var(--msg-received); 
            border-bottom-left-radius: 2px; 
        }
        
        /* Minimal bubble style */
        body.bubble-minimal .msg {
            box-shadow: none;
            border-radius: 6px !important;
        }
        body.bubble-minimal .sent { border-bottom-right-radius: 0 !important; }
        body.bubble-minimal .received { border-bottom-left-radius: 0 !important; }
        
        /* Image preview in messages */
        .msg-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            display: block;
            margin: 4px 0;
            cursor: pointer;
            object-fit: contain;
        }
        .msg-image:hover { opacity: 0.9; }
        
        /* Lightbox */
        #lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 20000;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        #lightbox img {
            max-width: 95vw;
            max-height: 95vh;
            border-radius: 8px;
            object-fit: contain;
        }
        #lightbox.show { display: flex; }
        
        /* Embed card */
        .msg-embed {
            margin: 6px 0;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0,0,0,0.05);
        }
        .msg-embed iframe {
            width: 100%;
            max-width: 360px;
            height: 200px;
            border: none;
            display: block;
        }
        .msg-embed-thumb {
            position: relative;
            cursor: pointer;
        }
        .msg-embed-thumb img {
            width: 100%;
            max-width: 360px;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .msg-embed-play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
        }
        .msg-embed-play span {
            font-size: 48px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .msg-embed-info {
            padding: 8px 10px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Forward indicator */
        .msg-forwarded {
            font-size: 11px;
            opacity: 0.6;
            font-style: italic;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Poll message */
        .msg-poll { min-width: 220px; max-width: 300px; }
        .poll-question { font-weight: 600; margin-bottom: 10px; font-size: 14px; }
        .poll-option {
            margin: 6px 0; cursor: pointer; border-radius: 8px; overflow: hidden;
            border: 1.5px solid var(--border-color); position: relative; transition: border-color 0.15s;
        }
        .poll-option:hover { border-color: var(--primary); }
        .poll-option.voted { border-color: var(--primary); }
        .poll-option.closed {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .poll-option-bar {
            position: absolute; left: 0; top: 0; bottom: 0;
            background: rgba(7,94,84,0.13); transition: width 0.4s ease; border-radius: 6px;
        }
        .poll-option-label {
            position: relative; z-index: 1; padding: 7px 10px;
            display: flex; justify-content: space-between; align-items: center; font-size: 13px;
        }
        .poll-option-pct { font-size: 11px; font-weight: 600; opacity: 0.7; margin-left: 8px; }
        .poll-meta { font-size: 11px; opacity: 0.5; margin-top: 8px; text-align: right; }
        .contact-note-dot {
            width: 7px; height: 7px; background: var(--primary);
            border-radius: 50%; flex-shrink: 0;
        }
        @media (max-width: 600px) { #main-chat { touch-action: pan-y; } }

        /* Pinned message bar */
        #pinned-msg-bar {
            padding: 8px 15px;
            background: var(--white);
            border-bottom: 2px solid var(--primary);
            cursor: pointer;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.2s ease;
        }
        #pinned-msg-bar.visible { display: flex !important; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg.pinned-msg { border-left: 3px solid var(--primary); }

        #my-profile-top-contacts .top-contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        /* Forward contact picker */
        .forward-contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .forward-contact-item:hover { background: var(--bg); }
        .forward-contact-item.selected { background: rgba(7,94,84,0.1); }
        .forward-contact-item .fwd-check {
            width: 22px; height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        .forward-contact-item.selected .fwd-check {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Timestamp tooltip */
        .msg-time {
            font-size: 9px;
            display: block;
            text-align: right;
            opacity: 0.5;
            margin-top: 4px;
            position: relative;
        }
        .msg-time .full-date {
            display: none;
            position: absolute;
            bottom: 100%;
            right: 0;
            background: rgba(0,0,0,0.75);
            color: white;
            padding: 3px 7px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
        }
        .msg-time:hover .full-date { display: block; }
        
        /* Archived / Muted badges */
        .contact-item .muted-icon {
            font-size: 13px;
            opacity: 0.5;
            margin-left: 4px;
        }
        .contact-item .archived-icon {
            font-size: 13px;
            opacity: 0.5;
            margin-left: 4px;
        }
        
        /* Archive section */
        .archive-header {
            padding: 8px 15px;
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            border-top: 1px solid var(--border-color);
        }
        .archive-header:hover { background: var(--bg); }
        
        /* Status text under name */
        .contact-status {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 1px;
        }
        
        /* Global search */
        #global-search-overlay .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        #global-search-overlay .search-result-item:hover { background: var(--bg); }
        #global-search-overlay .search-result-chat {
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #global-search-overlay .search-result-chat .avatar {
            width: 22px;
            height: 22px;
            font-size: 11px;
        }
        #global-search-overlay .search-result-text { font-size: 13px; }
        #global-search-overlay .search-result-text mark { background: yellow; border-radius: 2px; }
        
        /* Scroll badge */
        #scroll-to-bottom .scroll-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 10px;
            font-size: 10px;
            padding: 1px 5px;
            min-width: 16px;
            text-align: center;
        }
        
        .msg-edited {
            font-size: 9px;
            opacity: 0.5;
            font-style: italic;
            margin-left: 4px;
        }
        
        /* Reply Quote Styling */
        .reply-quote {
            background: rgba(0,0,0,0.1);
            border-left: 3px solid var(--primary);
            padding: 6px 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 13px;
            opacity: 0.8;
        }
        .reply-quote .reply-sender {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 2px;
        }
        
        .msg p { margin: 0; }
        .msg-time { 
            font-size: 9px; 
            display: block; 
            text-align: right; 
            opacity: 0.5; 
            margin-top: 4px; 
        }
        
        /* LesebestÃ¤tigungen */
        .msg-status { 
            display: inline-block; 
            margin-left: 4px; 
            font-size: 10px; 
        }
        .check-sent { color: #999; }
        .check-read { color: #34b7f1; }

        #input-area { 
            padding: 15px; 
            background: var(--bg); 
            display: flex; 
            gap: 10px; 
            align-items: center;
            /* iOS Safe Area: Abstand zur Home-Indicator-Leiste */
            padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
        }
        #msg-input { 
            border-radius: 25px; 
            border: none; 
            flex-grow: 1; 
            padding: 12px 20px; 
            outline: none; 
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        /* Edit Mode */
        #edit-mode-bar {
            display: none;
            background: var(--white);
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
        }
        #edit-mode-bar.active {
            display: flex;
        }
        #edit-mode-bar .edit-content {
            flex-grow: 1;
            font-size: 13px;
            opacity: 0.7;
        }
        #edit-mode-bar .edit-cancel {
            cursor: pointer;
            font-size: 18px;
            opacity: 0.5;
        }
        
        /* Reply Bar */
        #reply-bar {
            display: none;
            background: var(--white);
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
        }
        #reply-bar .reply-content {
            flex-grow: 1;
            font-size: 13px;
            opacity: 0.7;
        }
        #reply-bar .reply-cancel {
            cursor: pointer;
            font-size: 18px;
            opacity: 0.5;
        }
        
        .settings-btn { cursor: pointer; font-size: 20px; margin-left: 10px; }
        .back-btn { font-size: 24px; margin-right: 15px; cursor: pointer; }

        /* Three-Dot Menu */
        .menu-container {
            position: relative;
        }
        .menu-dots {
            cursor: pointer;
            font-size: 20px;
            padding: 5px 10px;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
        }
        .dropdown-menu.show {
            display: block;
        }
        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        .menu-item:hover {
            background: var(--bg);
        }

        /* Auth */
        #auth-area { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            padding: 20px; 
        }
        .auth-box { 
            background: var(--white); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            width: 100%; 
            max-width: 360px; 
        }
        input[type="text"], input[type="password"] { 
            font-family: 'Inter'; 
            width: 100%; 
            padding: 14px; 
            margin: 8px 0; 
            border: 1px solid var(--border-color); 
            border-radius: 12px;
            background: var(--input-bg);
            color: var(--text-color);
        }
        button { 
            padding: 14px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            transform: scale(1);
        }
        button:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1) !important;
        }
        
        /* Encryption Notice */
        .encryption-notice {
            background: #fff3cd;
            color: #856404;
            padding: 8px 15px;
            font-size: 12px;
            text-align: center;
            border-bottom: 1px solid #ffeaa7;
            transition: opacity 0.3s, max-height 0.3s;
            max-height: 40px;
            overflow: hidden;
        }
        
        .encryption-notice.hidden {
            opacity: 0;
            max-height: 0;
            padding: 0;
        }
        
        body.dark-mode .encryption-notice {
            background: #3d3311;
            color: #ffd93d;
            border-bottom-color: #5a4a1a;
        }
        
        /* Message Context Menu */
        .msg-menu {
            font-size: 12px;
            opacity: 0;
            margin-left: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .msg:hover .msg-menu {
            opacity: 0.5;
        }
        .msg-menu:hover {
            opacity: 1 !important;
        }
        
        /* Message Context Menu Popup */
        .msg-context-menu {
            position: fixed;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            display: none;
            min-width: 200px;
            overflow: hidden;
        }
        .msg-context-menu.show {
            display: block;
        }
        .msg-context-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }
        .msg-context-item:last-child {
            border-bottom: none;
        }
        .msg-context-item:hover {
            background: var(--bg);
        }
        .msg-context-item .icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Reaction Picker */
        .reaction-picker {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: var(--white);
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .reaction-picker span {
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 12px;
            transition: transform 0.2s;
        }
        .reaction-picker span:hover {
            transform: scale(1.3);
            background: var(--bg);
        }
        
        /* Message Reactions */
        .msg-reactions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .msg-reaction {
            background: var(--bg);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .msg-reaction:hover {
            background: var(--border-color);
        }
        .msg-reaction.my-reaction {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Scroll to Bottom Button */
        #scroll-to-bottom {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 100;
            transition: opacity 0.3s, transform 0.3s;
        }
        #scroll-to-bottom:hover {
            transform: scale(1.1);
        }
        #scroll-to-bottom.show {
            display: flex;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            text-align: center;
            padding: 40px;
        }
        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        .empty-state-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color);
            opacity: 0.5;
        }
        .empty-state-subtitle {
            font-size: 16px;
            opacity: 0.5;
        }
        
        /* Theme Button Active State */
        .theme-btn.active {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }
        
        /* Accent Color Picker */
        .accent-color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }
        .accent-color-option:hover {
            transform: scale(1.15);
        }
        .accent-color-option.active {
            border-color: var(--text-color);
            transform: scale(1.1);
        }
        
        /* Font Size Options */
        .font-size-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            background: var(--white);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .font-size-option:hover {
            background: var(--bg);
        }
        .font-size-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Emoji Picker */
        .emoji-item {
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            text-align: center;
            user-select: none;
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }
        .emoji-item:hover {
            background: var(--bg);
            transform: scale(1.2);
        }
        
        /* Ensure emojis render properly in messages */
        .msg, #msg-input, .avatar {
            font-family: 'Inter', 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-toast.success { border-left: 4px solid #25d366; }
        .notification-toast.error { border-left: 4px solid #dc3545; }
        .notification-toast.warning { border-left: 4px solid #ffc107; }
        
        /* Stories */
        #stories-bar::-webkit-scrollbar { display: none; }
        .story-bubble { display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; flex-shrink:0; }
        .story-bubble .story-ring {
            width:48px; height:48px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:22px; font-weight:bold; color:white;
            border:3px solid var(--border-color);
            transition: border-color 0.2s;
        }
        .story-bubble.has-story .story-ring {
            border:3px solid var(--primary);
            box-shadow: 0 0 0 2px var(--white), 0 0 0 4px var(--primary);
        }
        .story-bubble .story-name { font-size:10px; max-width:52px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; opacity:0.7; }
        #story-viewer-overlay { display:none !important; }
        #story-viewer-overlay.show { display:flex !important; }
        #story-create-overlay[style*="flex"] .modal { display: flex; }
        /* Avatar type buttons */
        #avtype-letter, #avtype-emoji, #avtype-image { transition: all 0.15s; border-radius: 8px; padding: 8px; cursor: pointer; }

        body.dark-mode .notification-toast {
            background: var(--white);
            color: var(--text-color);
        }

        /* Settings Tabs */
        .settings-tab {
            padding: 11px 18px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px;
            margin: 2px 8px;
            transition: background 0.15s;
            color: var(--text-color);
            white-space: nowrap;
        }
        .settings-tab:hover { background: rgba(0,0,0,0.05); }
        body.dark-mode .settings-tab:hover { background: rgba(255,255,255,0.07); }
        .settings-tab.active { background: var(--primary); color: white; font-weight: 600; }
        .settings-label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        /* Mobile: settings sidebar becomes horizontal tab-bar */
        @media (max-width: 600px) {
            #settings-sidebar {
                width: 100% !important;
                flex-direction: row !important;
                border-right: none !important;
                border-bottom: 1px solid var(--border-color) !important;
                padding: 6px 4px !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                flex-shrink: 0 !important;
                gap: 2px !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            #settings-sidebar::-webkit-scrollbar { display: none; }
            #settings-sidebar .settings-tab {
                font-size: 11px !important;
                padding: 6px 10px !important;
                margin: 0 2px !important;
                white-space: nowrap !important;
                border-radius: 20px !important;
            }
            #settings-content { padding: 14px !important; }
            /* inner body becomes column on mobile */
            #settings-overlay .modal > div:nth-child(2) {
                flex-direction: column !important;
            }
            /* On mobile the modal should not be fixed height */
            #settings-overlay .modal {
                height: 92vh !important;
                max-height: 92vh !important;
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 16px 16px 0 0 !important;
                margin-top: auto !important;
                margin-bottom: 0 !important;
            }
            #settings-overlay {
                align-items: flex-end !important;
            }
        }
    </style>
</head>
<body>
    <div class="notification-toast" id="notification-toast"></div>
    
    <div id="settings-overlay" class="overlay">
        <div class="modal" style="max-width:700px; width:95vw; max-height:85vh; height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden;">
            <!-- Header -->
            <div class="modal-header" style="flex-shrink:0; padding:15px 20px;">
                <h2>âš™ï¸ Einstellungen</h2>
                <span style="cursor:pointer; font-size:20px;" onclick="closeOverlay('settings-overlay')">âœ•</span>
            </div>
            <!-- Body: sidebar + content -->
            <div style="display:flex; flex:1; overflow:hidden; min-height:0;">
                <!-- Sidebar (desktop) / Tab-bar (mobile) -->
                <div id="settings-sidebar" style="width:180px; flex-shrink:0; border-right:1px solid var(--border-color); display:flex; flex-direction:column; padding:12px 0; background:var(--bg); overflow-y:auto;">
                    <div class="settings-tab active" data-tab="personalization" onclick="switchSettingsTab('personalization')">ğŸ¨ <span class="tab-label">Personalisierung</span></div>
                    <div class="settings-tab" data-tab="profile" onclick="switchSettingsTab('profile')">ğŸ‘¤ <span class="tab-label">Profil</span></div>
                    <div class="settings-tab" data-tab="security" onclick="switchSettingsTab('security')">ğŸ”’ <span class="tab-label">Sicherheit</span></div>
                    <div class="settings-tab" data-tab="help" onclick="switchSettingsTab('help')">â“ <span class="tab-label">Hilfe</span></div>
                </div>
                <!-- Content -->
                <div id="settings-content" style="flex:1; overflow-y:auto; padding:20px;">

                    <!-- PERSONALIZATION -->
                    <div id="stab-personalization" class="settings-panel">
                        <h3 style="margin-top:0; color:var(--primary);">ğŸ¨ Personalisierung</h3>

                        <label class="settings-label">Design:</label>
                        <div style="display:flex; gap:8px; margin-bottom:16px;">
                            <button id="theme-system" class="theme-btn" onclick="setTheme('system')" style="flex:1; padding:10px; border:2px solid var(--border-color); background:var(--white); color:var(--text-color); border-radius:8px;">ğŸŒ“ System</button>
                            <button id="theme-light" class="theme-btn" onclick="setTheme('light')" style="flex:1; padding:10px; border:2px solid var(--border-color); background:var(--white); color:var(--text-color); border-radius:8px;">â˜€ï¸ Hell</button>
                            <button id="theme-dark" class="theme-btn" onclick="setTheme('dark')" style="flex:1; padding:10px; border:2px solid var(--border-color); background:var(--white); color:var(--text-color); border-radius:8px;">ğŸŒ™ Dunkel</button>
                        </div>

                        <label class="settings-label">Akzentfarbe:</label>
                        <div id="accent-color-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; margin-bottom:16px;">
                            <div class="accent-color-option" data-color="#dc3545" data-name="Rot" style="background:#dc3545;" title="Rot"></div>
                            <div class="accent-color-option" data-color="#fd7e14" data-name="Orange" style="background:#fd7e14;" title="Orange"></div>
                            <div class="accent-color-option" data-color="#ffc107" data-name="Gold" style="background:#ffc107;" title="Gold"></div>
                            <div class="accent-color-option" data-color="#ffeb3b" data-name="Gelb" style="background:#ffeb3b;" title="Gelb"></div>
                            <div class="accent-color-option" data-color="#cddc39" data-name="Limette" style="background:#cddc39;" title="Limette"></div>
                            <div class="accent-color-option" data-color="#075e54" data-name="GrÃ¼n" style="background:#075e54;" title="GrÃ¼n (Standard)"></div>
                            <div class="accent-color-option" data-color="#00bcd4" data-name="Himmelblau" style="background:#00bcd4;" title="Himmelblau"></div>
                            <div class="accent-color-option" data-color="#3f51b5" data-name="Indigo" style="background:#3f51b5;" title="Indigo"></div>
                            <div class="accent-color-option" data-color="#2196f3" data-name="Blau" style="background:#2196f3;" title="Blau"></div>
                            <div class="accent-color-option" data-color="#9c27b0" data-name="Violett" style="background:#9c27b0;" title="Violett"></div>
                            <div class="accent-color-option" data-color="#e91e63" data-name="Pink" style="background:#e91e63;" title="Pink"></div>
                            <div class="accent-color-option" data-color="#ff9e80" data-name="Pfirsich" style="background:#ff9e80;" title="Pfirsich"></div>
                            <div class="accent-color-option" data-color="#424242" data-name="Schwarz" style="background:#424242;" title="Schwarz"></div>
                        </div>

                        <label class="settings-label">SchriftgrÃ¶ÃŸe:</label>
                        <div style="display:flex; gap:8px; margin-bottom:16px;">
                            <div class="font-size-option" data-size="13px" data-name="Klein">Klein</div>
                            <div class="font-size-option" data-size="15px" data-name="Normal">Normal</div>
                            <div class="font-size-option" data-size="17px" data-name="GroÃŸ">GroÃŸ</div>
                            <div class="font-size-option" data-size="20px" data-name="Sehr GroÃŸ">XL</div>
                        </div>

                        <label class="settings-label">Bubble-Stil:</label>
                        <div style="display:flex; gap:8px; margin-bottom:16px;">
                            <div class="font-size-option" data-style="rounded" onclick="setBubbleStyle('rounded')" style="font-size:12px;">â— Rund</div>
                            <div class="font-size-option" data-style="square" onclick="setBubbleStyle('square')" style="font-size:12px;">â–  Eckig</div>
                            <div class="font-size-option" data-style="minimal" onclick="setBubbleStyle('minimal')" style="font-size:12px;">â€“ Minimal</div>
                        </div>

                        <label class="settings-label">Meine Bubble-Farbe:</label>
                        <input type="color" id="my-bubble-color-picker" value="#dcf8c6" style="width:100%; height:40px; margin-bottom:16px; cursor:pointer;">

                        <label class="settings-label">Chat-Hintergrund:</label>
                        <input type="color" id="bg-color-picker" value="#e5ddd5" style="width:100%; height:40px; margin-bottom:16px;">

                        <label class="settings-label">Schnellreaktionen:</label>
                        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:8px;">
                            <input type="text" id="quick-reaction-1" maxlength="2" placeholder="â¤ï¸" style="width:100%; text-align:center; font-size:20px; padding:8px;">
                            <input type="text" id="quick-reaction-2" maxlength="2" placeholder="ğŸ‘" style="width:100%; text-align:center; font-size:20px; padding:8px;">
                            <input type="text" id="quick-reaction-3" maxlength="2" placeholder="ğŸ˜‚" style="width:100%; text-align:center; font-size:20px; padding:8px;">
                            <input type="text" id="quick-reaction-4" maxlength="2" placeholder="ğŸ˜®" style="width:100%; text-align:center; font-size:20px; padding:8px;">
                            <input type="text" id="quick-reaction-5" maxlength="2" placeholder="ğŸ˜¢" style="width:100%; text-align:center; font-size:20px; padding:8px;">
                            <input type="text" id="quick-reaction-6" maxlength="2" placeholder="ğŸ™" style="width:100%; text-align:center; font-size:20px; padding:8px;">
                        </div>
                        <button onclick="saveQuickReactions()" style="width:100%; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">Reaktionen speichern</button>

                        <label class="settings-label" style="margin-top:16px;">Sound:</label>
                        <label style="display:flex; align-items:center; cursor:pointer; margin-bottom:16px;">
                            <input type="checkbox" id="sound-toggle" style="width:auto; margin-right:10px;">
                            <span>ğŸ”Š Benachrichtigungston aktivieren</span>
                        </label>
                    </div>

                    <!-- PROFILE -->
                    <div id="stab-profile" class="settings-panel" style="display:none;">
                        <h3 style="margin-top:0; color:var(--primary);">ğŸ‘¤ Profil</h3>
                        <div style="text-align:center; margin-bottom:20px;">
                            <div id="settings-avatar-preview" style="width:80px; height:80px; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:36px; font-weight:bold; color:white;"></div>
                            <div style="font-size:18px; font-weight:700;" id="set-username"></div>
                            <div style="font-size:12px; color:#999; margin-top:4px;">Version 5.6 Â· <a href="#" onclick="event.preventDefault(); closeOverlay('settings-overlay'); openChangelog();" style="color:var(--primary); text-decoration:none;">Changelog</a></div>
                        </div>

                        <!-- Avatar type tabs -->
                        <div style="display:flex; gap:6px; margin-bottom:12px;">
                            <button id="avtype-letter" onclick="setAvatarType('letter')" style="flex:1; font-size:12px; background:var(--primary); color:white; border:none;">ğŸ”¤ Zeichen</button>
                            <button id="avtype-emoji" onclick="setAvatarType('emoji')" style="flex:1; font-size:12px; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ˜Š Emoji</button>
                            <button id="avtype-image" onclick="setAvatarType('image')" style="flex:1; font-size:12px; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ–¼ï¸ Bild</button>
                        </div>

                        <!-- Letter section -->
                        <div id="avs-letter">
                            <label class="settings-label">Avatar-Farbe:</label>
                            <input type="color" id="my-avatar-color-picker" style="width:100%; height:40px; margin-bottom:12px; cursor:pointer;">
                            <label class="settings-label">Avatar-Schriftart:</label>
                            <select id="my-avatar-font-picker" style="width:100%; padding:10px; border-radius:8px; margin-bottom:12px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color);">
                                <option value="'Playfair Display', serif">Playfair Display (Standard)</option>
                                <option value="'Inter', sans-serif">Inter</option>
                                <option value="'Arial', sans-serif">Arial</option>
                                <option value="'Courier New', monospace">Courier New</option>
                                <option value="'Georgia', serif">Georgia</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                                <option value="'Verdana', sans-serif">Verdana</option>
                                <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                                <option value="'Impact', sans-serif">Impact</option>
                            </select>
                        </div>

                        <!-- Emoji section -->
                        <div id="avs-emoji" style="display:none;">
                            <label class="settings-label">Emoji als Profilbild:</label>
                            <input type="text" id="my-avatar-emoji-input" style="display:none;" readonly>
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                                <div id="avatar-emoji-display" style="font-size:52px; min-width:60px; text-align:center; line-height:1;">ğŸ˜</div>
                                <button onclick="emojiTarget='my-avatar-emoji-input'; openEmojiPicker();" style="flex:1; background:var(--primary); color:white; border:none;">ğŸ˜Š Emoji wÃ¤hlen</button>
                            </div>
                            <label class="settings-label" style="margin-top:4px;">Hintergrundfarbe:</label>
                            <input type="color" id="my-avatar-color-picker-emoji" style="width:100%; height:36px; margin-bottom:12px; cursor:pointer;">
                        </div>

                        <!-- Image section -->
                        <div id="avs-image" style="display:none;">
                            <label class="settings-label">Bild als Profilbild (max. 200 KB):</label>
                            <button onclick="document.getElementById('avatar-img-input').click()" style="width:100%; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color); margin-bottom:8px;">ğŸ“ Bild auswÃ¤hlen</button>
                            <input type="file" id="avatar-img-input" accept="image/*" style="display:none;">
                            <div id="avatar-img-preview" style="display:none; width:80px; height:80px; border-radius:50%; overflow:hidden; margin:0 auto 8px;"><img id="avatar-img-preview-img" style="width:100%; height:100%; object-fit:cover;"></div>
                        </div>

                        <button onclick="saveMyAvatar()" style="width:100%; background:var(--primary); margin-bottom:16px;">Avatar speichern</button>

                        <label class="settings-label">Mein Status:</label>
                        <input type="text" id="status-text-input" placeholder="z.B. VerfÃ¼gbar, BeschÃ¤ftigt..." maxlength="60" style="width:100%; margin-bottom:8px;">
                        <button onclick="saveStatusText()" style="width:100%;">Status speichern</button>

                        <div style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:16px;">
                            <a href="https://sites.google.com/view/villochat/download#h.pxu4uk2i7gl8" target="_blank" rel="noopener noreferrer" style="display:block; text-decoration:none;">
                                <button type="button" style="width:100%; background:var(--primary);">ğŸŒ VilloChat-Website</button>
                            </a>
                            <button onclick="location.reload()" style="width:100%; margin-top:8px; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ”„ App neu laden</button>
                        </div>
                    </div>

                    <!-- SECURITY -->
                    <div id="stab-security" class="settings-panel" style="display:none;">
                        <h3 style="margin-top:0; color:var(--primary);">ğŸ”’ Sicherheit</h3>
                        <p style="font-size:13px; opacity:0.7; margin-bottom:20px;">Verwalte deinen PIN und deine Sitzung.</p>

                        <button onclick="openChangePIN()" style="width:100%; margin-bottom:10px; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ”‘ PIN Ã¤ndern</button>
                        <button onclick="logout()" style="background:#dc3545; width:100%; margin-bottom:0;">ğŸšª Abmelden</button>

                        <!-- QR Login -->
                        <div style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:16px;">
                            <label class="settings-label">ğŸ“± Anmelde-QR-Code</label>
                            <p style="font-size:12px; opacity:0.6; margin:4px 0 10px;">Generiert ein PDF mit deinem QR-Code zum schnellen Einloggen auf einem anderen GerÃ¤t.</p>
                            <button onclick="openQrPinDialog()" style="width:100%; background:var(--primary);">ğŸ“„ QR-Code als PDF generieren</button>
                        </div>
                        <div style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:16px;">
                            <label class="settings-label">ğŸ‘¥ Wer kann mich zu Gruppen hinzufÃ¼gen?</label>
                            <select id="group-add-privacy-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color); margin-bottom:8px;">
                                <option value="all">Alle</option>
                                <option value="contacts">Nur Kontakte</option>
                                <option value="none">Niemand</option>
                            </select>
                            <button onclick="saveGroupAddPrivacy()" style="width:100%; background:var(--primary);">Einstellung speichern</button>
                        </div>

                        <!-- Story visibility -->
                        <div style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:16px;">
                            <label class="settings-label">ğŸ‘ï¸ Wer sieht meine Geschichten?</label>
                            <select id="story-visibility-select" onchange="onStoryVisibilityChange()" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color); margin-bottom:10px;">
                                <option value="all">Alle Kontakte</option>
                                <option value="except">Kontakte auÃŸer...</option>
                                <option value="only">Nur teilen fÃ¼r...</option>
                                <option value="none">Niemand</option>
                            </select>
                            <!-- Contact picker for except/only modes -->
                            <div id="story-visibility-picker" style="display:none;">
                                <div style="font-size:12px; opacity:0.6; margin-bottom:6px;" id="story-visibility-picker-label">Ausgenommene Kontakte:</div>
                                <div id="story-visibility-contact-list" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; min-height:32px; padding:6px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg);"></div>
                                <div style="font-size:11px; opacity:0.5;">Tippe einen Kontaktnamen zum Suchen:</div>
                                <input type="text" id="story-visibility-search" placeholder="Kontakt suchen..." oninput="searchStoryVisibilityContact()" style="width:100%; margin-top:4px; margin-bottom:4px;">
                                <div id="story-visibility-results" style="display:flex; flex-wrap:wrap; gap:4px;"></div>
                            </div>
                            <button onclick="saveStoryVisibility()" style="width:100%; background:var(--primary); margin-top:4px;">Sichtbarkeit speichern</button>
                            <p style="font-size:11px; opacity:0.5; margin-top:6px; line-height:1.5;">Bestehende Geschichten bleiben bis zu 48h sichtbar. Die Einstellung gilt fÃ¼r neue Aufrufe.</p>
                        </div>

                        <div style="margin-top:16px; padding:14px; background:var(--bg); border-radius:10px; border:1px solid var(--border-color);">
                            <div style="font-weight:600; margin-bottom:8px; font-size:14px;">ğŸ” Datenschutz</div>
                            <p style="font-size:13px; opacity:0.7; margin:0; line-height:1.6;">Nachrichten werden in Firebase Realtime Database gespeichert. Dein PIN wird als Klartext gespeichert â€” wÃ¤hle ihn sorgfÃ¤ltig. VilloChat nutzt keine Werbung und gibt keine Daten weiter.</p>
                        </div>
                    </div>

                    <!-- HELP -->
                    <div id="stab-help" class="settings-panel" style="display:none;">
                        <h3 style="margin-top:0; color:var(--primary);">â“ Hilfe & Info</h3>
                        <button onclick="closeOverlay('settings-overlay'); openHelp();" style="width:100%; margin-bottom:10px; background:var(--primary);">ğŸ“– Hilfe-Center Ã¶ffnen</button>
                        <button onclick="closeOverlay('settings-overlay'); openChangelog();" style="width:100%; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ“‹ Changelog</button>
                        <div style="margin-top:20px; padding:14px; background:var(--bg); border-radius:10px; border:1px solid var(--border-color); font-size:13px; line-height:1.7; opacity:0.8;">
                            <strong>VilloChat 5.6</strong><br>
                            Entwickelt als Single-File Web-App.<br>
                            Firebase Realtime Database Â· Web Audio API Â· keine externen Tracker.
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="confirm-overlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>BestÃ¤tigung</h2>
                <span style="cursor:pointer" onclick="closeOverlay('confirm-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <p id="confirm-text">Text...</p>
                <button id="confirm-yes" style="background:#cc0000; color:white; width:48%; margin-right:4%;">Ja</button>
                <button onclick="closeOverlay('confirm-overlay')" style="background:#ccc; color:black; width:48%;">Nein</button>
            </div>
        </div>
    </div>

    <div id="search-overlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Suche</h2>
                <span style="cursor:pointer" onclick="closeOverlay('search-overlay')">âœ•</span>
            </div>
            <div id="search-results" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>
    
    <div id="chat-search-overlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>In Chat suchen</h2>
                <span style="cursor:pointer" onclick="closeOverlay('chat-search-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <input type="text" id="chat-search-input" placeholder="Nachricht suchen..." style="margin-bottom:10px;">
                <div id="chat-search-results" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div id="alias-overlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Alias bearbeiten</h2>
                <span style="cursor:pointer" onclick="closeOverlay('alias-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <p id="alias-text">Alias fÃ¼r Kontakt:</p>
                <input type="text" id="alias-input" style="width:100%; padding:10px; border-radius:10px; margin-top:5px;">
                <button id="alias-save" style="margin-top:10px; width:100%; background:#075e54; color:white;">Speichern</button>
            </div>
        </div>
    </div>
    
    <div id="emoji-overlay" class="overlay">
        <div class="modal" style="max-width:400px; max-height:500px;">
            <div class="modal-header">
                <h2>Zeichen wÃ¤hlen</h2>
                <span style="cursor:pointer" onclick="closeOverlay('emoji-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="padding:10px;">
                <div style="display:flex; gap:8px; margin-bottom:10px; border-bottom:1px solid var(--border-color);">
                    <div id="tab-emoji" onclick="switchEmojiTab('emoji')" style="flex:1; padding:10px; text-align:center; cursor:pointer; border-bottom:2px solid var(--primary); font-weight:600;">ğŸ˜Š Emojis</div>
                    <div id="tab-symbols" onclick="switchEmojiTab('symbols')" style="flex:1; padding:10px; text-align:center; cursor:pointer; border-bottom:2px solid transparent; opacity:0.5;">Â§ Sonderzeichen</div>
                </div>
                <input type="text" id="emoji-search" placeholder="Suchen..." style="width:100%; margin-bottom:10px; padding:8px;">
                <div id="emoji-grid" style="display:grid; grid-template-columns:repeat(8, 1fr); gap:5px; max-height:350px; overflow-y:auto;">
                    <!-- Content will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="msg-context-menu" class="msg-context-menu">
        <!-- Context menu items will be populated here -->
    </div>
    
    <div id="user-info-overlay" class="overlay">
        <div class="modal" style="max-height:85vh;">
            <div class="modal-header">
                <h2>Benutzer-Info</h2>
                <span style="cursor:pointer" onclick="closeOverlay('user-info-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="max-height:calc(85vh - 60px); overflow-y:auto;">
                <div style="text-align:center; margin-bottom:15px;">
                    <div id="info-avatar" style="width:80px; height:80px; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:36px; font-weight:bold; color:white;"></div>
                    <h3 id="info-username" style="margin:0 0 4px 0;"></h3>
                    <p id="info-status-text" style="color:#888; font-size:13px; margin:0 0 4px;"></p>
                    <p id="info-online-status" style="font-size:13px; margin:0;"></p>
                </div>

                <!-- Stats grid -->
                <div id="info-stats-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:12px 0; padding:12px 0; border-top:1px solid var(--border-color); border-bottom:1px solid var(--border-color);">
                    <div style="background:var(--bg); border-radius:10px; padding:10px; text-align:center;">
                        <div id="info-msg-count" style="font-size:20px; font-weight:bold; color:var(--primary);">â€¦</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Nachrichten</div>
                    </div>
                    <div style="background:var(--bg); border-radius:10px; padding:10px; text-align:center;">
                        <div id="info-emoji-stat" style="font-size:22px;">â€¦</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Lieblings-Emoji</div>
                    </div>
                    <div style="background:var(--bg); border-radius:10px; padding:10px; text-align:center;">
                        <div id="info-since" style="font-size:13px; font-weight:bold; color:var(--primary);">â€¦</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Erste Nachricht</div>
                    </div>
                    <div style="background:var(--bg); border-radius:10px; padding:10px; text-align:center;">
                        <div id="info-avg-len" style="font-size:20px; font-weight:bold; color:var(--primary);">â€¦</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Ã˜ Zeichen/Nachricht</div>
                    </div>
                </div>

                <div style="padding-bottom:10px; border-bottom:1px solid var(--border-color); margin-bottom:12px;">
                    <div style="font-size:12px; font-weight:600; opacity:0.5; margin-bottom:8px;">ALIAS & VERWALTUNG</div>
                    <p style="margin:4px 0; font-size:13px;"><strong>Alias:</strong> <span id="info-alias"></span></p>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:12px;">
                    <button id="btn-mute-contact" onclick="toggleMuteContact()" style="flex:1; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ”‡ Stumm</button>
                    <button id="btn-archive-contact" onclick="toggleArchiveContact()" style="flex:1; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ—‚ï¸ Archivieren</button>
                </div>

                <label style="display:block; font-weight:500; margin-bottom:5px;">Chat-Bubble-Farbe:</label>
                <input type="color" id="contact-color-picker" style="width:100%; height:38px; margin:0 0 8px; cursor:pointer;">
                <button onclick="saveContactColor()" style="width:100%;">Farbe speichern</button>

                <div style="border-top:1px solid var(--border-color); padding-top:12px; margin-top:12px;">
                    <label style="display:block; font-weight:500; margin-bottom:5px;">ğŸ“‹ Notiz <span style="font-size:11px; opacity:0.5; font-weight:400;">(nur fÃ¼r dich sichtbar)</span></label>
                    <textarea id="contact-note-input" placeholder="Notizen zu diesem Kontakt..." rows="3" style="width:100%; resize:vertical; min-height:70px; max-height:200px; font-size:13px;"></textarea>
                    <button onclick="saveContactNote()" style="width:100%; margin-top:6px; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">Notiz speichern</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="changelog-overlay" class="overlay">
        <div class="modal" style="max-width:500px; max-height:80vh;">
            <div class="modal-header">
                <h2>ğŸ“ Changelog</h2>
                <span style="cursor:pointer" onclick="closeOverlay('changelog-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                <h3 style="color:var(--primary); margin-top:0;">Version 5.6 ğŸ”</h3>
                <ul>
                    <li>ğŸ” <strong>Teilstring-Suche</strong> â€” Kontaktfelder in Gruppe erstellen, Gruppeninfo und Story-Sichtbarkeit zeigen bereits bei Teileingabe passende Kontakte â€” live beim Tippen. "Kontakt hinzufÃ¼gen" bleibt weiterhin exact-match</li>
                    <li>ğŸ‘¥ <strong>Gruppeneinladungs-Datenschutz</strong> â€” Einstellungen â†’ Sicherheit: Wer kann mich zu Gruppen hinzufÃ¼gen? (Alle / Nur Kontakte / Niemand). Wird bei jedem HinzufÃ¼gen geprÃ¼ft</li>
                </ul>
                <h3 style="color:var(--primary);">Version 5.5 âœ¨</h3>
                <ul>
                    <li>ğŸ“– <strong>Geschichten â€” Multi-Slide</strong> â€” Bis zu 15 Slides pro Geschichte (Text, Emoji, Bild). Schriftart pro Slide wÃ¤hlbar. Slides-Leiste mit Thumbnail-Vorschau im Creator</li>
                    <li>ğŸ–¼ï¸ <strong>Profilbild</strong> â€” Drei Typen: Buchstabe (Farbe + Schrift), Emoji (via Emoji-Dialog) oder Bild (Base64, max. 200 KB). Ãœberall sichtbar: Sidebar, Chat, Gruppen, Geschichten</li>
                    <li>ğŸ“‹ <strong>Story-KontextmenÃ¼</strong> â€” Rechtsklick / Langtipp auf eigene Geschichte: Alle lÃ¶schen, einzelne Slides lÃ¶schen (Thumbnail-Liste), neue Geschichte hinzufÃ¼gen</li>
                    <li>ğŸ‘ï¸ <strong>Story-Sichtbarkeit</strong> â€” Einstellungen â†’ Sicherheit: Alle Kontakte / Kontakte auÃŸer... / Nur teilen fÃ¼r... / Niemand</li>
                    <li>ğŸ“š <strong>Hilfe erweitert</strong> â€” Neue Artikel: â€Geschichten" und â€Profilbild". Feature-Ãœbersicht aktualisiert</li>
                </ul>
                <h3 style="color:var(--primary);">Version 5.4 ğŸ’¡</h3>
                <ul>
                    <li>ğŸ–¼ï¸ <strong>Bildversand</strong> â€” Bilder via ğŸ–¼ï¸-Button hochladen oder direkt aus Zwischenablage einfÃ¼gen (Ctrl+V). Max. 500 KB, wird automatisch komprimiert. Klick auf Bild Ã¶ffnet Lightbox</li>
                    <li>ğŸ’¡ <strong>PIN-Hinweis</strong> â€” Beim Registrieren oder in Einstellungen â†’ PIN Ã¤ndern einen Hinweis hinterlegen. Erscheint automatisch beim Login sobald der Username eingegeben wird</li>
                    <li>ğŸ”‘ <strong>Hint in Einstellungen</strong> â€” Bestehender Hinweis wird bei â€PIN Ã¤ndern" vorausgefÃ¼llt und kann angepasst oder entfernt werden</li>
                </ul>
                <h3 style="color:var(--primary);">Version 5.3 ğŸ›¡ï¸</h3>
                <ul>
                    <li>ğŸ›¡ï¸ <strong>Moderator-Rolle</strong> â€” Admins kÃ¶nnen Mitglieder zum Moderator ernennen (ğŸ›¡ï¸). Mods kÃ¶nnen Mitglieder entfernen, aber keine Admins ernennen oder Gruppeneinstellungen Ã¤ndern</li>
                    <li>ğŸ“¤ <strong>Weiterleiten verbessert</strong> â€” Nachrichten kÃ¶nnen jetzt auch direkt an Gruppen weitergeleitet werden; Kontakte und Gruppen sind klar getrennt aufgelistet</li>
                    <li>ğŸ• <strong>Geplante Nachrichten</strong> â€” Datum & Uhrzeit wÃ¤hlen, Nachricht wird automatisch zum gewÃ¤hlten Zeitpunkt gesendet. Erreichbar Ã¼ber Chat-MenÃ¼ â†’ Geplante Nachrichten</li>
                    <li>ğŸ”Š <strong>Tipp-Sound beim Senden</strong> â€” Kurzer aufsteigender Ton beim Absenden einer Nachricht (an/aus Ã¼ber Sound-Einstellung)</li>
                </ul>
                <h3 style="color:var(--primary);">Version 5.2 ğŸ”—</h3>
                <ul>
                    <li>ğŸ”— <strong>Gruppen-Einladungslink</strong> â€” Link kopieren & teilen; EmpfÃ¤nger treten nach Login automatisch bei</li>
                    <li>ğŸ“ <strong>Gruppen-Beschreibung</strong> â€” Admins kÃ¶nnen eine Kurzbeschreibung setzen, sichtbar fÃ¼r alle Mitglieder</li>
                    <li>ğŸ“Œ <strong>Nachrichten in Gruppen anheften</strong> â€” Gleiches System wie in 1:1-Chats, via Firebase fÃ¼r alle sichtbar</li>
                </ul>
                <h3 style="color:var(--primary);">Version 5.1 ğŸ”</h3>
                <ul>
                    <li>ğŸ” <strong>Nachrichtensuche in Gruppen</strong> â€” Absender farbig hervorgehoben, Suchbegriff markiert</li>
                    <li>âœï¸ <strong>Gruppe umbenennen</strong> â€” Admins kÃ¶nnen Gruppenname direkt in der Gruppeninfo Ã¤ndern</li>
                    <li>ğŸ¨ <strong>Gruppen-Avatar</strong> â€” Emoji aus 20 Optionen wÃ¤hlbar, wird fÃ¼r alle sichtbar gespeichert</li>
                    <li>â„¹ï¸ <strong>Nachrichteninfo</strong> â€” Gesendet-Zeit, Absender, Bearbeitungszeitpunkt; in Gruppen: wer hat wann gelesen</li>
                    <li>ğŸŒ™ <strong>Dark Mode Verbesserungen</strong> â€” Modals, Inputs, Dropdown-MenÃ¼s, KontextmenÃ¼, Reactions, Emoji-Picker, Mark-Highlight</li>
                    <li>ğŸ‘‘ <strong>Ersteller immer Admin</strong> â€” Wird auch bei bestehenden Gruppen automatisch gesetzt</li>
                </ul>
                <h3 style="color:var(--primary);">Version 5.0 ğŸ‘¥</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ‘¥ <strong>Gruppen-Chats</strong> â€” Gruppen erstellen mit beliebig vielen Mitgliedern (ğŸ‘¥-Button in der Sidebar)</li>
                    <li>ğŸ·ï¸ <strong>Absender-Labels</strong> â€” In Gruppen wird der Name des Senders Ã¼ber jeder Nachricht angezeigt</li>
                    <li>âš™ï¸ <strong>Gruppeninfo</strong> â€” Mitglieder anzeigen, hinzufÃ¼gen, entfernen (nur Admin), Gruppe verlassen</li>
                    <li>ğŸ’¬ <strong>System-Nachrichten</strong> â€” Beitreten/Verlassen wird automatisch im Chat angezeigt</li>
                    <li>ğŸ”” <strong>Gruppen-Benachrichtigungen</strong> â€” Neue Nachrichten in Gruppen zeigen Badge und Notification</li>
                    <li>âŒ¨ï¸ <strong>Gruppen-Tippindikator</strong> â€” Zeigt an, wer gerade in der Gruppe schreibt</li>
                </ul>

                <h3 style="color:var(--primary);">Version 4.1 ğŸ“±</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“± <strong>iOS Tastatur-Fix</strong> â€” Input-Bereich bleibt sichtbar wenn Bildschirmtastatur aufgeht (visualViewport API)</li>
                    <li>ğŸ”’ <strong>Safe Area Support</strong> â€” Padding fÃ¼r iPhone Home-Indicator (Notch / Dynamic Island) via env(safe-area-inset-bottom)</li>
                    <li>ğŸ“ <strong>viewport-fit=cover</strong> â€” Korrektes Vollbild-Layout auf iOS ohne weiÃŸen Rand</li>
                </ul>

                <h3 style="color:var(--primary);">Version 4.0.3 ğŸŒ</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸŒ <strong>Download-Link</strong> â€” Einstellungen â†’ "VilloChat - Download" Button Ã¶ffnet villochat.de in neuem Tab</li>
                </ul>

                <h3 style="color:var(--primary);">Version 4.0.2 ğŸ›</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ­ <strong>Emoji-Tabs Fix</strong> â€” Tab-Switch funktioniert jetzt, populateEmojiGrid() Funktion hinzugefÃ¼gt, Emoji-Tab wird beim Ã–ffnen zurÃ¼ckgesetzt</li>
                </ul>

                <h3 style="color:var(--primary);">Version 4.0.1 ğŸ”§</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ› <strong>Reaktionen-Fix</strong> â€” Event Delegation statt inline onclick, escaped Emojis in data-attributes, funktioniert jetzt zuverlÃ¤ssig mit allen Emojis</li>
                    <li>ğŸ—‘ï¸ <strong>Tabs entfernt</strong> â€” Performance-Probleme, zurÃ¼ck zu klassischer Single-Chat-Ansicht (Resizable Sidebar & Focus-Modus bleiben!)</li>
                </ul>

                <h3 style="color:var(--primary);">Version 4.0 ğŸ–¥ï¸</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“ <strong>Resizable Sidebar</strong> â€” Desktop: Drag-Handle am rechten Rand, Breite 250â€“600px, speichert in localStorage</li>
                    <li>âŒ¨ï¸ <strong>Focus-Modus</strong> â€” Ctrl+Shift+F versteckt Sidebar, Vollbild-Chat (nur Desktop)</li>
                    <li>~~ğŸ—‚ï¸ Chat-Tabs~~ â€” Entfernt in 4.0.1</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.11 âš¡</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“Š <strong>Bessere Polls</strong> â€” Bis zu 6 Optionen (statt 4), "SchlieÃŸen"-Button fÃ¼r Creator, geschlossene Umfragen zeigen ğŸ”’ Badge</li>
                    <li>âš¡ <strong>Schnellreaktionen anpassen</strong> â€” Einstellungen â†’ 6 eigene Emojis wÃ¤hlen, werden gespeichert & im KontextmenÃ¼ angezeigt</li>
                    <li>ğŸ­ <strong>Emoji-Picker mit Tabs</strong> â€” Tab 1: Emojis (900+), Tab 2: Sonderzeichen (â†â†’â˜…Â©Â®â„¢â€¦Â§Â¶â€¢Î±Î²Ï€Î© etc.)</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.10.3 ğŸ”¤</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ”¤ <strong>Font-Consistency</strong> â€” Buttons verwenden jetzt auch Inter-Schrift wie Inputs & Textareas</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.10.2 âœ¨</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸŒ™ <strong>Dark Mode verbessert</strong> â€” Bessere Kontraste (#25d366 Primary, dunklere HintergrÃ¼nde), schÃ¤rfere Borders</li>
                    <li>ğŸ¯ <strong>Hover-Highlight</strong> â€” Nachrichten werden bei Mouse-Over subtil hervorgehoben</li>
                    <li>â³ <strong>Loading States</strong> â€” Animierte Spinner in globaler Suche & Forward-Dialog</li>
                    <li>ğŸ¬ <strong>Smooth Animations</strong> â€” Overlays fade in (0.2s), Modals slide up (0.25s), Buttons skalieren bei Hover/Click</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.10.1 ğŸ“š</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“š <strong>Hilfe-System erweitert</strong> â€” Alle 7 Artikel komplett Ã¼berarbeitet: PWA-Installation, Polls, Notizen, Swipe, Kontakt-Stats, alle Features dokumentiert</li>
                    <li>âœ¨ <strong>Neuer Artikel</strong> â€” "Alle Features im Ãœberblick" als schnelle Referenz</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.10 ğŸ“²</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“² <strong>PWA / Installierbar</strong> â€” Service Worker, Manifest, Install-Button erscheint in Einstellungen</li>
                    <li>âŒ¨ï¸ <strong>Neue Shortcuts</strong> â€” Ctrl+D (Nachricht lÃ¶schen), Ctrl+R (Antworten), Ctrl+P (Anpinnen), Ctrl+B (User-Info)</li>
                    <li>âš¡ <strong>Escape verbessert</strong> â€” SchlieÃŸt jetzt auch Bearbeiten-Modus, Antworten-Bar, KontextmenÃ¼</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.9 ğŸ“Š</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“Š <strong>Abstimmungen / Polls</strong> â€” ğŸ“Š-Button in Eingabezeile, bis zu 4 Optionen, Live-Ergebnisse mit Balken & Prozentzahlen, Stimme Ã¤nderbar</li>
                    <li>ğŸ“‹ <strong>Kontakt-Notizen</strong> â€” Privat & lokal in User-Info, nur fÃ¼r dich sichtbar</li>
                    <li>ğŸ“± <strong>Swipe zurÃ¼ck</strong> â€” Auf Mobile: Chat nach rechts wischen schlieÃŸt ihn</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.8.2 ğŸ›</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“ <strong>KontextmenÃ¼-Position</strong> â€” bleibt jetzt immer im sichtbaren Bereich, auch an BildschirmrÃ¤ndern</li>
                    <li>âœï¸ <strong>Bearbeiten-Fix</strong> â€” Nachrichtentext wurde korrekt gespeichert</li>
                    <li>ğŸ—‘ï¸ <strong>FÃ¼r alle lÃ¶schen-Fix</strong> â€” KontextmenÃ¼ nach dem LÃ¶schen korrekt deaktiviert</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.8.1 ğŸ”‘</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ”‘ <strong>PIN Ã¤ndern</strong> â€” Einstellungen â†’ PIN Ã¤ndern, mit Verifikation des alten PINs</li>
                    <li>â“ <strong>Hilfesystem</strong> â€” 7 Artikel: Erste Schritte, Nachrichten, Kontakte, Design, Suche, Sicherheit, Profil</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.8 ğŸ‘¤</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“Œ <strong>Nachrichten anpinnen</strong> - Pro Chat, sichtbar oben im Chat, fÃ¼r beide Nutzer via Firebase</li>
                    <li>ğŸ—‘ï¸ <strong>FÃ¼r alle lÃ¶schen</strong> - KontextmenÃ¼, zeigt "Nachricht gelÃ¶scht" bei beiden</li>
                    <li>ğŸ‘¤ <strong>Eigene Profilseite</strong> - Klick auf Namen in Sidebar: Avatar, Status, Statistiken, Top-Kontakte</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.7 ğŸ“¤</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“¤ <strong>Weiterleiten</strong> - KontextmenÃ¼ â†’ Kontakte auswÃ¤hlen â†’ senden</li>
                    <li>ğŸ–¼ï¸ <strong>Bild-URLs</strong> - .jpg/.png/.gif/.webp werden automatisch als Bild angezeigt</li>
                    <li>ğŸ¬ <strong>Embed-Vorschau</strong> - YouTube, Vimeo, Twitter/X werden eingebettet</li>
                    <li>ğŸ” <strong>Lightbox</strong> - Klick auf Bild Ã¶ffnet Vollbild-Ansicht</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.6 ğŸ”</h3>
                <ul style="line-height:1.8;">
                    <li>âœï¸ <strong>Bearbeiten (Fix)</strong> - Nachrichten korrekt bearbeitbar</li>
                    <li>ğŸ—‚ï¸ <strong>Chats archivieren</strong> - Aus Hauptliste ausblenden</li>
                    <li>ğŸ”‡ <strong>Stummschalten</strong> - Keine Notifications fÃ¼r einzelne Chats</li>
                    <li>ğŸ“ <strong>Status-Text</strong> - z.B. "VerfÃ¼gbar", "BeschÃ¤ftigt"</li>
                    <li>ğŸ’¬ <strong>Bubble-Stil</strong> - Rund / Eckig / Minimal</li>
                    <li>ğŸ“ <strong>Scroll-Badge</strong> - Zeigt Anzahl ungelesener Nachrichten</li>
                    <li>â±ï¸ <strong>Hover-Datum</strong> - VollstÃ¤ndiges Datum beim Hovern</li>
                    <li>ğŸ” <strong>Globale Suche</strong> - Ãœber alle Chats suchen</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.5 âœï¸</h3>
                <ul style="line-height:1.8;">
                    <li>âœï¸ <strong>Nachrichten bearbeiten</strong> - KontextmenÃ¼ â†’ Bearbeiten, zeigt "(bearbeitet)"</li>
                    <li>ğŸ¨ <strong>Eigene Bubble-Farbe</strong> - Color-Picker fÃ¼r gesendete Nachrichten</li>
                    <li>ğŸ”¤ <strong>SchriftgrÃ¶ÃŸe</strong> - Klein / Normal / GroÃŸ / XL</li>
                    <li>ğŸ”Š <strong>Sound-Einstellungen</strong> - Benachrichtigungston bei neuen Nachrichten</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.4 ğŸ¨</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ“ <strong>Scroll to Bottom Button</strong> - Erscheint beim Nach-Oben-Scrollen</li>
                    <li>ğŸ¨ <strong>13 Akzentfarben</strong> - Rot, Orange, Gold, Gelb, Limette, GrÃ¼n, Himmelblau, Indigo, Blau, Violett, Pink, Pfirsich, Schwarz</li>
                    <li>ğŸ”“ <strong>Encryption Notice</strong> - Wird nach 4 Sekunden automatisch ausgeblendet</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.3 ğŸ˜Š</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ–±ï¸ <strong>KontextmenÃ¼</strong> - Rechtsklick/Langer Touch auf Nachrichten</li>
                    <li>ğŸ˜Š <strong>Reaktionen</strong> - 6 Quick-Reactions (â¤ï¸ğŸ‘ğŸ˜‚ğŸ˜®ğŸ˜¢ğŸ™)</li>
                    <li>â„¹ï¸ <strong>Benutzer-Info</strong> - Klick auf Chat-Header</li>
                    <li>ğŸ¨ <strong>Avatar anpassen</strong> - Farbe & Schriftart in Settings</li>
                    <li>ğŸ’¬ <strong>Custom Bubble-Farbe</strong> - Pro Kontakt einstellbar</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.2.3 ğŸ‰</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸŒ“ <strong>Theme-System</strong> - System / Hell / Dunkel</li>
                    <li>ğŸ’¬ <strong>Empty States</strong> - "Kein Chat" & "Keine Kontakte"</li>
                    <li>ğŸ”” <strong>Toast-Notifications</strong> - Alle Alerts ersetzt</li>
                    <li>âŒ¨ï¸ <strong>Keyboard Shortcuts</strong> - Ctrl+K/F/E/,, Escape</li>
                    <li>ğŸ” <strong>Passwortmanager</strong> - PIN speicherbar</li>
                </ul>

                <h3 style="color:var(--primary);">Version 3.0 ğŸš€</h3>
                <ul style="line-height:1.8;">
                    <li>â‹® <strong>Dreipunkt-MenÃ¼</strong> - Export, Suche, Leeren</li>
                    <li>ğŸ“Œ <strong>Kontakte pinnen</strong></li>
                    <li>ğŸ”´ <strong>Unread Badge</strong> - Roter Punkt</li>
                    <li>âœ“âœ“ <strong>LesebestÃ¤tigungen</strong></li>
                    <li>ğŸ“… <strong>Datums-Gruppierung</strong></li>
                    <li>ğŸ“¥ <strong>Chat-Export</strong></li>
                    <li>â†©ï¸ <strong>Antwort-Funktion</strong></li>
                </ul>

                <h3 style="color:var(--primary);">Basis-Features</h3>
                <ul style="line-height:1.8;">
                    <li>ğŸ’¬ <strong>Echtzeit-Chat</strong> mit Firebase</li>
                    <li>ğŸ˜Š <strong>900+ Emojis</strong> mit Picker</li>
                    <li>ğŸ‘¥ <strong>Kontaktverwaltung</strong> mit Suche & Alias</li>
                    <li>ğŸŸ¢ <strong>Online-Status</strong></li>
                    <li>âœï¸ <strong>Markdown-Support</strong></li>
                    <li>ğŸ”— <strong>Link-Erkennung</strong></li>
                    <li>ğŸ¨ <strong>Chat-Farben anpassbar</strong></li>
                </ul>
            </div>
        </div>
    </div>

    <div id="global-search-overlay" class="overlay">
        <div class="modal" style="max-width:500px; max-height:80vh;">
            <div class="modal-header">
                <h2>ğŸ” Globale Suche</h2>
                <span style="cursor:pointer" onclick="closeOverlay('global-search-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="padding:10px;">
                <input type="text" id="global-search-input" placeholder="In allen Chats suchen..." style="width:100%; padding:10px; margin-bottom:10px;">
                <div id="global-search-results" style="max-height:50vh; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
    
    <div id="my-profile-overlay" class="overlay">
        <div class="modal" style="max-height:80vh;">
            <div class="modal-header">
                <h2>ğŸ‘¤ Mein Profil</h2>
                <span style="cursor:pointer" onclick="closeOverlay('my-profile-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="max-height:calc(80vh - 60px); overflow-y:auto;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div id="my-profile-avatar" style="width:90px; height:90px; border-radius:50%; margin:0 auto 12px; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:bold; color:white; cursor:pointer;" onclick="openSettings()" title="In Einstellungen Ã¤ndern"></div>
                    <h3 id="my-profile-name" style="margin:0 0 4px 0;"></h3>
                    <p id="my-profile-status" style="color:#999; font-size:14px; margin:0 0 8px;"></p>
                    <span style="font-size:12px; color:var(--primary); cursor:pointer;" onclick="closeOverlay('my-profile-overlay'); openSettings();">âœï¸ Bearbeiten</span>
                </div>

                <div style="border-top:1px solid var(--border-color); padding-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:12px; text-align:center; margin-bottom:15px;">
                    <div style="background:var(--bg); border-radius:10px; padding:12px;">
                        <div id="my-profile-msg-count" style="font-size:24px; font-weight:bold; color:var(--primary);">â€”</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Nachrichten gesendet</div>
                    </div>
                    <div style="background:var(--bg); border-radius:10px; padding:12px;">
                        <div id="my-profile-contact-count" style="font-size:24px; font-weight:bold; color:var(--primary);">â€”</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Kontakte</div>
                    </div>
                    <div style="background:var(--bg); border-radius:10px; padding:12px;">
                        <div id="my-profile-emoji-stat" style="font-size:24px;">â€”</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Lieblings-Emoji</div>
                    </div>
                    <div style="background:var(--bg); border-radius:10px; padding:12px;">
                        <div id="my-profile-since" style="font-size:14px; font-weight:bold; color:var(--primary);">â€”</div>
                        <div style="font-size:11px; opacity:0.6; margin-top:2px;">Dabei seit</div>
                    </div>
                </div>

                <div style="border-top:1px solid var(--border-color); padding-top:12px;">
                    <div style="font-size:12px; font-weight:600; margin-bottom:8px; opacity:0.6;">HÃ„UFIGSTE KONTAKTE</div>
                    <div id="my-profile-top-contacts"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="forward-overlay" class="overlay">
        <div class="modal" style="max-height:80vh;">
            <div class="modal-header">
                <h2>ğŸ“¤ Weiterleiten an...</h2>
                <span style="cursor:pointer" onclick="closeOverlay('forward-overlay')">âœ•</span>
            </div>
            <div style="padding:10px 15px; border-bottom:1px solid var(--border-color); background:var(--bg);">
                <div id="forward-preview" style="font-size:13px; opacity:0.7; padding:8px; background:var(--white); border-radius:8px; border-left:3px solid var(--primary); max-height:60px; overflow:hidden;"></div>
            </div>
            <div id="forward-contacts-list" style="max-height:50vh; overflow-y:auto;"></div>
            <div style="padding:12px 15px; border-top:1px solid var(--border-color);">
                <button id="forward-send-btn" onclick="sendForward()" style="width:100%; background:var(--primary);" disabled>Weiterleiten (0 ausgewÃ¤hlt)</button>
            </div>
        </div>
    </div>
    
    <div id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="">
    </div>

    <div id="poll-overlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ“Š Abstimmung erstellen</h2>
                <span style="cursor:pointer" onclick="closeOverlay('poll-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <label style="display:block; font-weight:500; margin-bottom:6px;">Frage:</label>
                <input type="text" id="poll-question" placeholder="Was mÃ¶chtest du fragen?" maxlength="120" style="width:100%; margin-bottom:14px;">
                <label style="display:block; font-weight:500; margin-bottom:6px;">Optionen:</label>
                <div id="poll-options-list">
                    <input type="text" class="poll-option-input" placeholder="Option 1" maxlength="60" style="width:100%; margin-bottom:8px;">
                    <input type="text" class="poll-option-input" placeholder="Option 2" maxlength="60" style="width:100%; margin-bottom:8px;">
                </div>
                <button onclick="addPollOption()" style="width:100%; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color); margin-bottom:14px;">+ Option hinzufÃ¼gen</button>
                <button onclick="sendPoll()" style="width:100%; background:var(--primary);">ğŸ“Š Abstimmung senden</button>
            </div>
        </div>
    </div>

    <!-- QR PIN DIALOG -->
    <div id="qr-pin-overlay" class="overlay">
        <div class="modal" style="max-width:360px; width:95vw;">
            <div class="modal-header">
                <h2>ğŸ“„ QR-Code generieren</h2>
                <span style="cursor:pointer;" onclick="closeOverlay('qr-pin-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; opacity:0.7; margin-bottom:14px;">Gib deinen PIN ein um das PDF zu generieren. Das PDF enthÃ¤lt deinen Benutzernamen, PIN und einen QR-Code zum direkten Einloggen.</p>
                <label style="font-size:12px; opacity:0.6; display:block; margin-bottom:4px;">PIN (Format: xxxx-xxxx)</label>
                <input type="password" id="qr-pin-input" placeholder="xxxx-xxxx" maxlength="9" style="width:100%; margin-bottom:4px;" oninput="this.value=this.value.replace(/[^0-9-]/g,'')">
                <p id="qr-pin-error" style="color:#dc3545; font-size:12px; min-height:18px; margin:4px 0 10px;"></p>
                <button onclick="generateLoginQR()" style="width:100%; background:var(--primary);">ğŸ“„ PDF generieren & herunterladen</button>
            </div>
        </div>
    </div>

    <div id="change-pin-overlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ”‘ PIN Ã¤ndern</h2>
                <span style="cursor:pointer" onclick="closeOverlay('change-pin-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; opacity:0.7; margin-top:0;">Ã„ndere deinen Login-PIN. Das Format ist <strong>xxxx-xxxx</strong> (8 Ziffern).</p>
                <label style="display:block; margin-bottom:5px; font-weight:500;">Aktueller PIN:</label>
                <input type="password" id="pin-current" placeholder="xxxx-xxxx" maxlength="9" style="width:100%; margin-bottom:12px;">
                <label style="display:block; margin-bottom:5px; font-weight:500;">Neuer PIN:</label>
                <input type="password" id="pin-new" placeholder="xxxx-xxxx" maxlength="9" style="width:100%; margin-bottom:12px;">
                <label style="display:block; margin-bottom:5px; font-weight:500;">Neuen PIN wiederholen:</label>
                <input type="password" id="pin-confirm" placeholder="xxxx-xxxx" maxlength="9" style="width:100%; margin-bottom:12px;">
                <label style="display:block; margin-bottom:5px; font-weight:500;">PIN-Hinweis <span style="font-weight:400; opacity:0.5;">(optional, sichtbar beim Login)</span></label>
                <input type="text" id="pin-hint-settings" placeholder="z.B. Lieblingsfilm + Geburtsjahr" maxlength="80" style="width:100%; margin-bottom:16px;">
                <button onclick="savePINChange()" style="width:100%; background:var(--primary);">PIN Ã¤ndern</button>
            </div>
        </div>
    </div>

    <div id="help-overlay" class="overlay">
        <div class="modal" style="max-height:85vh;">
            <div class="modal-header">
                <h2>â“ Hilfe</h2>
                <span style="cursor:pointer" onclick="closeOverlay('help-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="max-height:calc(85vh - 60px); overflow-y:auto; padding:0;">

                <!-- Article navigation -->
                <div id="help-nav" style="padding:10px 15px; border-bottom:1px solid var(--border-color);">
                    <input type="text" id="help-search" placeholder="Hilfeartikel suchen..." style="width:100%; margin:0 0 10px 0;" oninput="filterHelp(this.value)">
                    <div id="help-articles-list"></div>
                </div>

                <!-- Article content -->
                <div id="help-article-view" style="display:none; padding:15px;">
                    <div style="cursor:pointer; color:var(--primary); font-size:13px; margin-bottom:15px;" onclick="showHelpNav()">â† Alle Artikel</div>
                    <h3 id="help-article-title" style="margin-top:0;"></h3>
                    <div id="help-article-body" style="font-size:14px; line-height:1.7;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-area">
        <div class="auth-box">
            <h2 style="color:var(--primary); text-align:center;">VilloChat</h2>
            <p style="text-align:center; font-size:12px; color:#999; margin:-10px 0 15px 0;">Version 5.6</p>
            <div style="display:flex; margin-bottom:15px; border-bottom:1px solid #eee;">
                <div id="t-login" style="flex:1; text-align:center; cursor:pointer; padding:10px; border-bottom:2px solid var(--primary);">Login</div>
                <div id="t-reg" style="flex:1; text-align:center; cursor:pointer; padding:10px; color:#999;">Neu</div>
            </div>
            <form id="auth-form" onsubmit="event.preventDefault(); document.getElementById('btn-auth').click();">
                <input type="text" id="v-username" placeholder="Name" autocomplete="username" name="username">
                <input type="password" id="v-pin" placeholder="PIN (xxxx-xxxx)" maxlength="9" autocomplete="current-password" name="password">
                <input type="text" id="v-pin-hint" placeholder="PIN-Hinweis (optional, sichtbar beim Login)" maxlength="80" autocomplete="off" style="display:none; font-size:13px;">
                <div id="pin-hint-display" style="display:none; font-size:12px; color:#888; background:var(--bg); border-radius:8px; padding:8px 12px; margin:4px 0; border-left:3px solid var(--primary);">
                    ğŸ’¡ <span id="pin-hint-text"></span>
                </div>
                <button id="btn-auth" type="submit" style="width:100%;">Starten</button>
            </form>
            <button onclick="if(window.openHelp) window.openHelp(); else document.getElementById('help-overlay').style.display='flex';" style="width:100%; margin-top:10px; background:transparent; color:#999; border:1px solid #ddd; font-size:13px;">â“ Brauchst du Hilfe?</button>
        </div>
    </div>

    <!-- STORY CONTEXT MENU -->
    <div id="story-ctx-overlay" class="overlay" style="background:rgba(0,0,0,0.5);" onclick="closeOverlay('story-ctx-overlay')">
        <div class="modal" style="max-width:360px; width:95vw; max-height:80vh; overflow-y:auto; padding:0;" onclick="event.stopPropagation()">
            <div class="modal-header" style="padding:14px 18px;">
                <h2>ğŸ“– Meine Geschichten</h2>
                <span onclick="closeOverlay('story-ctx-overlay')" style="cursor:pointer;">âœ•</span>
            </div>
            <div style="padding:12px 16px;">
                <button onclick="closeOverlay('story-ctx-overlay'); openStoryCreate();" style="width:100%; background:var(--primary); margin-bottom:8px;">â• Zur Geschichte hinzufÃ¼gen</button>
                <button onclick="deleteAllMyStories()" style="width:100%; background:#dc3545; margin-bottom:12px;">ğŸ—‘ï¸ Alle Geschichten lÃ¶schen</button>
                <div style="font-size:12px; opacity:0.5; text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px;">Einzelne Slides</div>
                <div id="story-ctx-slides-list"></div>
            </div>
        </div>
    </div>

    <!-- STORY CREATE OVERLAY -->
    <div id="story-create-overlay" class="overlay">
        <div class="modal" style="max-width:420px; width:95vw; max-height:92vh; flex-direction:column; padding:0; overflow:hidden;">
            <div class="modal-header" style="flex-shrink:0; padding:14px 18px;">
                <h2>ğŸ“– Geschichte erstellen</h2>
                <span style="cursor:pointer;" onclick="closeOverlay('story-create-overlay')">âœ•</span>
            </div>
            <div style="flex:1; overflow-y:auto; padding:16px;">

                <!-- Preview -->
                <div id="story-preview" style="width:100%; height:170px; border-radius:14px; display:flex; align-items:center; justify-content:center; margin-bottom:12px; background:#075e54; position:relative; overflow:hidden; transition:background 0.2s;">
                    <img id="story-preview-img" style="display:none; width:100%; height:100%; object-fit:cover; position:absolute; inset:0;" />
                    <div id="story-preview-text" style="color:white; font-size:22px; font-weight:700; text-align:center; padding:12px; z-index:1; word-break:break-word; text-shadow:0 1px 4px rgba(0,0,0,0.4);"></div>
                </div>

                <!-- Slides strip -->
                <div style="display:flex; align-items:center; gap:6px; margin-bottom:12px; overflow-x:auto; padding-bottom:4px;">
                    <div id="story-slides-strip" style="display:flex; gap:6px; flex-shrink:0;"></div>
                    <div id="story-add-slide-btn" onclick="addStorySlide()" style="width:44px; height:60px; border-radius:8px; border:2px dashed var(--border-color); display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; flex-shrink:0; color:var(--primary);">+</div>
                </div>

                <!-- Type selector -->
                <div style="display:flex; gap:6px; margin-bottom:10px;">
                    <button id="story-type-text" onclick="setStoryType('text')" style="flex:1; background:var(--primary); color:white; border:none; font-size:13px;">âœï¸ Text</button>
                    <button id="story-type-emoji" onclick="setStoryType('emoji')" style="flex:1; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color); font-size:13px;">ğŸ˜Š Emoji</button>
                    <button id="story-type-image" onclick="setStoryType('image')" style="flex:1; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color); font-size:13px;">ğŸ–¼ï¸ Bild</button>
                </div>

                <!-- Text input -->
                <div id="story-text-section">
                    <textarea id="story-text-input" placeholder="Was mÃ¶chtest du teilen?" maxlength="120" rows="2" oninput="updateStoryPreview()" style="width:100%; resize:none; margin-bottom:6px;"></textarea>
                    <div style="margin-bottom:8px;">
                        <label style="font-size:11px; opacity:0.6; display:block; margin-bottom:4px;">SCHRIFTART</label>
                        <select id="story-font-picker" oninput="updateStoryPreview()" style="width:100%; padding:7px 10px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color); margin-bottom:6px;">
                            <option value="'Playfair Display', serif">Playfair Display</option>
                            <option value="'Inter', sans-serif">Inter</option>
                            <option value="'Georgia', serif">Georgia</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                            <option value="'Impact', sans-serif">Impact</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                        </select>
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="font-size:11px; opacity:0.6; display:block; margin-bottom:4px;">HINTERGRUNDFARBE</label>
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <div onclick="setStoryBg('#075e54')" data-story-color="#075e54" style="width:26px;height:26px;border-radius:50%;background:#075e54;cursor:pointer;border:2px solid white;"></div>
                            <div onclick="setStoryBg('#1a73e8')" data-story-color="#1a73e8" style="width:26px;height:26px;border-radius:50%;background:#1a73e8;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#e91e63')" data-story-color="#e91e63" style="width:26px;height:26px;border-radius:50%;background:#e91e63;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#ff6d00')" data-story-color="#ff6d00" style="width:26px;height:26px;border-radius:50%;background:#ff6d00;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#7b1fa2')" data-story-color="#7b1fa2" style="width:26px;height:26px;border-radius:50%;background:#7b1fa2;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#2e7d32')" data-story-color="#2e7d32" style="width:26px;height:26px;border-radius:50%;background:#2e7d32;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#c62828')" data-story-color="#c62828" style="width:26px;height:26px;border-radius:50%;background:#c62828;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#37474f')" data-story-color="#37474f" style="width:26px;height:26px;border-radius:50%;background:#37474f;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#f57f17')" data-story-color="#f57f17" style="width:26px;height:26px;border-radius:50%;background:#f57f17;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#000000')" data-story-color="#000000" style="width:26px;height:26px;border-radius:50%;background:#000000;cursor:pointer;border:2px solid transparent;"></div>
                        </div>
                    </div>
                </div>

                <!-- Emoji input -->
                <div id="story-emoji-section" style="display:none;">
                    <input type="text" id="story-emoji-input" style="display:none;" readonly>
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <div id="story-emoji-display" style="font-size:52px; min-width:60px; text-align:center; line-height:1;">ğŸ˜Š</div>
                        <button onclick="emojiTarget='story-emoji-input'; openEmojiPicker();" style="flex:1; background:var(--primary); color:white; border:none;">ğŸ˜Š Emoji wÃ¤hlen</button>
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="font-size:11px; opacity:0.6; display:block; margin-bottom:4px;">HINTERGRUNDFARBE</label>
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <div onclick="setStoryBg('#075e54')" data-story-color="#075e54" style="width:26px;height:26px;border-radius:50%;background:#075e54;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#1a73e8')" data-story-color="#1a73e8" style="width:26px;height:26px;border-radius:50%;background:#1a73e8;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#e91e63')" data-story-color="#e91e63" style="width:26px;height:26px;border-radius:50%;background:#e91e63;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#ff6d00')" data-story-color="#ff6d00" style="width:26px;height:26px;border-radius:50%;background:#ff6d00;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#7b1fa2')" data-story-color="#7b1fa2" style="width:26px;height:26px;border-radius:50%;background:#7b1fa2;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#2e7d32')" data-story-color="#2e7d32" style="width:26px;height:26px;border-radius:50%;background:#2e7d32;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#c62828')" data-story-color="#c62828" style="width:26px;height:26px;border-radius:50%;background:#c62828;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#37474f')" data-story-color="#37474f" style="width:26px;height:26px;border-radius:50%;background:#37474f;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#f57f17')" data-story-color="#f57f17" style="width:26px;height:26px;border-radius:50%;background:#f57f17;cursor:pointer;border:2px solid transparent;"></div>
                            <div onclick="setStoryBg('#000000')" data-story-color="#000000" style="width:26px;height:26px;border-radius:50%;background:#000000;cursor:pointer;border:2px solid transparent;"></div>
                        </div>
                    </div>
                </div>

                <!-- Image input -->
                <div id="story-image-section" style="display:none;">
                    <button onclick="document.getElementById('story-img-input').click()" style="width:100%; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color); margin-bottom:8px;">ğŸ“ Bild auswÃ¤hlen (max. 500 KB)</button>
                    <input type="file" id="story-img-input" accept="image/*" style="display:none;">
                </div>

                <!-- Actions -->
                <div style="display:flex; gap:8px; margin-top:4px;">
                    <button onclick="saveCurrentSlide()" style="flex:1; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">ğŸ’¾ Slide speichern</button>
                    <button onclick="publishStory()" style="flex:1; background:var(--primary);">ğŸ“– VerÃ¶ffentlichen</button>
                </div>
                <div id="story-slide-counter" style="text-align:center; font-size:12px; opacity:0.5; margin-top:6px;">0 / 15 Slides</div>
            </div>
        </div>
    </div>
    <!-- STORY VIEWER OVERLAY -->
    <div id="story-viewer-overlay" class="overlay" style="background:rgba(0,0,0,0.92);" onclick="closeStoryViewer()">
        <div style="position:relative; width:100%; max-width:420px; display:flex; flex-direction:column; align-items:center;" onclick="event.stopPropagation()">
            <!-- Multi-slide progress bars -->
            <div id="story-progress-bars" style="display:flex; gap:3px; width:100%; padding:0 12px; box-sizing:border-box; margin-bottom:8px;"></div>
            <!-- Header -->
            <div style="display:flex; align-items:center; gap:10px; width:100%; padding:0 12px 10px; box-sizing:border-box;">
                <div id="viewer-avatar" style="width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold; color:white;"></div>
                <div>
                    <div id="viewer-username" style="color:white; font-weight:600; font-size:14px;"></div>
                    <div id="viewer-time" style="color:rgba(255,255,255,0.6); font-size:11px;"></div>
                </div>
                <span id="viewer-add-btn" style="display:none; color:white; font-size:22px; cursor:pointer; margin-left:auto;" title="Neue Geschichte" onclick="closeStoryViewer(); openStoryCreate();">â•</span>
                <span onclick="closeStoryViewer()" style="color:white; font-size:24px; cursor:pointer; opacity:0.7; margin-left:auto;" id="viewer-close-x">âœ•</span>
                <span id="viewer-delete-btn" style="display:none; color:#ff6b6b; font-size:20px; cursor:pointer; margin-left:4px;" onclick="deleteMyStory()">ğŸ—‘ï¸</span>
            </div>
            <!-- Story content -->
            <div id="story-viewer-content" style="width:100%; height:460px; border-radius:16px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;">
                <img id="viewer-img" style="display:none; width:100%; height:100%; object-fit:cover;">
                <div id="viewer-text" style="color:white; font-size:28px; font-weight:700; text-align:center; padding:20px; word-break:break-word; text-shadow:0 2px 8px rgba(0,0,0,0.5);"></div>
            </div>
            <!-- Reactions -->
            <div id="story-reactions-bar" style="display:flex; gap:6px; margin-top:10px; align-items:center; flex-wrap:wrap; justify-content:center;">
                <span style="color:rgba(255,255,255,0.5); font-size:12px; width:100%; text-align:center; margin-bottom:2px;">Reagieren:</span>
                <span onclick="reactToStory('â¤ï¸')" style="font-size:26px; cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">â¤ï¸</span>
                <span onclick="reactToStory('ğŸ˜‚')" style="font-size:26px; cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">ğŸ˜‚</span>
                <span onclick="reactToStory('ğŸ˜®')" style="font-size:26px; cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">ğŸ˜®</span>
                <span onclick="reactToStory('ğŸ”¥')" style="font-size:26px; cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">ğŸ”¥</span>
                <span onclick="reactToStory('ğŸ‘')" style="font-size:26px; cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">ğŸ‘</span>
                <span onclick="reactToStory('ğŸ˜¢')" style="font-size:26px; cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">ğŸ˜¢</span>
                <div id="story-reactions-display" style="width:100%; text-align:center; font-size:13px; color:rgba(255,255,255,0.7); margin-top:4px; min-height:20px;"></div>
            </div>
            <!-- Nav buttons -->
            <div style="display:flex; gap:12px; margin-top:10px;">
                <button onclick="navigateStory(-1)" style="background:rgba(255,255,255,0.15); color:white; border:none; padding:10px 24px; border-radius:20px;">â€¹ ZurÃ¼ck</button>
                <button onclick="navigateStory(1)" style="background:rgba(255,255,255,0.15); color:white; border:none; padding:10px 24px; border-radius:20px;">Weiter â€º</button>
            </div>
        </div>
    </div>

    <!-- SCHEDULED MESSAGES OVERLAY -->
    <div id="scheduled-overlay" class="overlay">
        <div class="modal" style="max-width:420px; max-height:80vh;">
            <div class="modal-header">
                <h2>ğŸ• Geplante Nachrichten</h2>
                <span style="cursor:pointer" onclick="closeOverlay('scheduled-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:12px;">
                    <textarea id="scheduled-text" placeholder="Nachricht eingeben..." rows="3" style="width:100%; resize:none;"></textarea>
                    <input type="datetime-local" id="scheduled-time" style="width:100%; margin-top:8px;">
                    <button onclick="saveScheduledMsg()" style="width:100%; margin-top:8px; background:var(--primary);">â° Planen</button>
                </div>
                <div id="scheduled-list" style="max-height:40vh; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- MESSAGE INFO OVERLAY -->
    <div id="msg-info-overlay" class="overlay">
        <div class="modal" style="max-width:420px; max-height:80vh;">
            <div class="modal-header">
                <h2>â„¹ï¸ Nachrichteninfo</h2>
                <span style="cursor:pointer" onclick="closeOverlay('msg-info-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                <div id="msg-info-content"></div>
            </div>
        </div>
    </div>

    <!-- GROUP CREATE OVERLAY -->
    <div id="group-create-overlay" class="overlay">
        <div class="modal" style="max-width:420px;">
            <div class="modal-header">
                <h2>ğŸ‘¥ Gruppe erstellen</h2>
                <span style="cursor:pointer" onclick="closeOverlay('group-create-overlay')">âœ•</span>
            </div>
            <div class="modal-body">
                <label style="display:block; font-weight:500; margin-bottom:5px;">Gruppenname:</label>
                <input type="text" id="group-name-input" placeholder="z.B. Freunde, Arbeit..." maxlength="40" style="width:100%; margin-bottom:14px;">
                <label style="display:block; font-weight:500; margin-bottom:5px;">Mitglieder hinzufÃ¼gen:</label>
                <div style="display:flex; gap:6px; margin-bottom:10px;">
                    <input type="text" id="group-member-search" placeholder="Username suchen..." style="flex:1; margin:0;">
                    <button id="btn-group-member-search" style="width:50px; margin:0;">ğŸ”</button>
                </div>
                <div id="group-member-results" style="max-height:140px; overflow-y:auto; margin-bottom:10px;"></div>
                <div style="font-weight:500; margin-bottom:5px; font-size:13px;">AusgewÃ¤hlte Mitglieder:</div>
                <div id="group-selected-members" style="display:flex; flex-wrap:wrap; gap:6px; min-height:32px; margin-bottom:16px;"></div>
                <button id="btn-group-create-confirm" style="width:100%;">âœ… Gruppe erstellen</button>
            </div>
        </div>
    </div>

    <!-- GROUP INFO OVERLAY -->
    <div id="group-info-overlay" class="overlay">
        <div class="modal" style="max-width:420px; max-height:80vh;">
            <div class="modal-header">
                <h2>ğŸ‘¥ Gruppeninfo</h2>
                <span style="cursor:pointer" onclick="closeOverlay('group-info-overlay')">âœ•</span>
            </div>
            <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                <div id="group-info-content"></div>
            </div>
        </div>
    </div>

    <div id="chat-area">
        <div id="sidebar">
            <div class="header">
                <h2 id="my-name-display" style="cursor:pointer;" onclick="openMyProfile()" title="Mein Profil">Profil</h2>
                <div style="display:flex; gap:8px; align-items:center;">
                    <span style="cursor:pointer; font-size:18px;" title="Gruppe erstellen" onclick="openGroupCreate()">ğŸ‘¥</span>
                    <span style="cursor:pointer; font-size:18px;" onclick="openGlobalSearch()" title="Globale Suche">ğŸ”</span>
                    <span class="settings-btn" onclick="openSettings()">âš™ï¸</span>
                </div>
            </div>
            <div style="padding:10px; display:flex; gap:5px; background:var(--bg);">
                <input type="text" id="search-input" placeholder="User suchen..." style="margin:0;">
                <button id="btn-search" style="width:50px; margin:0;">+</button>
            </div>
            <!-- STORIES BAR -->
            <div id="stories-bar" style="display:flex; align-items:center; gap:10px; padding:8px 12px; overflow-x:auto; background:var(--white); border-bottom:1px solid var(--border-color); scrollbar-width:none; -webkit-overflow-scrolling:touch;">
                <!-- My story bubble (always first) -->
                <div id="my-story-bubble" style="display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; flex-shrink:0;" onclick="openMyStoryOrCreate()" oncontextmenu="event.preventDefault(); openStoryContextMenu()">
                    <div id="my-story-avatar" style="width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:bold; color:white; position:relative; border:3px solid var(--border-color);">
                    </div>
                    <span style="font-size:10px; max-width:52px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; opacity:0.7;">Deine</span>
                </div>
                <!-- Contact stories injected here -->
                <div id="contact-stories-list" style="display:contents;"></div>
            </div>

            <div id="contacts-list"></div>
            <div id="resize-handle"></div>
        </div>

        <div id="main-chat">
            <div class="encryption-notice" id="encryption-notice">
                ğŸ”“ Nachrichten sind nicht Ende-zu-Ende verschlÃ¼sselt
            </div>
            <div class="header">
                <span class="back-btn" onclick="closeChat()">â†</span>
                <h2 id="chat-header">Chat</h2>
                <div class="menu-container">
                    <span class="menu-dots" onclick="toggleChatMenu()">â‹®</span>
                    <div id="chat-menu" class="dropdown-menu">
                        <div class="menu-item" id="menu-group-info" onclick="openGroupInfo()" style="display:none;">ğŸ‘¥ Gruppeninfo</div>
                        <div class="menu-item" onclick="openScheduled()">ğŸ• Geplante Nachrichten</div>
                        <div class="menu-item" onclick="exportChat()">ğŸ“¥ Chat exportieren</div>
                        <div class="menu-item" onclick="searchInChat()">ğŸ” Nachricht suchen</div>
                        <div class="menu-item" onclick="clearChat()">ğŸ—‘ï¸ Chat leeren</div>
                    </div>
                </div>
            </div>
            <div id="typing-status"></div>
            <div id="pinned-msg-bar" style="display:none; padding:8px 15px; background:var(--white); border-bottom:1px solid var(--border-color); cursor:pointer; display:none; align-items:center; gap:8px;" onclick="scrollToPinned()">
                <span style="font-size:16px;">ğŸ“Œ</span>
                <div style="flex:1; overflow:hidden;">
                    <div style="font-size:10px; font-weight:600; color:var(--primary);">Angeheftete Nachricht</div>
                    <div id="pinned-msg-text" style="font-size:12px; opacity:0.7; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                </div>
                <span onclick="event.stopPropagation(); unpinMessage()" style="opacity:0.4; font-size:18px; cursor:pointer;">âœ•</span>
            </div>
            <div id="messages-container" style="position:relative;">
                <div class="empty-state" id="empty-chat-state">
                    <div class="empty-state-icon">ğŸ’¬</div>
                    <div class="empty-state-title">Kein Chat ausgewÃ¤hlt</div>
                    <div class="empty-state-subtitle">WÃ¤hle einen Kontakt aus der Liste, um zu chatten</div>
                </div>
                <button id="scroll-to-bottom" onclick="scrollToBottom()">â†“</button>
            </div>
            <div id="reply-bar">
                <div class="reply-content">
                    <div style="font-weight:bold; margin-bottom:2px;" id="reply-sender"></div>
                    <div id="reply-text"></div>
                </div>
                <span class="reply-cancel" onclick="cancelReply()">âœ•</span>
            </div>
            <div id="edit-mode-bar">
                <div class="edit-content">
                    <div style="font-weight:bold; margin-bottom:2px;">âœï¸ Nachricht bearbeiten</div>
                    <div id="edit-preview"></div>
                </div>
                <span class="edit-cancel" onclick="cancelEdit()">âœ•</span>
            </div>
            <div id="input-area">
                <button id="btn-emoji" onclick="openEmojiPicker()" style="width:45px; background:transparent; color:var(--text-color); font-size:20px; padding:0;">ğŸ˜Š</button>
                <button onclick="openPollCreator()" style="width:45px; background:transparent; color:var(--text-color); font-size:20px; padding:0;" title="Abstimmung erstellen">ğŸ“Š</button>
                <button onclick="document.getElementById('img-upload-input').click()" style="width:45px; background:transparent; color:var(--text-color); font-size:20px; padding:0;" title="Bild senden">ğŸ–¼ï¸</button>
                <input type="file" id="img-upload-input" accept="image/*" style="display:none;">
                <textarea id="msg-input" placeholder="Nachricht..." rows="1" style="resize:none; overflow:hidden; min-height:44px; max-height:120px; line-height:1.4; padding:12px 20px;"></textarea>
                <button id="btn-send" style="width:60px;">â¤</button>
            </div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
    getDatabase, ref, set, get, push, update,
    onChildAdded, onChildRemoved, onChildChanged,
    remove, onValue, off,
    query, orderByChild, startAt, endAt // kept for potential future use
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyB3wZU09SzNh7xZFPFjPHR9nhDCWkGzj7E",
    authDomain: "villochat.firebaseapp.com",
    databaseURL: "https://villochat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "villochat",
    storageBucket: "villochat.firebasedata.app",
    messagingSenderId: "257561919332",
    appId: "1:257561919332:web:712d942c2f2e07169e8471"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let myUsername = "", activeChatId = null, activeContactName = null, currentMode = 'login', chatRef = null, typingRef = null;
let replyingTo = null;
let unreadCounts = {};

// Gruppen-Variablen
let activeGroupId = null;
let groupsListener = null;
let groupMessageListeners = {};
let selectedGroupMembers = [];

marked.setOptions({ breaks: true });

/* ------------------------------ */
/* ------------------------------ */
/* PARTIAL CONTACT SEARCH HELPER  */
/* ------------------------------ */
async function searchContactsPartial(query, excludeList = []) {
    const snap = await get(ref(db, `accounts/${myUsername}/contacts`));
    if(!snap.exists()) return [];
    const contacts = Object.values(snap.val()).filter(Boolean);
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    const q = query.toLowerCase();
    return contacts.filter(c =>
        !excludeList.includes(c) &&
        (c.toLowerCase().includes(q) || (aliases[c] || '').toLowerCase().includes(q))
    );
}

function renderContactSearchResults(results, container, onSelect, alreadyLabel = 'Bereits hinzugefÃ¼gt') {
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    container.innerHTML = '';
    if(!results.length) {
        container.innerHTML = '<div style="opacity:0.5;font-size:13px;padding:6px;">Kein Kontakt gefunden</div>';
        return;
    }
    results.forEach(name => {
        const item = document.createElement('div');
        item.className = 'contact-item';
        item.style.padding = '8px 12px';
        const displayName = aliases[name] || name;
        item.innerHTML = `${getAvatarHTML(name)} <span style="flex:1;">${displayName}</span> <span style="color:var(--primary);">+</span>`;
        item.onclick = () => onSelect(name);
        container.appendChild(item);
    });
}

/* AVATAR HELPERS */
/* ------------------------------ */
function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash) % 360},65%,40%)`;
}

// Cache for Firebase avatar data
const avatarCache = {};

async function fetchAvatarFromFirebase(name) {
    if(avatarCache[name]) return avatarCache[name];
    try {
        const snap = await get(ref(db, `accounts/${name}/avatar`));
        if(snap.exists()) {
            const data = snap.val();
            avatarCache[name] = data;
            // Also update localStorage for offline use
            const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
            avatarSettings[name] = data;
            localStorage.setItem('avatar_settings', JSON.stringify(avatarSettings));
            return data;
        }
    } catch(e) {}
    return null;
}

function getAvatarHTML(name, showOnline = false) {
    const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
    const data = avatarSettings[name] || avatarCache[name] || {};
    const onlineIndicator = showOnline ? '<div class="online-indicator"></div>' : '';

    // Kick off background fetch to keep cache fresh (only if not yet cached)
    if(!avatarCache[name]) {
        fetchAvatarFromFirebase(name).then(fetched => {
            if(!fetched) return;
            document.querySelectorAll(`[data-avatar-name="${name}"]`).forEach(el => _applyAvatarToEl(el, name, fetched));
        });
    }

    if(data.type === 'emoji' && data.emoji) {
        const bg = data.color || stringToColor(name);
        return `<div class="avatar" style="background:${bg}; font-size:20px;" data-avatar-name="${name}">${data.emoji}${onlineIndicator}</div>`;
    }
    if(data.type === 'image' && data.image) {
        return `<div class="avatar" style="background:#333; overflow:hidden; padding:0;" data-avatar-name="${name}"><img src="${data.image}" style="width:100%;height:100%;object-fit:cover;">${onlineIndicator}</div>`;
    }
    // Default: letter
    const color = data.color || stringToColor(name);
    const font = data.font || "'Playfair Display', serif";
    return `<div class="avatar" style="background:${color}; font-family:${font}" data-avatar-name="${name}">${name.charAt(0)}${onlineIndicator}</div>`;
}

/* ------------------------------ */
/* DATE LABEL HELPER */
/* ------------------------------ */
function getDateLabel(timestamp) {
    const msgDate = new Date(timestamp);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if(msgDate.toDateString() === today.toDateString()) return "Heute";
    if(msgDate.toDateString() === yesterday.toDateString()) return "Gestern";
    return msgDate.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
}

/* ------------------------------ */
/* ONLINE STATUS */
/* ------------------------------ */
function updateOnlineStatus() {
    if(!myUsername) return;
    set(ref(db, `online/${myUsername}`), {
        status: true,
        lastSeen: Date.now()
    });
}

// Update online status every 30 seconds
setInterval(updateOnlineStatus, 30000);
window.addEventListener('beforeunload', () => {
    if(myUsername) {
        set(ref(db, `online/${myUsername}/status`), false);
    }
});

/* ------------------------------ */
/* THEME SYSTEM (SYSTEM, LIGHT, DARK) */
/* ------------------------------ */
function applyTheme(theme) {
    if(theme === 'system') {
        // Check system preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if(prefersDark) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    } else if(theme === 'dark') {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
}

function setTheme(theme) {
    localStorage.setItem('villo_theme', theme);
    applyTheme(theme);
    updateThemeButtons(theme);
    showNotification(`âœ… Design: ${theme === 'system' ? 'System' : theme === 'dark' ? 'Dunkel' : 'Hell'}`, 'success');
}

function updateThemeButtons(theme) {
    document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`theme-${theme}`).classList.add('active');
}

window.setTheme = setTheme;

// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    const currentTheme = localStorage.getItem('villo_theme') || 'system';
    if(currentTheme === 'system') {
        applyTheme('system');
    }
});

/* ------------------------------ */
/* PINNING */
/* ------------------------------ */
function getPinnedContacts() {
    return JSON.parse(localStorage.getItem('pinned_contacts') || '[]');
}

function togglePinContact(contact) {
    let pinned = getPinnedContacts();
    const index = pinned.indexOf(contact);
    if(index > -1) {
        pinned.splice(index, 1);
    } else {
        pinned.push(contact);
    }
    localStorage.setItem('pinned_contacts', JSON.stringify(pinned));
    showApp(); // Refresh contacts list
}

window.togglePinContact = togglePinContact;

/* ------------------------------ */
/* UNREAD MESSAGES */
/* ------------------------------ */
function getUnreadCount(contact) {
    const chatId = myUsername < contact ? `${myUsername}_${contact}` : `${contact}_${myUsername}`;
    return unreadCounts[chatId] || 0;
}

function updateUnreadCount(contact, count) {
    const chatId = myUsername < contact ? `${myUsername}_${contact}` : `${contact}_${myUsername}`;
    unreadCounts[chatId] = count;
}

function markChatAsRead(chatId) {
    unreadCounts[chatId] = 0;
}

/* ------------------------------ */
/* OVERLAY FUNCTIONS */
/* ------------------------------ */
window.openSettings = () => {
    if(!myUsername) return;

    document.getElementById('set-username').innerText = myUsername;
    const theme = localStorage.getItem('villo_theme') || 'system';
    updateThemeButtons(theme);

    // Load own avatar settings â€” prefer cache (fresher from Firebase)
    const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
    const mySettings = avatarCache[myUsername] || avatarSettings[myUsername] || {};
    const myColor = mySettings.color || stringToColor(myUsername);
    const myFont = mySettings.font || "'Playfair Display', serif";

    // Set preview using the helper so all types render correctly
    const preview = document.getElementById('settings-avatar-preview');
    if(preview) _applyAvatarToEl(preview, myUsername, mySettings);

    // Set letter pickers
    const colorPicker = document.getElementById('my-avatar-color-picker');
    if(colorPicker) {
        colorPicker.value = myColor;
        colorPicker.oninput = () => { if(preview && currentAvatarType === 'letter') preview.style.background = colorPicker.value; };
    }
    const fontPicker = document.getElementById('my-avatar-font-picker');
    if(fontPicker) {
        fontPicker.value = myFont;
        fontPicker.onchange = () => { if(preview && currentAvatarType === 'letter') preview.style.fontFamily = fontPicker.value; };
    }

    // Avatar type setup
    const avType = mySettings.type || 'letter';
    currentAvatarType = avType;
    avatarImageData = null;
    setAvatarType(avType);
    if(avType === 'emoji') {
        document.getElementById('my-avatar-emoji-input').value = mySettings.emoji || '';
        document.getElementById('my-avatar-color-picker-emoji').value = mySettings.color || '#075e54';
    } else if(avType === 'image' && mySettings.image) {
        avatarImageData = mySettings.image;
        document.getElementById('avatar-img-preview').style.display = 'block';
        document.getElementById('avatar-img-preview-img').src = mySettings.image;
    }

    document.getElementById('settings-overlay').style.display = 'flex';
    switchSettingsTab('personalization');
};

window.switchSettingsTab = (tab) => {
    document.querySelectorAll('.settings-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
    });
    document.querySelectorAll('.settings-panel').forEach(p => {
        p.style.display = p.id === `stab-${tab}` ? 'block' : 'none';
    });
    if(tab === 'security' && myUsername) { loadStoryVisibilitySettings(); loadGroupAddPrivacySetting(); }
};

window.saveMyAvatar = async () => {
    const colorPicker = document.getElementById('my-avatar-color-picker');
    const fontPicker = document.getElementById('my-avatar-font-picker');

    let avatarData;
    if(currentAvatarType === 'letter') {
        avatarData = { type: 'letter', color: colorPicker.value, font: fontPicker.value };
    } else if(currentAvatarType === 'emoji') {
        const emoji = document.getElementById('my-avatar-emoji-input').value.trim() || 'ğŸ˜';
        const color = document.getElementById('my-avatar-color-picker-emoji').value;
        avatarData = { type: 'emoji', emoji, color };
    } else if(currentAvatarType === 'image') {
        if(!avatarImageData) { showNotification('âš ï¸ Bitte Bild auswÃ¤hlen', 'warning'); return; }
        avatarData = { type: 'image', image: avatarImageData };
    }
    
    // Save to localStorage
    const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
    avatarSettings[myUsername] = avatarData;
    localStorage.setItem('avatar_settings', JSON.stringify(avatarSettings));

    // Bust cache so next render uses fresh data
    delete avatarCache[myUsername];

    // Save to Firebase so others can see it
    try {
        await set(ref(db, `accounts/${myUsername}/avatar`), avatarData);
        showNotification('âœ… Avatar gespeichert & synchronisiert', 'success');
    } catch(e) {
        showNotification('âœ… Avatar lokal gespeichert', 'success');
    }

    // Update story bubble avatar immediately
    const storyAv = document.getElementById('my-story-avatar');
    if(storyAv) _applyAvatarToEl(storyAv, myUsername, avatarData);

    // Update settings preview
    const preview = document.getElementById('settings-avatar-preview');
    if(preview) _applyAvatarToEl(preview, myUsername, avatarData);

    // Refresh contact list to re-render all avatars
    showApp();
};
window.closeOverlay = (id) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.style.display = 'none';
    if(id === 'chat-menu') {
        el.classList.remove('show');
    }
    if(id === 'story-create-overlay') {
        const modal = el.querySelector('.modal');
        if(modal) modal.style.display = '';
    }
};

/* ------------------------------ */
/* THREE DOT MENU */
/* ------------------------------ */
window.toggleChatMenu = () => {
    const menu = document.getElementById('chat-menu');
    menu.classList.toggle('show');
};

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    if(!e.target.closest('.menu-container')) {
        document.getElementById('chat-menu').classList.remove('show');
    }
});

/* ------------------------------ */
/* SCROLL TO BOTTOM */
/* ------------------------------ */
window.scrollToBottom = () => {
    const container = document.getElementById('messages-container');
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
    updateScrollBadge(0);
};

// Show/hide scroll button based on scroll position
function initScrollButton() {
    const container = document.getElementById('messages-container');
    const btn = document.getElementById('scroll-to-bottom');
    
    if(!container || !btn) return;
    
    container.addEventListener('scroll', () => {
        const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 200;
        if(isNearBottom) {
            btn.classList.remove('show');
        } else {
            btn.classList.add('show');
        }
    });
}

/* ------------------------------ */
/* ACCENT COLOR */
/* ------------------------------ */
function setAccentColor(color) {
    document.documentElement.style.setProperty('--primary', color);
    localStorage.setItem('villo_accent', color);
    
    // Update active state
    document.querySelectorAll('.accent-color-option').forEach(opt => {
        if(opt.dataset.color === color) {
            opt.classList.add('active');
        } else {
            opt.classList.remove('active');
        }
    });
    
    showNotification(`âœ… Akzentfarbe geÃ¤ndert`, 'success');
}

function initAccentColorPicker() {
    const savedAccent = localStorage.getItem('villo_accent') || '#075e54';
    setAccentColor(savedAccent);
    
    document.querySelectorAll('.accent-color-option').forEach(opt => {
        opt.onclick = () => setAccentColor(opt.dataset.color);
    });
}

/* ------------------------------ */
/* NOTIFICATION SYSTEM */
/* ------------------------------ */
function playErrorSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Zwei kurze absteigende TÃ¶ne â€” klassischer Fehlersound
        [0, 0.18].forEach((delay, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'square';
            osc.frequency.value = i === 0 ? 440 : 330;
            gain.gain.setValueAtTime(0.18, ctx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.15);
            osc.start(ctx.currentTime + delay);
            osc.stop(ctx.currentTime + delay + 0.15);
        });
    } catch(e) {}
}

function playWarningSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(600, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(500, ctx.currentTime + 0.15);
        gain.gain.setValueAtTime(0.18, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.2);
    } catch(e) {}
}

function playSendSound() {
    const soundEnabled = localStorage.getItem('villo_sound') === 'true';
    if(!soundEnabled) return;
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.08);
        gain.gain.setValueAtTime(0.12, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.12);
    } catch(e) {}
}


function showNotification(message, type = 'success') {
    const toast = document.getElementById('notification-toast');
    toast.textContent = message;
    toast.className = `notification-toast ${type}`;
    toast.style.display = 'flex';

    // Fehlersound / Warnsound
    const soundEnabled = localStorage.getItem('villo_sound') === 'true';
    if(soundEnabled) {
        if(type === 'error') playErrorSound();
        else if(type === 'warning') playWarningSound();
    }
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

/* ------------------------------ */
/* AUTH & LOGIN/REGISTER */
/* ------------------------------ */
function setAuth(m) {
    currentMode = m;
    document.getElementById('t-login').style.borderBottom = m==='login'?'2px solid var(--primary)':'none';
    document.getElementById('t-login').style.color = m==='login'?'var(--primary)':'#999';
    document.getElementById('t-reg').style.borderBottom = m==='register'?'2px solid var(--primary)':'none';
    document.getElementById('t-reg').style.color = m==='register'?'var(--primary)':'#999';
    
    // PIN-Hint-Feld nur bei Registrierung
    const hintField = document.getElementById('v-pin-hint');
    hintField.style.display = m === 'register' ? 'block' : 'none';
    if(m === 'login') {
        document.getElementById('pin-hint-display').style.display = 'none';
        document.getElementById('pin-hint-text').textContent = '';
    }

    // Btn label
    document.getElementById('btn-auth').textContent = m === 'register' ? 'Registrieren' : 'Starten';

    // Update autocomplete for password managers
    const pinInput = document.getElementById('v-pin');
    if(m === 'register') {
        pinInput.setAttribute('autocomplete', 'new-password');
    } else {
        pinInput.setAttribute('autocomplete', 'current-password');
    }
}

document.getElementById('v-pin').addEventListener('input', e => {
    let v = e.target.value.replace(/\D/g,'');
    if(v.length>4) v=v.slice(0,4)+'-'+v.slice(4,8);
    e.target.value = v;
});

// Hint laden wenn Username verlassen wird (nur im Login-Modus)
document.getElementById('v-username').addEventListener('blur', async () => {
    if(currentMode !== 'login') return;
    const u = document.getElementById('v-username').value.trim();
    if(!u) return;
    const snap = await get(ref(db, `accounts/${u}/pinHint`));
    const hintDisplay = document.getElementById('pin-hint-display');
    if(snap.exists() && snap.val()) {
        document.getElementById('pin-hint-text').textContent = snap.val();
        hintDisplay.style.display = 'block';
    } else {
        hintDisplay.style.display = 'none';
    }
});

document.getElementById('btn-auth').onclick = async () => {
    const u = document.getElementById('v-username').value.trim();
    const p = document.getElementById('v-pin').value;
    if(!u || p.length<9) {
        showNotification("âš ï¸ Bitte Name und PIN eingeben!", "warning");
        return;
    }

    const s = await get(ref(db, 'accounts/' + u));
    if(currentMode === 'register'){
        if(s.exists()) {
            showNotification("â›” Name bereits vergeben!", "error");
            return;
        }
        const hint = document.getElementById('v-pin-hint').value.trim();
        await set(ref(db, 'accounts/' + u), { username: u, pin: p, id: u.toLowerCase(), ...(hint ? { pinHint: hint } : {}) });
        showNotification("âœ… Erfolgreich registriert!", "success");
        return;
    } else {
        if(!s.exists() || s.val().pin !== p) {
            showNotification("â›” Falscher Name oder PIN!", "error");
            return;
        }
        await signInAnonymously(auth);
        myUsername = u;
        localStorage.setItem('villo_session', u);
        updateOnlineStatus();
        showApp();
    }
};

/* ------------------------------ */
/* SHOW APP & LOAD CONTACTS */
/* ------------------------------ */
let contactsListener = null;
let contactChatListeners = {};
let messageListeners = {};

function showApp() {
    document.getElementById('auth-area').style.display = 'none';
    document.getElementById('chat-area').style.display = 'flex';
    document.getElementById('my-name-display').innerText = myUsername;
    
    const savedBg = localStorage.getItem('villo_bg');
    if(savedBg) document.getElementById('main-chat').style.backgroundColor = savedBg;
    
    const theme = localStorage.getItem('villo_theme') || 'system';
    applyTheme(theme);

    // Preload own avatar from Firebase
    fetchAvatarFromFirebase(myUsername);

    // Remove old listener
    if(contactsListener) off(contactsListener);
    
    // Clean up old message listeners
    Object.keys(messageListeners).forEach(chatId => {
        if(messageListeners[chatId]) off(messageListeners[chatId]);
    });
    messageListeners = {};

    contactsListener = ref(db, `accounts/${myUsername}/contacts`);
    onValue(contactsListener, (snap) => {
        const list = document.getElementById('contacts-list'); 
        list.innerHTML = "";
        
        if(!snap.exists() || Object.keys(snap.val()).length === 0) {
            // Empty state for no contacts
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div class="empty-state-title">Keine Kontakte</div>
                    <div class="empty-state-subtitle">Suche nach Nutzern, um Kontakte hinzuzufÃ¼gen</div>
                </div>
            `;
            return;
        }

        const aliases = JSON.parse(localStorage.getItem('contact_aliases') || "{}");
        const pinned = getPinnedContacts();
        
        let contacts = Object.values(snap.val());
        
        // Cache contacts for forward and global search
        window._contactsCache = [...contacts];
        
        // Sort: pinned first, then alphabetically
        contacts.sort((a, b) => {
            const aPinned = pinned.includes(a);
            const bPinned = pinned.includes(b);
            if(aPinned && !bPinned) return -1;
            if(!aPinned && bPinned) return 1;
            return a.localeCompare(b);
        });

        const archived = getArchivedChats();
        const muted = getMutedChats();
        const activeContacts = contacts.filter(n => !archived.includes(n));
        const archivedContacts = contacts.filter(n => archived.includes(n));
        
        // Render active contacts
        activeContacts.forEach(n => {
            const displayName = aliases[n] || n;
            const isPinned = pinned.includes(n);
            const isMuted = muted.includes(n);
            const hasUnread = getUnreadCount(n) > 0;
            
            const d = document.createElement('div');
            d.className = 'contact-item' + (isPinned ? ' pinned' : '');
            d.dataset.contact = n;
            
            d.innerHTML = `
                ${getAvatarHTML(displayName, false)} 
                <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:4px;">
                        <span>${displayName}${isPinned ? '<span class="pin-icon">ğŸ“Œ</span>' : ''}</span>
                        ${isMuted ? '<span class="muted-icon">ğŸ”‡</span>' : ''}
                    </div>
                </div>
                ${hasUnread ? '<span class="unread-badge"></span>' : ''}
                <span class="edit-contact" style="margin-left:4px; cursor:pointer;" onclick="event.stopPropagation(); editContactAlias('${n}')">âœ</span>
                <span class="del-contact" style="margin-left:5px; cursor:pointer;" onclick="event.stopPropagation(); removeContact('${n}')">âœ•</span>
            `;
            
            d.onclick = () => startChat(n);
            list.appendChild(d);
            
            // Listen for new messages
            const chatId = myUsername < n ? `${myUsername}_${n}` : `${n}_${myUsername}`;
            if(!messageListeners[chatId]) {
                messageListeners[chatId] = ref(db, `chats/${chatId}`);
                onChildAdded(messageListeners[chatId], (msgSnap) => {
                    const msg = msgSnap.val();
                    if(msg.sender !== myUsername && !msg.read && activeChatId !== chatId) {
                        updateUnreadCount(n, getUnreadCount(n) + 1);
                        if(!isContactMuted(n)) {
                            playNotificationSound();
                            showNotification(`ğŸ’¬ Neue Nachricht von ${displayName}`, 'success');
                        }
                        // Only update this contact's badge, not the whole list
                        refreshContactBadge(n);
                    }
                });
            }
        });
        
        // Archive section
        if(archivedContacts.length > 0) {
            let archiveOpen = localStorage.getItem('villo_archive_open') === 'true';
            
            const archiveHeader = document.createElement('div');
            archiveHeader.className = 'archive-header';
            archiveHeader.innerHTML = `ğŸ—‚ï¸ Archiviert (${archivedContacts.length}) ${archiveOpen ? 'â–²' : 'â–¼'}`;
            archiveHeader.onclick = () => {
                archiveOpen = !archiveOpen;
                localStorage.setItem('villo_archive_open', archiveOpen);
                showApp();
            };
            list.appendChild(archiveHeader);
            
            if(archiveOpen) {
                archivedContacts.forEach(n => {
                    const displayName = aliases[n] || n;
                    const d = document.createElement('div');
                    d.className = 'contact-item';
                    d.style.opacity = '0.7';
                    d.innerHTML = `
                        ${getAvatarHTML(displayName, false)}
                        <span>${displayName} <span class="archived-icon">ğŸ—‚ï¸</span></span>
                        <span class="del-contact" style="margin-left:auto; cursor:pointer;" onclick="event.stopPropagation(); removeContact('${n}')">âœ•</span>
                    `;
                    d.onclick = () => startChat(n);
                    list.appendChild(d);
                });
            }
        }
    }, { onlyOnce: false });

    // Load groups alongside contacts
    loadGroups();

    // Start scheduled message checker (once)
    if(!window._schedulerStarted) { window._schedulerStarted = true; startSchedulerTick(); }

    // Init stories
    initMyStoryBubble();
    loadContactStories();

    // Handle invite link (?join=groupId)
    const joinParam = new URLSearchParams(location.search).get('join');
    if(joinParam) {
        history.replaceState({}, '', location.pathname); // Clean URL
        setTimeout(async () => {
            const gSnap = await get(ref(db, `groups/${joinParam}`));
            if(!gSnap.exists()) { showNotification('âŒ Gruppe nicht gefunden', 'error'); return; }
            const g = gSnap.val();
            if(g.members && g.members[myUsername]) {
                // Already member â€” just open
                window.startGroupChat(joinParam, g.name);
                return;
            }
            // Add user to group
            await update(ref(db, `groups/${joinParam}/members`), { [myUsername]: true });
            await push(ref(db, `accounts/${myUsername}/groups`), joinParam);
            push(ref(db, `chats/${joinParam}`), {
                sender: 'ğŸ¤– System',
                text: `${myUsername} ist Ã¼ber einen Einladungslink beigetreten.`,
                timestamp: Date.now(), read: false, isSystem: true
            });
            showNotification(`âœ… Gruppe â€${g.name}" beigetreten!`, 'success');
            loadGroups();
            setTimeout(() => window.startGroupChat(joinParam, g.name), 500);
        }, 800);
    }
}


/* ------------------------------ */
document.getElementById('btn-search').onclick = async () => {
    const s = document.getElementById('search-input').value.trim();
    if(!s) return;
    const resDiv = document.getElementById('search-results');
    resDiv.innerHTML = '';

    // Direkter Lookup via Username (statt Range-Query)
    const snap = await get(ref(db, `accounts/${s}`));
    if(snap.exists() && snap.val().username !== myUsername) {
        document.getElementById('search-overlay').style.display = 'flex';
        const name = snap.val().username;
        const item = document.createElement('div');
        item.className = 'contact-item';
        item.innerHTML = `${getAvatarHTML(name)} <span>${name}</span> <span style="margin-left:auto;">+</span>`;
        item.onclick = () => { addGegenseitig(name); closeOverlay('search-overlay'); };
        resDiv.appendChild(item);
    } else {
        document.getElementById('search-overlay').style.display = 'flex';
        resDiv.innerHTML = '<p style="padding:10px; opacity:0.5;">Kein Nutzer gefunden</p>';
    }
};

async function addGegenseitig(target) {
    push(ref(db, `accounts/${myUsername}/contacts`), target);
    push(ref(db, `accounts/${target}/contacts`), myUsername);
}

/* ------------------------------ */
/* ------------------------------ */
/* TARGETED BADGE UPDATE (no full re-render) */
/* ------------------------------ */
function refreshContactBadge(contactName) {
    // Find the contact item in the DOM and update badge without re-rendering the whole list
    const listEl = document.getElementById('contacts-list');
    if(!listEl) return;
    const items = listEl.querySelectorAll('.contact-item');
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    const displayName = aliases[contactName] || contactName;
    items.forEach(item => {
        if(item.dataset.contact === contactName) {
            const hasUnread = getUnreadCount(contactName) > 0;
            let badge = item.querySelector('.unread-badge');
            if(hasUnread && !badge) {
                badge = document.createElement('span');
                badge.className = 'unread-badge';
                const editBtn = item.querySelector('.edit-contact');
                if(editBtn) item.insertBefore(badge, editBtn);
                else item.appendChild(badge);
            } else if(!hasUnread && badge) {
                badge.remove();
            }
        }
    });
}

/* ------------------------------ */
/* MESSAGE RENDER HELPER */
/* ------------------------------ */
function renderMessageEl(d, m, msgKey, time, fullDate, _unused, contactColors) {
    if(m.deletedForAll) {
        d.innerHTML = `<em style="opacity:0.4; font-size:12px;">ğŸ—‘ï¸ Nachricht gelÃ¶scht</em>`;
        d.style.background = 'transparent';
        d.style.boxShadow = 'none';
        return;
    }
    d.style.background = '';
    d.style.boxShadow = '';
    const customColor = contactColors[m.sender];
    if(customColor && m.sender !== myUsername) d.style.backgroundColor = customColor;
    let replyHTML = '';
    if(m.replyTo) {
        replyHTML = `<div class="reply-quote"><div class="reply-sender">${m.replyTo.sender}</div><div>${m.replyTo.text.substring(0,50)}${m.replyTo.text.length>50?'...':''}</div></div>`;
    }
    let reactionsHTML = '';
    if(m.reactions) {
        reactionsHTML = '<div class="msg-reactions">';
        Object.entries(m.reactions).forEach(([emoji, users]) => {
            const hasMyReaction = users.includes(myUsername);
            const escapedEmoji = emoji.replace(/'/g, '&apos;');
            reactionsHTML += `<span class="msg-reaction ${hasMyReaction?'my-reaction':''}" data-msgkey="${msgKey}" data-emoji="${escapedEmoji}">${emoji} ${users.length}</span>`;
        });
        reactionsHTML += '</div>';
    }
    const checkmark     = m.sender===myUsername ? `<span class="msg-status ${m.read?'check-read':'check-sent'}">${m.read?'âœ“âœ“':'âœ“'}</span>` : '';
    const editedMark    = m.edited    ? '<span class="msg-edited">(bearbeitet)</span>' : '';
    const forwardedMark = m.forwarded ? '<div class="msg-forwarded">â†ªï¸ Weitergeleitet</div>' : '';
    const delIcon       = m.sender===myUsername ? `<span class="del-msg" style="cursor:pointer;" onclick="deleteMsg('${msgKey}')">ğŸ—‘</span>` : '';
    const safeText      = (m.text||'').replace(/`/g,'\\`');
    const replyIcon     = `<span class="msg-menu" onclick="replyToMsg('${msgKey}','${m.sender}',\`${safeText}\`)">â†©ï¸</span>`;

    // Poll rendering
    if(m.poll) {
        d.innerHTML = `${replyHTML}${renderPoll(msgKey, m.poll)}${reactionsHTML}<span class="msg-time"><span class="full-date">${fullDate}</span>${time} ${checkmark} ${replyIcon} ${delIcon}</span>`;
        return;
    }

    d.innerHTML = `${forwardedMark}${replyHTML}${renderMessageContent(m.text||'')}${reactionsHTML}<span class="msg-time"><span class="full-date">${fullDate}</span>${time} ${editedMark} ${checkmark} ${replyIcon} ${delIcon}</span>`;
}

/* ------------------------------ */
/* LOAD GROUPS */
/* ------------------------------ */
function loadGroups() {
    if(groupsListener) off(groupsListener);
    groupsListener = ref(db, `accounts/${myUsername}/groups`);
    onValue(groupsListener, async (snap) => {
        const list = document.getElementById('contacts-list');
        list.querySelectorAll('.group-item').forEach(el => el.remove());

        if(!snap.exists()) return;
        const groupIds = Object.values(snap.val());
        const archived = getArchivedChats();
        const muted = getMutedChats();

        const activeGroups = [];
        const archivedGroups = [];

        for(const gid of groupIds) {
            const gSnap = await get(ref(db, `groups/${gid}`));
            if(!gSnap.exists()) continue;
            const g = gSnap.val();

            // Ensure creator is always admin (fix for existing groups)
            if(g.createdBy && (!g.admins || !g.admins[g.createdBy])) {
                update(ref(db, `groups/${gid}/admins`), { [g.createdBy]: true });
            }

            if(archived.includes(gid)) archivedGroups.push({ gid, g });
            else activeGroups.push({ gid, g });
        }

        // Render active groups at top of list
        for(const { gid, g } of activeGroups) {
            const isMuted = muted.includes(gid);
            const d = document.createElement('div');
            d.className = 'contact-item group-item';
            d.dataset.groupId = gid;
            d.innerHTML = `
                <div class="avatar" style="background:${stringToColor(g.name)}; font-size:20px; width:40px; height:40px; margin-right:12px; flex-shrink:0;">${g.avatar || 'ğŸ‘¥'}</div>
                <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:4px;">
                        <span>${g.name}</span>
                        <span style="font-size:10px; opacity:0.5; margin-left:4px;">Gruppe</span>
                        ${isMuted ? '<span class="muted-icon">ğŸ”‡</span>' : ''}
                    </div>
                </div>
                <span id="group-badge-${gid}" class="unread-badge" style="display:none;"></span>
            `;
            d.onclick = () => window.startGroupChat(gid, g.name);
            list.prepend(d);

            if(!groupMessageListeners[gid]) {
                groupMessageListeners[gid] = ref(db, `chats/${gid}`);
                onChildAdded(groupMessageListeners[gid], (msgSnap) => {
                    const msg = msgSnap.val();
                    if(msg.sender !== myUsername && activeChatId !== gid) {
                        const badge = document.getElementById(`group-badge-${gid}`);
                        if(badge) badge.style.display = '';
                        if(!isMuted) {
                            playNotificationSound();
                            showNotification(`ğŸ’¬ ${msg.sender} in ${g.name}`, 'success');
                        }
                    }
                });
            }
        }

        // Render archived groups in archive section (append after contacts archive section)
        if(archivedGroups.length > 0) {
            let archiveSection = list.querySelector('.archive-header');
            for(const { gid, g } of archivedGroups) {
                const d = document.createElement('div');
                d.className = 'contact-item group-item';
                d.style.opacity = '0.7';
                d.dataset.groupId = gid;
                d.innerHTML = `
                    <div class="avatar" style="background:${stringToColor(g.name)}; font-size:20px; width:40px; height:40px; margin-right:12px; flex-shrink:0;">${g.avatar || 'ğŸ‘¥'}</div>
                    <span>${g.name} <span style="font-size:10px; opacity:0.5;">Gruppe</span> <span class="archived-icon">ğŸ—‚ï¸</span></span>
                `;
                d.onclick = () => window.startGroupChat(gid, g.name);
                if(archiveSection) list.insertBefore(d, archiveSection.nextSibling);
                else list.appendChild(d);
            }
        }
    });
}

/* START CHAT & MESSAGES */
/* ------------------------------ */
let onlineStatusListener = null;
let encryptionNoticeTimer = null;

function startChat(n){
    if(chatRef) off(chatRef);
    if(typingRef) off(typingRef);
    if(onlineStatusListener) off(onlineStatusListener);

    activeChatId = myUsername < n ? `${myUsername}_${n}` : `${n}_${myUsername}`;
    activeContactName = n;
    
    // Pre-fetch contact's avatar from Firebase
    fetchAvatarFromFirebase(n);
    
    // Reset pinned bar
    const pinnedBar = document.getElementById('pinned-msg-bar');
    if(pinnedBar) pinnedBar.classList.remove('visible');
    
    // Mark chat as read
    markChatAsRead(activeChatId);

    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || "{}");
    const displayName = aliases[n] || n;

    // Show encryption notice, then hide after 4 seconds
    const encryptionNotice = document.getElementById('encryption-notice');
    if(encryptionNotice) {
        encryptionNotice.classList.remove('hidden');
        
        // Clear any existing timer
        if(encryptionNoticeTimer) clearTimeout(encryptionNoticeTimer);
        
        // Hide after 4 seconds
        encryptionNoticeTimer = setTimeout(() => {
            encryptionNotice.classList.add('hidden');
        }, 4000);
    }

    // Setup online status listener for active chat only
    onlineStatusListener = ref(db, `online/${n}`);
    onValue(onlineStatusListener, (snap) => {
        let isOnline = false;
        if(snap.exists()) {
            const data = snap.val();
            isOnline = data.status && (Date.now() - data.lastSeen < 60000);
        }
        document.getElementById('chat-header').innerHTML = `
            <div style="display:flex;align-items:center; flex:1; cursor:pointer;" onclick="openUserInfo('${n}')">
                ${getAvatarHTML(displayName, isOnline)} 
                <span style="margin-left:10px;">${displayName}</span>
            </div>
        `;
    });
    
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = "";
    
    // Remove empty state
    const emptyState = document.getElementById('empty-chat-state');
    if(emptyState) emptyState.style.display = 'none';
    
    document.getElementById('chat-area').classList.add('chat-open');

    document.title = `VilloChat - ${displayName}`;

    chatRef = ref(db, 'chats/' + activeChatId);
    
    // Cache outside loop â€” avoid repeated JSON.parse on every message
    const contactColors = JSON.parse(localStorage.getItem('contact_colors') || '{}');
    let lastDate = '';
    let isInitialLoad = true;
    
    // Only auto-scroll during initial load or when already near bottom
    const shouldAutoScroll = () => {
        const c = messagesContainer;
        return isInitialLoad || (c.scrollHeight - c.scrollTop - c.clientHeight < 120);
    };

    onChildAdded(chatRef, (s) => {
        const m = s.val(); 
        const msgDate = getDateLabel(m.timestamp);
        
        // Datums-Trenner einfÃ¼gen
        if(msgDate !== lastDate) {
            const dateSep = document.createElement('div');
            dateSep.className = 'date-separator';
            dateSep.innerHTML = `<span>${msgDate}</span>`;
            messagesContainer.appendChild(dateSep);
            lastDate = msgDate;
        }
        
        const d = document.createElement('div');
        d.className = 'msg ' + (m.sender===myUsername?'sent':'received');
        d.id = "m-"+s.key;
        d.dataset.msgKey = s.key;
        d.dataset.msgText = m.text;
        d.dataset.msgSender = m.sender;
        
        const time = new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        const fullDate = new Date(m.timestamp).toLocaleString('de-DE', {
            day:'2-digit', month:'2-digit', year:'numeric',
            hour:'2-digit', minute:'2-digit'
        });
        
        renderMessageEl(d, m, s.key, time, fullDate, replyIcon => replyIcon, contactColors);
        
        // Track unread for scroll badge
        if(m.sender !== myUsername && !m.read) {
            if(!shouldAutoScroll()) updateScrollBadge(unreadScrollCount + 1);
        }
        
        // Add context menu listeners
        d.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showMessageContextMenu(e, s.key, m.text, m.sender);
        });
        
        // Long press for mobile
        let pressTimer;
        d.addEventListener('touchstart', (e) => {
            pressTimer = setTimeout(() => {
                showMessageContextMenu(e.touches[0], s.key, m.text, m.sender);
            }, 500);
        });
        d.addEventListener('touchend', () => clearTimeout(pressTimer));
        d.addEventListener('touchmove', () => clearTimeout(pressTimer));
        
        messagesContainer.appendChild(d);
        if(shouldAutoScroll()) messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Nachricht als gelesen markieren
        if(m.sender !== myUsername && !m.read) {
            set(ref(db, `chats/${activeChatId}/${s.key}/read`), true);
        }
    });
    
    // Live updates for edited/deleted messages
    onChildChanged(chatRef, (s) => {
        const m = s.val();
        const el = document.getElementById(`m-${s.key}`);
        if(!el) return;
        const time = new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        const fullDate = new Date(m.timestamp).toLocaleString('de-DE', {
            day:'2-digit', month:'2-digit', year:'numeric',
            hour:'2-digit', minute:'2-digit'
        });
        // Update cached text on element
        el.dataset.msgText = m.text || '';
        renderMessageEl(el, m, s.key, time, fullDate, () => {}, contactColors);
        
        // Re-bind context menu with fresh data (fixes edit & delete-for-all)
        const newClone = el.cloneNode(true);   // true = deep clone, keeps id + dataset
        el.parentNode.replaceChild(newClone, el);
        // Remove all old listeners by re-assigning innerHTML just for safety
        newClone.innerHTML = newClone.innerHTML;
        
        if(!m.deletedForAll) {
            newClone.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, s.key, m.text || '', m.sender);
            });
            let pressTimer;
            newClone.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => showMessageContextMenu(e.touches[0], s.key, m.text || '', m.sender), 500);
            });
            newClone.addEventListener('touchend', () => clearTimeout(pressTimer));
            newClone.addEventListener('touchmove', () => clearTimeout(pressTimer));
        }
    });
    
    // Mark initial load done after first paint
    requestAnimationFrame(() => { isInitialLoad = false; });
    
    onChildRemoved(chatRef, s => {
        const el = document.getElementById("m-"+s.key);
        if(el) el.remove();
    });

    typingRef = ref(db, `typing/${activeChatId}/${n}`);
    onValue(typingRef, s => {
        document.getElementById('typing-status').innerText = s.val()?`${displayName} schreibt gerade...`:'';
    });
    
    // Re-initialize scroll button for new chat
    setTimeout(initScrollButton, 100);
    
    // Load pinned message
    setTimeout(loadPinnedMessage, 300);
}

/* ------------------------------ */
/* REPLY FUNCTIONALITY */
/* ------------------------------ */
window.replyToMsg = (msgId, sender, text) => {
    replyingTo = { msgId, sender, text };
    document.getElementById('reply-sender').innerText = sender;
    document.getElementById('reply-text').innerText = text.substring(0, 50) + (text.length > 50 ? '...' : '');
    document.getElementById('reply-bar').style.display = 'flex';
    document.getElementById('msg-input').focus();
};

window.cancelReply = () => {
    replyingTo = null;
    document.getElementById('reply-bar').style.display = 'none';
};

/* ------------------------------ */
/* CLOSE CHAT */
/* ------------------------------ */
window.closeChat = () => {
    document.getElementById('chat-area').classList.remove('chat-open');
    document.title = "VilloChat";
    if(activeChatId) set(ref(db, `typing/${activeChatId}/${myUsername}`), false);
    if(onlineStatusListener) off(onlineStatusListener);
    
    // Clear encryption notice timer and show notice again
    if(encryptionNoticeTimer) clearTimeout(encryptionNoticeTimer);
    const encryptionNotice = document.getElementById('encryption-notice');
    if(encryptionNotice) {
        encryptionNotice.classList.remove('hidden');
    }
    
    activeChatId = null;
    activeContactName = null;
    cancelReply();
    
    // Show empty state again
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = `
        <div class="empty-state" id="empty-chat-state">
            <div class="empty-state-icon">ğŸ’¬</div>
            <div class="empty-state-title">Kein Chat ausgewÃ¤hlt</div>
            <div class="empty-state-subtitle">WÃ¤hle einen Kontakt aus der Liste, um zu chatten</div>
        </div>
    `;
    
    showApp(); // Refresh to clear badges
};

/* ------------------------------ */
/* SEND MESSAGE & TYPING */
/* ------------------------------ */
const msgInput = document.getElementById('msg-input');

// Merged oninput: typing indicator + auto-resize (both in one handler)
let typingDebounce = null;
let isTyping = false;
msgInput.oninput = () => {
    // Auto-resize
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
    
    // Typing indicator with debounce - only write to Firebase when state changes
    if(activeChatId) {
        if(!isTyping) {
            isTyping = true;
            set(ref(db, `typing/${activeChatId}/${myUsername}`), true);
        }
        clearTimeout(typingDebounce);
        typingDebounce = setTimeout(() => {
            isTyping = false;
            set(ref(db, `typing/${activeChatId}/${myUsername}`), false);
        }, 2000);
    }
};

// Enter to send, Shift+Enter for new line
msgInput.onkeydown = (e) => {
    if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('btn-send').click();
    }
};

document.getElementById('btn-send').onclick = () => {
    if(!msgInput.value.trim() || !activeChatId) return;
    
    // Check if editing
    if(editingMessageKey) {
        const newText = msgInput.value.trim();
        const msgRef = ref(db, `chats/${activeChatId}/${editingMessageKey}`);
        update(msgRef, {
            text: newText,
            edited: true,
            editedAt: Date.now()
        });
        editingMessageKey = null;
        document.getElementById('edit-mode-bar').classList.remove('active');
        msgInput.value = '';
        msgInput.style.height = 'auto';
        showNotification('âœ… Nachricht bearbeitet', 'success');
        return;
    }
    
    const msgData = {
        sender: myUsername,
        text: msgInput.value,
        timestamp: Date.now(),
        read: false
    };
    
    if(replyingTo) {
        msgData.replyTo = {
            msgId: replyingTo.msgId,
            sender: replyingTo.sender,
            text: replyingTo.text
        };
    }
    
    push(ref(db, 'chats/'+activeChatId), msgData);
    set(ref(db, `typing/${activeChatId}/${myUsername}`), false);
    playSendSound();
    msgInput.value = "";
    msgInput.style.height = 'auto';
    cancelReply();
};

/* ------------------------------ */
/* BILD-UPLOAD (Base64)           */
/* ------------------------------ */
document.getElementById('img-upload-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    e.target.value = ''; // Reset so same file can be selected again
    if(!file || !activeChatId) return;

    const MAX_BYTES = 500 * 1024; // 500 KB
    if(file.size > MAX_BYTES) {
        showNotification('âš ï¸ Bild zu groÃŸ (max. 500 KB)', 'warning');
        return;
    }

    // Compress/resize via canvas to stay under limit
    const dataUrl = await compressImage(file, MAX_BYTES);
    if(!dataUrl) { showNotification('âŒ Bild konnte nicht geladen werden', 'error'); return; }

    const msgData = {
        sender: myUsername,
        text: dataUrl,
        timestamp: Date.now(),
        read: false,
        isImage: true
    };
    if(replyingTo) {
        msgData.replyTo = { msgId: replyingTo.msgId, sender: replyingTo.sender, text: replyingTo.text };
    }
    push(ref(db, 'chats/' + activeChatId), msgData);
    playSendSound();
    cancelReply();
});

function compressImage(file, maxBytes) {
    return new Promise((resolve) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
            URL.revokeObjectURL(url);
            const canvas = document.createElement('canvas');
            let { width, height } = img;
            // Scale down if needed
            const maxDim = 1200;
            if(width > maxDim || height > maxDim) {
                const scale = Math.min(maxDim / width, maxDim / height);
                width = Math.round(width * scale);
                height = Math.round(height * scale);
            }
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);

            // Try quality steps until under maxBytes
            let quality = 0.85;
            let result;
            do {
                result = canvas.toDataURL('image/jpeg', quality);
                quality -= 0.1;
            } while(result.length > maxBytes * 1.37 && quality > 0.1); // base64 ~37% overhead
            resolve(result);
        };
        img.onerror = () => { URL.revokeObjectURL(url); resolve(null); };
        img.src = url;
    });
}

// Bild aus Zwischenablage einfÃ¼gen (Ctrl+V / Cmd+V)
document.getElementById('msg-input').addEventListener('paste', async (e) => {
    const items = e.clipboardData?.items;
    if(!items || !activeChatId) return;
    for(const item of items) {
        if(item.type.startsWith('image/')) {
            e.preventDefault();
            const file = item.getAsFile();
            if(file.size > 500 * 1024) { showNotification('âš ï¸ Bild zu groÃŸ (max. 500 KB)', 'warning'); return; }
            const dataUrl = await compressImage(file, 500 * 1024);
            if(!dataUrl) return;
            push(ref(db, 'chats/' + activeChatId), {
                sender: myUsername, text: dataUrl, timestamp: Date.now(), read: false, isImage: true
            });
            playSendSound();
            return;
        }
    }
});

window.deleteMsg = (mid) => {
    if(!activeChatId) return;
    document.getElementById('confirm-text').innerText = "Nachricht wirklich lÃ¶schen?";
    document.getElementById('confirm-overlay').style.display = 'flex';

    const yesBtn = document.getElementById('confirm-yes');
    yesBtn.replaceWith(yesBtn.cloneNode(true));
    const newYes = document.getElementById('confirm-yes');
    newYes.onclick = () => {
        remove(ref(db, `chats/${activeChatId}/${mid}`));
        closeOverlay('confirm-overlay');
        showNotification("âœ… Nachricht gelÃ¶scht", "success");
    };
};

/* ------------------------------ */
/* DELETE CONTACT MIT BESTÃ„TIGUNG */
/* ------------------------------ */
window.removeContact = (n) => {
    document.getElementById('confirm-text').innerText = `Kontakt "${n}" wirklich entfernen?`;
    document.getElementById('confirm-overlay').style.display = 'flex';

    const yesBtn = document.getElementById('confirm-yes');
    yesBtn.replaceWith(yesBtn.cloneNode(true));
    const newYes = document.getElementById('confirm-yes');
    newYes.onclick = async () => {
        const snap = await get(ref(db, `accounts/${myUsername}/contacts`));
        if(snap.exists()){
            Object.entries(snap.val()).forEach(([key,val]) => { 
                if(val===n) remove(ref(db, `accounts/${myUsername}/contacts/${key}`)); 
            });
        }
        closeOverlay('confirm-overlay');
        showNotification("âœ… Kontakt entfernt", "success");
    };
};

/* ------------------------------ */
/* EDIT CONTACT ALIAS */
/* ------------------------------ */
window.editContactAlias = (contact) => {
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || "{}");
    const current = aliases[contact] || contact;

    document.getElementById('alias-text').innerText = `Alias fÃ¼r ${contact}:`;
    const input = document.getElementById('alias-input');
    input.value = current;

    document.getElementById('alias-overlay').style.display = 'flex';

    const saveBtn = document.getElementById('alias-save');
    saveBtn.replaceWith(saveBtn.cloneNode(true));
    const newSave = document.getElementById('alias-save');
    newSave.onclick = () => {
        const newAlias = input.value.trim();
        if(newAlias){
            aliases[contact] = newAlias;
            localStorage.setItem('contact_aliases', JSON.stringify(aliases));
            showApp();
            showNotification("âœ… Alias gespeichert", "success");
        }
        closeOverlay('alias-overlay');
    };
};

/* ------------------------------ */
/* CLEAR CHAT */
/* ------------------------------ */
window.clearChat = () => {
    if(!activeChatId) {
        showNotification("âš ï¸ Kein Chat geÃ¶ffnet!", "warning");
        return;
    }
    document.getElementById('confirm-text').innerText = "Gesamten Chat-Verlauf lÃ¶schen?";
    document.getElementById('confirm-overlay').style.display = 'flex';

    const yesBtn = document.getElementById('confirm-yes');
    yesBtn.replaceWith(yesBtn.cloneNode(true));
    const newYes = document.getElementById('confirm-yes');
    newYes.onclick = async () => {
        await remove(ref(db, `chats/${activeChatId}`));
        closeOverlay('confirm-overlay');
        toggleChatMenu(); // Close menu
        document.getElementById('messages-container').innerHTML = "";
        showNotification("âœ… Chat geleert", "success");
    };
};

/* ------------------------------ */
/* SEARCH IN CHAT */
/* ------------------------------ */
window.searchInChat = async () => {
    if(!activeChatId) {
        showNotification("âš ï¸ Kein Chat geÃ¶ffnet!", "warning");
        return;
    }
    toggleChatMenu();
    document.getElementById('chat-search-overlay').style.display = 'flex';
    document.getElementById('chat-search-input').value = '';
    document.getElementById('chat-search-results').innerHTML = '<p style="padding:10px; opacity:0.5;">Suchbegriff eingeben...</p>';
};

document.getElementById('chat-search-input').addEventListener('input', async (e) => {
    const searchTerm = e.target.value.toLowerCase().trim();
    const resultsDiv = document.getElementById('chat-search-results');
    
    if(!searchTerm) {
        resultsDiv.innerHTML = '<p style="padding:10px; opacity:0.5;">Suchbegriff eingeben...</p>';
        return;
    }
    
    const snap = await get(ref(db, `chats/${activeChatId}`));
    if(!snap.exists()) {
        resultsDiv.innerHTML = '<p style="padding:10px;">Keine Nachrichten gefunden</p>';
        return;
    }
    
    resultsDiv.innerHTML = '';
    let found = 0;
    
    snap.forEach(child => {
        const msg = child.val();
        if(!msg.text || !msg.text.toLowerCase().includes(searchTerm)) return;
        found++;
        const time = new Date(msg.timestamp).toLocaleString('de-DE');
        const preview = msg.text.substring(0, 100) + (msg.text.length > 100 ? '...' : '');
        
        const resultItem = document.createElement('div');
        resultItem.style.cssText = 'padding:10px; border-bottom:1px solid var(--border-color); cursor:pointer;';
        resultItem.innerHTML = `
            <div style="font-weight:bold; font-size:12px; opacity:0.7;">${activeGroupId ? `<span style="color:${stringToColor(msg.sender)}">${msg.sender}</span> Â· ` : ''}${time}</div>
            <div style="margin-top:5px;">${preview.replace(new RegExp(searchTerm, 'gi'), m => `<mark style="background:yellow;border-radius:2px;">${m}</mark>`)}</div>
        `;
        resultItem.onclick = () => {
            closeOverlay('chat-search-overlay');
            const msgEl = document.getElementById('m-' + child.key);
            if(msgEl) {
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                msgEl.style.backgroundColor = 'yellow';
                setTimeout(() => msgEl.style.backgroundColor = '', 2000);
            }
        };
        resultsDiv.appendChild(resultItem);
    });
    
    if(found === 0) {
        resultsDiv.innerHTML = '<p style="padding:10px;">Keine Ergebnisse gefunden</p>';
    }
});

/* ------------------------------ */
/* CHAT EXPORT */
/* ------------------------------ */
window.exportChat = async () => {
    if(!activeChatId) {
        showNotification("âš ï¸ Kein Chat geÃ¶ffnet!", "warning");
        return;
    }
    toggleChatMenu();
    
    const snap = await get(chatRef);
    if(!snap.exists()) {
        showNotification("âš ï¸ Keine Nachrichten vorhanden!", "warning");
        return;
    }
    
    const chatName = document.getElementById('chat-header').innerText;
    let txt = `VilloChat Export - ${chatName}\n`;
    txt += `Exportiert am: ${new Date().toLocaleString('de-DE')}\n`;
    txt += "=".repeat(50) + "\n\n";
    
    const messages = [];
    snap.forEach(child => {
        messages.push({...child.val(), key: child.key});
    });
    
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    messages.forEach(m => {
        const time = new Date(m.timestamp).toLocaleString('de-DE');
        txt += `[${time}] ${m.sender}:\n${m.text}\n\n`;
    });
    
    const blob = new Blob([txt], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Chat_${activeChatId}_${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification("âœ… Chat exportiert", "success");
};

/* ------------------------------ */
/* LOGOUT */
/* ------------------------------ */
window.logout = () => { 
    if(myUsername) {
        set(ref(db, `online/${myUsername}/status`), false);
    }
    localStorage.clear(); 
    location.reload(); 
};

/* ------------------------------ */
/* BACKGROUND COLOR PICKER */
/* ------------------------------ */
document.getElementById('bg-color-picker').addEventListener('change', (e) => {
    const color = e.target.value;
    document.getElementById('main-chat').style.backgroundColor = color;
    localStorage.setItem('villo_bg', color);
});

/* ------------------------------ */
/* MESSAGE CONTEXT MENU */
/* ------------------------------ */
let currentMessageKey = null;

function showMessageContextMenu(e, msgKey, msgText, sender) {
    currentMessageKey = msgKey;
    const menu = document.getElementById('msg-context-menu');
    menu.innerHTML = '';
    
    // Info option
    const infoItem = document.createElement('div');
    infoItem.className = 'msg-context-item';
    infoItem.innerHTML = '<span class="icon">â„¹ï¸</span><span>Info</span>';
    infoItem.onclick = () => {
        menu.classList.remove('show');
        openMsgInfo(msgKey);
    };
    menu.appendChild(infoItem);
    
    // Copy option (nur fÃ¼r Text, nicht fÃ¼r Bilder)
    if(!msgText.startsWith('data:image/')) {
        const copyItem = document.createElement('div');
        copyItem.className = 'msg-context-item';
        copyItem.innerHTML = '<span class="icon">ğŸ“‹</span><span>Kopieren</span>';
        copyItem.onclick = () => {
            navigator.clipboard.writeText(msgText);
            menu.classList.remove('show');
            showNotification('âœ… Text kopiert', 'success');
        };
        menu.appendChild(copyItem);
    }

    // Download option (nur fÃ¼r Bilder)
    if(msgText.startsWith('data:image/')) {
        const dlItem = document.createElement('div');
        dlItem.className = 'msg-context-item';
        dlItem.innerHTML = '<span class="icon">â¬‡ï¸</span><span>Herunterladen</span>';
        dlItem.onclick = () => {
            menu.classList.remove('show');
            const a = document.createElement('a');
            a.href = msgText;
            const ext = msgText.substring(11, msgText.indexOf(';')) || 'jpg';
            a.download = `bild_${msgKey}.${ext}`;
            a.click();
        };
        menu.appendChild(dlItem);
    }
    
    // React option
    const reactItem = document.createElement('div');
    reactItem.className = 'msg-context-item';
    reactItem.innerHTML = '<span class="icon">ğŸ˜Š</span><span>Reagieren</span>';
    reactItem.onclick = () => {
        menu.classList.remove('show');
        showReactionPicker(e, msgKey);
    };
    menu.appendChild(reactItem);
    
    // Reply option
    const replyItem = document.createElement('div');
    replyItem.className = 'msg-context-item';
    replyItem.innerHTML = '<span class="icon">â†©ï¸</span><span>Antworten</span>';
    replyItem.onclick = () => {
        menu.classList.remove('show');
        replyToMsg(msgKey, sender, msgText);
    };
    menu.appendChild(replyItem);
    
    // Forward option
    const fwdItem = document.createElement('div');
    fwdItem.className = 'msg-context-item';
    fwdItem.innerHTML = '<span class="icon">ğŸ“¤</span><span>Weiterleiten</span>';
    fwdItem.onclick = () => {
        menu.classList.remove('show');
        openForwardDialog(msgText);
    };
    menu.appendChild(fwdItem);
    
    // Edit option (only for own messages)
    if(sender === myUsername) {
        const editItem = document.createElement('div');
        editItem.className = 'msg-context-item';
        editItem.innerHTML = '<span class="icon">âœï¸</span><span>Bearbeiten</span>';
        editItem.onclick = () => {
            menu.classList.remove('show');
            startEditingMessage(msgKey, msgText);
        };
        menu.appendChild(editItem);
    }
    
    // Pin option
    const pinnedKey = `pinned_${activeChatId}`;
    const currentPinned = localStorage.getItem(pinnedKey);
    const isPinned = currentPinned === msgKey;
    const pinItem = document.createElement('div');
    pinItem.className = 'msg-context-item';
    pinItem.innerHTML = `<span class="icon">${isPinned ? 'ğŸ“Œ' : 'ğŸ“Œ'}</span><span>${isPinned ? 'LoslÃ¶sen' : 'Anpinnen'}</span>`;
    pinItem.onclick = () => {
        menu.classList.remove('show');
        if(isPinned) {
            unpinMessage();
        } else {
            pinMessage(msgKey, msgText);
        }
    };
    menu.appendChild(pinItem);
    
    // Delete option
    if(sender === myUsername) {
        const delItem = document.createElement('div');
        delItem.className = 'msg-context-item';
        delItem.innerHTML = '<span class="icon">ğŸ—‘ï¸</span><span>LÃ¶schen</span>';
        delItem.onclick = () => {
            menu.classList.remove('show');
            deleteMsg(msgKey);
        };
        menu.appendChild(delItem);
        
        const delAllItem = document.createElement('div');
        delAllItem.className = 'msg-context-item';
        delAllItem.style.color = '#dc3545';
        delAllItem.innerHTML = '<span class="icon">ğŸ—‘ï¸</span><span>FÃ¼r alle lÃ¶schen</span>';
        delAllItem.onclick = () => {
            menu.classList.remove('show');
            deleteMsgForAll(msgKey);
        };
        menu.appendChild(delAllItem);
    }
    
    // Position menu â€” clamp to viewport so it never goes off-screen
    menu.classList.add('show');
    
    const menuW = menu.offsetWidth  || 200;
    const menuH = menu.offsetHeight || 250;
    const vw    = window.innerWidth;
    const vh    = window.innerHeight;
    
    let x = e.clientX;
    let y = e.clientY;
    
    if(x + menuW > vw - 8)  x = vw - menuW - 8;
    if(y + menuH > vh - 8)  y = vh - menuH - 8;
    if(x < 8) x = 8;
    if(y < 8) y = 8;
    
    menu.style.left = x + 'px';
    menu.style.top  = y + 'px';
}

/* ------------------------------ */
/* MESSAGE INFO */
/* ------------------------------ */
window.openMsgInfo = async (msgKey) => {
    if(!activeChatId) return;
    const snap = await get(ref(db, `chats/${activeChatId}/${msgKey}`));
    if(!snap.exists()) return;
    const m = snap.val();

    const sent = new Date(m.timestamp).toLocaleString('de-DE', {
        weekday: 'short', day:'2-digit', month:'2-digit', year:'numeric',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
    });

    let readHTML = '';
    if(activeGroupId) {
        // Group: show per-member read status
        const gSnap = await get(ref(db, `groups/${activeGroupId}`));
        const members = gSnap.exists() ? Object.keys(gSnap.val().members || {}).filter(u => gSnap.val().members[u] && u !== m.sender) : [];
        const reads = m.readBy || {};
        readHTML = `
            <div style="margin-top:14px; border-top:1px solid var(--border-color); padding-top:12px;">
                <div style="font-weight:600; font-size:13px; margin-bottom:8px; opacity:0.7;">GELESEN VON</div>
                ${members.map(u => {
                    const ts = reads[u];
                    return `<div style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid var(--border-color);">
                        ${getAvatarHTML(u)}
                        <span style="flex:1;">${u}</span>
                        <span style="font-size:12px; opacity:0.5;">${ts ? new Date(ts).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : 'â€”'}</span>
                        <span style="font-size:16px;">${ts ? 'âœ“âœ“' : 'âœ“'}</span>
                    </div>`;
                }).join('')}
            </div>`;
    } else {
        // 1:1: show read receipt
        readHTML = `
            <div style="margin-top:14px; border-top:1px solid var(--border-color); padding-top:12px;">
                <div style="font-weight:600; font-size:13px; margin-bottom:8px; opacity:0.7;">STATUS</div>
                <div style="display:flex; align-items:center; gap:10px; padding:6px 0;">
                    <span style="font-size:20px;">${m.read ? 'âœ“âœ“' : 'âœ“'}</span>
                    <span>${m.read ? 'Gelesen' : 'Zugestellt'}</span>
                </div>
            </div>`;
    }

    const content = document.getElementById('msg-info-content');
    content.innerHTML = `
        <div style="background:var(--bg); border-radius:10px; padding:12px; margin-bottom:12px; font-size:14px; word-break:break-word; max-height:100px; overflow:hidden;">
            ${m.deletedForAll ? '<em style="opacity:0.5;">ğŸ—‘ï¸ GelÃ¶scht</em>' : (m.text || '').substring(0, 200)}
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:13px;">
            <div style="background:var(--bg); border-radius:8px; padding:10px;">
                <div style="opacity:0.5; margin-bottom:3px; font-size:11px;">GESENDET</div>
                <div style="font-weight:500;">${sent}</div>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:10px;">
                <div style="opacity:0.5; margin-bottom:3px; font-size:11px;">VON</div>
                <div style="font-weight:500;">${m.sender}</div>
            </div>
            ${m.edited ? `<div style="background:var(--bg); border-radius:8px; padding:10px; grid-column:1/-1;">
                <div style="opacity:0.5; margin-bottom:3px; font-size:11px;">BEARBEITET</div>
                <div style="font-weight:500;">${new Date(m.editedAt).toLocaleString('de-DE')}</div>
            </div>` : ''}
        </div>
        ${readHTML}
    `;
    document.getElementById('msg-info-overlay').style.display = 'flex';
};

/* ------------------------------ */
/* GRUPPE UMBENENNEN & AVATAR     */
/* ------------------------------ */
window.renameGroup = async () => {
    if(!activeGroupId) return;
    const input = document.getElementById('group-rename-input');
    const newName = input ? input.value.trim() : '';
    if(!newName) { showNotification('âŒ Bitte Namen eingeben', 'error'); return; }

    await update(ref(db, `groups/${activeGroupId}`), { name: newName });
    push(ref(db, `chats/${activeGroupId}`), {
        sender: 'ğŸ¤– System',
        text: `${myUsername} hat die Gruppe in â€${newName}" umbenannt.`,
        timestamp: Date.now(), read: false, isSystem: true
    });

    activeContactName = newName;
    // Update header
    const headerName = document.querySelector('#chat-header div div:first-child');
    if(headerName) headerName.textContent = newName;
    showNotification(`âœ… Gruppe umbenannt`, 'success');
    window.openGroupInfo();
};

window.setGroupAvatar = async (emoji) => {
    if(!activeGroupId) return;
    await update(ref(db, `groups/${activeGroupId}`), { avatar: emoji });
    showNotification(`âœ… Gruppen-Avatar gesetzt`, 'success');
    window.openGroupInfo();
    loadGroups();
};


function showReactionPicker(e, msgKey) {
    // Remove any existing picker first
    const existingPicker = document.getElementById('reaction-picker-temp');
    if(existingPicker) existingPicker.remove();
    
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    picker.id = 'reaction-picker-temp';
    picker.style.position = 'fixed';
    picker.style.left = e.clientX + 'px';
    picker.style.top = (e.clientY - 50) + 'px';
    picker.style.zIndex = '10000';
    
    const defaultReactions = ['â¤ï¸', 'ğŸ‘', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ™'];
    const savedReactions = JSON.parse(localStorage.getItem('villo_quick_reactions') || 'null');
    const quickReactions = savedReactions || defaultReactions;
    quickReactions.forEach(emoji => {
        const span = document.createElement('span');
        span.textContent = emoji;
        span.onclick = (ev) => {
            ev.stopPropagation();
            toggleReaction(msgKey, emoji);
            picker.remove();
        };
        picker.appendChild(span);
    });
    
    document.body.appendChild(picker);
    
    // Auto-close on click outside
    const closeHandler = (ev) => {
        if(!picker.contains(ev.target)) {
            picker.remove();
            document.removeEventListener('click', closeHandler);
        }
    };
    setTimeout(() => document.addEventListener('click', closeHandler), 10);
    
    // Fallback timeout
    setTimeout(() => {
        if(document.body.contains(picker)) picker.remove();
    }, 5000);
}

window.toggleReaction = async (msgKey, emoji) => {
    if(!activeChatId) return;
    
    const msgRef = ref(db, `chats/${activeChatId}/${msgKey}/reactions/${emoji}`);
    const snap = await get(msgRef);
    
    let users = snap.exists() ? snap.val() : [];
    
    if(users.includes(myUsername)) {
        users = users.filter(u => u !== myUsername);
    } else {
        users.push(myUsername);
    }
    
    if(users.length === 0) {
        await remove(msgRef);
    } else {
        await set(msgRef, users);
    }
};

// Close context menu when clicking outside
document.addEventListener('click', (e) => {
    // Handle reaction clicks via delegation
    if(e.target.classList.contains('msg-reaction')) {
        const msgKey = e.target.dataset.msgkey;
        const emoji = e.target.dataset.emoji.replace(/&apos;/g, "'");
        if(msgKey && emoji) toggleReaction(msgKey, emoji);
        return;
    }
    
    if(!e.target.closest('.msg-context-menu') && !e.target.closest('.msg')) {
        document.getElementById('msg-context-menu').classList.remove('show');
    }
    const picker = document.getElementById('reaction-picker-temp');
    if(picker && !e.target.closest('.reaction-picker')) {
        document.body.removeChild(picker);
    }
});

/* ------------------------------ */
/* MESSAGE EDITING */
/* ------------------------------ */
let editingMessageKey = null;

function startEditingMessage(msgKey, msgText) {
    editingMessageKey = msgKey;
    
    // Fill input with current text
    document.getElementById('msg-input').value = msgText;
    
    // Show edit bar
    const editBar = document.getElementById('edit-mode-bar');
    editBar.classList.add('active');
    document.getElementById('edit-preview').textContent = msgText.substring(0, 50) + (msgText.length > 50 ? '...' : '');
    
    // Hide reply bar if open
    cancelReply();
    
    // Focus input
    document.getElementById('msg-input').focus();
}

window.cancelEdit = () => {
    editingMessageKey = null;
    document.getElementById('edit-mode-bar').classList.remove('active');
    document.getElementById('msg-input').value = '';
};

/* ------------------------------ */
/* FONT SIZE, BUBBLE COLOR & SOUND */
/* ------------------------------ */
function initFontSize() {
    const savedSize = localStorage.getItem('villo_font_size') || '15px';
    document.documentElement.style.setProperty('--msg-font-size', savedSize);
    
    document.querySelectorAll('.font-size-option').forEach(opt => {
        if(opt.dataset.size === savedSize) {
            opt.classList.add('active');
        }
        opt.onclick = () => {
            const size = opt.dataset.size;
            document.documentElement.style.setProperty('--msg-font-size', size);
            localStorage.setItem('villo_font_size', size);
            
            document.querySelectorAll('.font-size-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            
            showNotification(`âœ… SchriftgrÃ¶ÃŸe: ${opt.dataset.name}`, 'success');
        };
    });
}

function initBubbleColor() {
    const savedColor = localStorage.getItem('villo_bubble_color') || '#dcf8c6';
    document.documentElement.style.setProperty('--my-bubble-color', savedColor);
    
    const picker = document.getElementById('my-bubble-color-picker');
    if(picker) {
        picker.value = savedColor;
        picker.oninput = () => {
            const color = picker.value;
            document.documentElement.style.setProperty('--my-bubble-color', color);
            localStorage.setItem('villo_bubble_color', color);
            showNotification('âœ… Bubble-Farbe geÃ¤ndert', 'success');
        };
    }
}

function initSound() {
    const soundEnabled = localStorage.getItem('villo_sound') === 'true';
    const toggle = document.getElementById('sound-toggle');
    if(toggle) {
        toggle.checked = soundEnabled;
        toggle.onchange = () => {
            localStorage.setItem('villo_sound', toggle.checked);
            showNotification(toggle.checked ? 'ğŸ”Š Sound aktiviert' : 'ğŸ”‡ Sound deaktiviert', 'success');
        };
    }
}

function playNotificationSound() {
    const soundEnabled = localStorage.getItem('villo_sound') === 'true';
    if(!soundEnabled) return;
    
    // Simple beep using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch(e) {
        console.error('Sound error:', e);
    }
}

/* ------------------------------ */
/* ================================ */
/* GESCHICHTEN (STORIES)            */
/* ================================ */
const STORY_TTL = 48 * 60 * 60 * 1000; // 48h in ms
let currentStoryUser = null;
let currentStoryList = []; // list of story entries from Firebase (each has slides[])
let currentStoryIndex = 0; // which story entry
let currentSlideIndex = 0; // which slide within the entry
let storyProgressTimer = null;
let storyBg = '#075e54';
let storyType = 'text';
let storyImageData = null;
let storySlides = []; // slides being built in creator
let editingSlideIndex = -1; // -1 = new slide

function initMyStoryBubble() {
    const av = document.getElementById('my-story-avatar');
    if(!av) return;
    const settings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
    const mine = settings[myUsername] || avatarCache[myUsername] || {};
    _applyAvatarToEl(av, myUsername, mine);
    checkMyActiveStory();

    // Mobile long-press for story context menu
    const bubble = document.getElementById('my-story-bubble');
    let _storyLongPress;
    bubble.addEventListener('touchstart', () => { _storyLongPress = setTimeout(openStoryContextMenu, 500); }, { passive: true });
    bubble.addEventListener('touchend', () => clearTimeout(_storyLongPress));
    bubble.addEventListener('touchmove', () => clearTimeout(_storyLongPress));
}

// Helper: apply avatar data to a DOM element directly
function _applyAvatarToEl(el, name, data) {
    if(data && data.type === 'emoji' && data.emoji) {
        el.style.background = data.color || stringToColor(name);
        el.style.fontFamily = '';
        el.style.padding = '';
        el.style.overflow = '';
        el.innerHTML = data.emoji;
        el.style.fontSize = '22px';
    } else if(data && data.type === 'image' && data.image) {
        el.style.background = '#333';
        el.style.padding = '0';
        el.style.overflow = 'hidden';
        el.innerHTML = `<img src="${data.image}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    } else {
        el.style.background = (data && data.color) || stringToColor(name);
        el.style.fontFamily = (data && data.font) || "'Playfair Display', serif";
        el.style.overflow = '';
        el.style.padding = '';
        el.innerHTML = name.charAt(0).toUpperCase();
        el.style.fontSize = '';
    }
}

async function checkMyActiveStory() {
    const snap = await get(ref(db, `stories/${myUsername}`));
    const ring = document.getElementById('my-story-avatar');
    if(!ring) return;
    if(snap.exists()) {
        const active = Object.values(snap.val()).filter(s => Date.now() - s.createdAt < STORY_TTL);
        if(active.length > 0) {
            ring.style.border = '3px solid var(--primary)';
            ring.style.boxShadow = '0 0 0 2px var(--white), 0 0 0 4px var(--primary)';
            return;
        }
    }
    ring.style.border = '3px solid var(--border-color)';
    ring.style.boxShadow = 'none';
}

async function loadContactStories() {
    const contactsList = document.getElementById('contact-stories-list');
    if(!contactsList || !myUsername) return;
    contactsList.innerHTML = '';
    const snap = await get(ref(db, `accounts/${myUsername}/contacts`));
    if(!snap.exists()) return;
    const contacts = Object.values(snap.val()).filter(Boolean);
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');

    for(const contact of contacts) {
        const storySnap = await get(ref(db, `stories/${contact}`));
        if(!storySnap.exists()) continue;
        const entries = Object.entries(storySnap.val())
            .map(([k,v]) => ({...v, key:k}))
            .filter(s => Date.now() - s.createdAt < STORY_TTL);
        if(entries.length === 0) continue;

        const s = avatarSettings[contact] || {};
        const bubble = document.createElement('div');
        bubble.className = 'story-bubble has-story';
        bubble.onclick = () => openStoryViewer(contact, entries);
        const ring = document.createElement('div');
        ring.className = 'story-ring';
        ring.style.background = s.color || stringToColor(contact);
        ring.style.fontFamily = s.font || "'Playfair Display', serif";
        ring.textContent = contact.charAt(0).toUpperCase();
        const label = document.createElement('span');
        label.className = 'story-name';
        label.textContent = aliases[contact] || contact;
        bubble.appendChild(ring);
        bubble.appendChild(label);
        contactsList.appendChild(bubble);
    }
}

window.openMyStoryOrCreate = async () => {
    const snap = await get(ref(db, `stories/${myUsername}`));
    const active = snap.exists()
        ? Object.entries(snap.val()).map(([k,v])=>({...v,key:k})).filter(s => Date.now()-s.createdAt < STORY_TTL)
        : [];
    if(active.length > 0) openStoryViewer(myUsername, active);
    else openStoryCreate();
};

window.openStoryCreate = function openStoryCreate() {
    storyBg = '#075e54';
    storyType = 'text';
    storyImageData = null;
    storySlides = [];
    editingSlideIndex = -1;
    document.getElementById('story-text-input').value = '';
    if(document.getElementById('story-emoji-input')) document.getElementById('story-emoji-input').value = '';
    document.getElementById('story-preview-img').style.display = 'none';
    document.getElementById('story-preview').style.background = storyBg;
    document.getElementById('story-preview-text').textContent = '';
    setStoryType('text');
    renderSlidesStrip();
    const overlay = document.getElementById('story-create-overlay');
    overlay.style.display = 'flex';
    // Also ensure the modal inside gets flex layout
    const modal = overlay.querySelector('.modal');
    if(modal) modal.style.display = 'flex';
}

window.setStoryType = (type) => {
    storyType = type;
    storyImageData = null;
    document.getElementById('story-preview-img').style.display = 'none';
    document.getElementById('story-preview').style.background = storyBg;
    ['text','emoji','image'].forEach(t => {
        document.getElementById(`story-${t}-section`).style.display = t === type ? 'block' : 'none';
        const btn = document.getElementById(`story-type-${t}`);
        btn.style.background = t === type ? 'var(--primary)' : 'var(--bg)';
        btn.style.color = t === type ? 'white' : 'var(--text-color)';
        btn.style.border = t === type ? 'none' : '1px solid var(--border-color)';
    });
    updateStoryPreview();
};

window.setStoryBg = (color) => {
    storyBg = color;
    document.getElementById('story-preview').style.background = color;
    document.querySelectorAll('[data-story-color]').forEach(el => {
        el.style.border = el.dataset.storyColor === color ? '2px solid white' : '2px solid transparent';
    });
};

window.updateStoryPreview = () => {
    const previewText = document.getElementById('story-preview-text');
    const fontPicker = document.getElementById('story-font-picker');
    if(storyType === 'text') {
        previewText.textContent = document.getElementById('story-text-input').value;
        if(fontPicker) previewText.style.fontFamily = fontPicker.value;
    } else if(storyType === 'emoji') {
        const val = document.getElementById('story-emoji-input').value;
        const display = document.getElementById('story-emoji-display');
        if(display) display.textContent = val || 'ğŸ˜Š';
        previewText.textContent = val;
        previewText.style.fontFamily = '';
    } else {
        previewText.textContent = storyImageData ? '' : 'ğŸ–¼ï¸';
    }
};

document.getElementById('story-img-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    e.target.value = '';
    if(!file) return;
    if(file.size > 500 * 1024) { showNotification('âš ï¸ Bild zu groÃŸ (max. 500 KB)', 'warning'); return; }
    storyImageData = await compressImage(file, 500 * 1024);
    const img = document.getElementById('story-preview-img');
    img.src = storyImageData;
    img.style.display = 'block';
    document.getElementById('story-preview-text').textContent = '';
    document.getElementById('story-preview').style.background = '#000';
});

window.saveCurrentSlide = () => {
    let content = '';
    if(storyType === 'text') content = document.getElementById('story-text-input').value.trim();
    else if(storyType === 'emoji') content = document.getElementById('story-emoji-input').value.trim();
    else content = storyImageData || '';
    if(!content) { showNotification('âš ï¸ Bitte Inhalt hinzufÃ¼gen', 'warning'); return; }

    const slide = { type: storyType, content, bg: storyType === 'image' ? '#000' : storyBg, font: storyType === 'text' ? (document.getElementById('story-font-picker')?.value || '') : '' };
    if(editingSlideIndex >= 0) {
        storySlides[editingSlideIndex] = slide;
        editingSlideIndex = -1;
    } else {
        storySlides.push(slide);
    }
    // Reset current input for next slide
    document.getElementById('story-text-input').value = '';
    if(document.getElementById('story-emoji-input')) document.getElementById('story-emoji-input').value = '';
    storyImageData = null;
    document.getElementById('story-preview-img').style.display = 'none';
    document.getElementById('story-preview-text').textContent = '';
    document.getElementById('story-preview').style.background = storyBg;
    renderSlidesStrip();
    showNotification(`âœ… Slide ${storySlides.length} gespeichert`, 'success');
};

window.addStorySlide = () => {
    if(storySlides.length >= 15) { showNotification('âš ï¸ Maximal 15 Slides', 'warning'); return; }
    editingSlideIndex = -1;
    document.getElementById('story-text-input').value = '';
    if(document.getElementById('story-emoji-input')) document.getElementById('story-emoji-input').value = '';
    storyImageData = null;
    document.getElementById('story-preview-img').style.display = 'none';
    document.getElementById('story-preview-text').textContent = 'Neuer Slide...';
    document.getElementById('story-preview').style.background = storyBg;
};

function renderSlidesStrip() {
    const strip = document.getElementById('story-slides-strip');
    const counter = document.getElementById('story-slide-counter');
    const addBtn = document.getElementById('story-add-slide-btn');
    strip.innerHTML = '';
    storySlides.forEach((slide, i) => {
        const thumb = document.createElement('div');
        thumb.style.cssText = `width:44px;height:60px;border-radius:8px;background:${slide.bg};display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;flex-shrink:0;border:2px solid ${editingSlideIndex===i?'var(--primary)':'transparent'};overflow:hidden;`;
        if(slide.type === 'image') {
            const img = document.createElement('img');
            img.src = slide.content;
            img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
            thumb.appendChild(img);
        } else {
            thumb.style.fontSize = slide.type === 'emoji' ? '22px' : '9px';
            thumb.style.color = 'white';
            thumb.style.textAlign = 'center';
            thumb.style.padding = '2px';
            thumb.style.wordBreak = 'break-word';
            thumb.textContent = slide.content.substring(0, slide.type==='emoji'?2:30);
        }
        // Number badge
        const badge = document.createElement('div');
        badge.style.cssText = 'position:absolute;top:2px;left:2px;background:rgba(0,0,0,0.5);color:white;font-size:9px;border-radius:4px;padding:1px 3px;';
        badge.textContent = i + 1;
        thumb.appendChild(badge);
        // Delete button
        const del = document.createElement('div');
        del.style.cssText = 'position:absolute;top:2px;right:2px;background:rgba(220,53,69,0.85);color:white;font-size:10px;border-radius:50%;width:14px;height:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;';
        del.textContent = 'âœ•';
        del.onclick = (e) => { e.stopPropagation(); storySlides.splice(i,1); renderSlidesStrip(); };
        thumb.appendChild(del);
        // Click to edit
        thumb.onclick = (e) => {
            if(e.target === del) return;
            editingSlideIndex = i;
            const s = storySlides[i];
            setStoryType(s.type);
            storyBg = s.bg;
            document.getElementById('story-preview').style.background = s.bg;
            if(s.type === 'text') {
                document.getElementById('story-text-input').value = s.content;
                const fp = document.getElementById('story-font-picker');
                if(fp && s.font) fp.value = s.font;
            }
            else if(s.type === 'emoji') { document.getElementById('story-emoji-input').value = s.content; }
            else { storyImageData = s.content; document.getElementById('story-preview-img').src = s.content; document.getElementById('story-preview-img').style.display='block'; }
            updateStoryPreview();
            renderSlidesStrip();
        };
        strip.appendChild(thumb);
    });
    counter.textContent = `${storySlides.length} / 15 Slides`;
    addBtn.style.display = storySlides.length >= 15 ? 'none' : 'flex';
}

window.publishStory = async () => {
    // Auto-save current input as a slide if there's content
    let content = '';
    if(storyType === 'text') content = document.getElementById('story-text-input').value.trim();
    else if(storyType === 'emoji') content = document.getElementById('story-emoji-input').value.trim();
    else content = storyImageData || '';
    const font = storyType === 'text' ? (document.getElementById('story-font-picker')?.value || '') : '';
    if(content && editingSlideIndex < 0) {
        storySlides.push({ type: storyType, content, bg: storyType === 'image' ? '#000' : storyBg, font });
    } else if(content && editingSlideIndex >= 0) {
        storySlides[editingSlideIndex] = { type: storyType, content, bg: storyType === 'image' ? '#000' : storyBg, font };
    }
    if(storySlides.length === 0) { showNotification('âš ï¸ Mindestens 1 Slide hinzufÃ¼gen', 'warning'); return; }

    await push(ref(db, `stories/${myUsername}`), {
        slides: storySlides,
        createdAt: Date.now(),
        author: myUsername
    });
    closeOverlay('story-create-overlay');
    showNotification(`âœ… Geschichte mit ${storySlides.length} Slide(s) verÃ¶ffentlicht!`, 'success');
    checkMyActiveStory();
    loadContactStories();
};

function buildViewerProgressBars() {
    const container = document.getElementById('story-progress-bars');
    container.innerHTML = '';
    currentStoryList.forEach((_, i) => {
        const bar = document.createElement('div');
        bar.style.cssText = 'flex:1; height:3px; background:rgba(255,255,255,0.3); border-radius:2px; overflow:hidden;';
        const fill = document.createElement('div');
        fill.id = `story-bar-fill-${i}`;
        fill.style.cssText = 'height:100%; background:white; width:0%; border-radius:2px;';
        bar.appendChild(fill);
        container.appendChild(bar);
    });
}

function openStoryViewer(username, entries) {
    currentStoryUser = username;
    // Flatten entries â†’ slides for sequential viewing
    currentStoryList = [];
    entries.sort((a,b) => a.createdAt - b.createdAt).forEach(entry => {
        const slides = entry.slides || [{ type: entry.type, content: entry.content, bg: entry.bg }];
        slides.forEach((slide) => {
            currentStoryList.push({ ...slide, key: entry.key, createdAt: entry.createdAt });
        });
    });
    currentSlideIndex = 0;
    buildViewerProgressBars();
    document.getElementById('story-viewer-overlay').classList.add('show');
    renderCurrentStory();
}

function renderCurrentStory() {
    const s = currentStoryList[currentSlideIndex];
    if(!s) { closeStoryViewer(); return; }

    const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
    const settings = avatarSettings[currentStoryUser] || {};
    const avEl = document.getElementById('viewer-avatar');
    avEl.style.background = settings.color || stringToColor(currentStoryUser);
    avEl.textContent = currentStoryUser.charAt(0).toUpperCase();
    document.getElementById('viewer-username').textContent = currentStoryUser;
    const h = Math.floor((Date.now() - s.createdAt) / 3600000);
    document.getElementById('viewer-time').textContent = h < 1 ? 'Gerade eben' : `vor ${h}h`;

    const deleteBtn = document.getElementById('viewer-delete-btn');
    const addBtn = document.getElementById('viewer-add-btn');
    const closeX = document.getElementById('viewer-close-x');
    const reactionsBar = document.getElementById('story-reactions-bar');
    const isOwn = currentStoryUser === myUsername;
    deleteBtn.style.display = isOwn ? 'inline' : 'none';
    addBtn.style.display = isOwn ? 'inline' : 'none';
    closeX.style.marginLeft = isOwn ? '4px' : 'auto';
    reactionsBar.style.display = isOwn ? 'none' : 'flex';
    deleteBtn.dataset.storyKey = s.key;

    const img = document.getElementById('viewer-img');
    const txt = document.getElementById('viewer-text');
    const content = document.getElementById('story-viewer-content');
    if(s.type === 'image') {
        img.src = s.content; img.style.display = 'block';
        txt.textContent = ''; content.style.background = '#000';
    } else {
        img.style.display = 'none';
        txt.textContent = s.content;
        txt.style.fontFamily = s.font || "'Playfair Display', serif";
        content.style.background = s.bg || '#075e54';
        txt.style.fontSize = s.type === 'emoji' ? '80px' : '28px';
    }

    // Progress bars
    clearTimeout(storyProgressTimer);
    // Mark past bars as full, current animating, future as empty
    currentStoryList.forEach((_, i) => {
        const fill = document.getElementById(`story-bar-fill-${i}`);
        if(!fill) return;
        fill.style.transition = 'none';
        fill.style.width = i < currentSlideIndex ? '100%' : '0%';
    });
    const currentFill = document.getElementById(`story-bar-fill-${currentSlideIndex}`);
    if(currentFill) {
        requestAnimationFrame(() => {
            currentFill.style.transition = 'width 5s linear';
            currentFill.style.width = '100%';
        });
    }
    storyProgressTimer = setTimeout(() => navigateStory(1), 5000);

    if(!isOwn) {
        document.getElementById('story-reactions-display').textContent = '';
        loadStoryReactions(s);
    }
}

window.navigateStory = (dir) => {
    clearTimeout(storyProgressTimer);
    currentSlideIndex += dir;
    if(currentSlideIndex < 0) currentSlideIndex = 0;
    if(currentSlideIndex >= currentStoryList.length) { closeStoryViewer(); return; }
    renderCurrentStory();
};

window.closeStoryViewer = () => {
    clearTimeout(storyProgressTimer);
    document.getElementById('story-viewer-overlay').classList.remove('show');
};

window.reactToStory = async (emoji) => {
    const s = currentStoryList[currentSlideIndex];
    if(!s) return;
    // Send reaction as a chat message to the story author
    const chatId = myUsername < currentStoryUser
        ? `${myUsername}_${currentStoryUser}`
        : `${currentStoryUser}_${myUsername}`;
    await push(ref(db, `chats/${chatId}`), {
        sender: myUsername,
        text: `${emoji} auf deine Geschichte reagiert`,
        timestamp: Date.now(),
        read: false,
        isStoryReaction: true
    });
    // Save reaction to story
    await update(ref(db, `stories/${currentStoryUser}/${s.key}/reactions`), { [myUsername]: emoji });
    showNotification(`${emoji} Reaktion gesendet!`, 'success');
    loadStoryReactions(s);
};

async function loadStoryReactions(s) {
    const snap = await get(ref(db, `stories/${currentStoryUser}/${s.key}/reactions`));
    const display = document.getElementById('story-reactions-display');
    if(!snap.exists() || !display) return;
    const reactions = snap.val();
    const counts = {};
    Object.values(reactions).forEach(e => counts[e] = (counts[e]||0)+1);
    display.textContent = Object.entries(counts).map(([e,c]) => `${e} ${c}`).join('  ');
}


window.deleteMyStory = async () => {
    const key = document.getElementById('viewer-delete-btn').dataset.storyKey;
    await remove(ref(db, `stories/${myUsername}/${key}`));
    showNotification('ğŸ—‘ï¸ Geschichte gelÃ¶scht', 'success');
    closeStoryViewer();
    checkMyActiveStory();
    loadContactStories();
};

window.saveGroupAddPrivacy = async () => {
    const val = document.getElementById('group-add-privacy-select').value;
    await set(ref(db, `accounts/${myUsername}/groupAddPrivacy`), val);
    localStorage.setItem('group_add_privacy', val);
    showNotification('âœ… Einstellung gespeichert', 'success');
};

async function loadGroupAddPrivacySetting() {
    const saved = localStorage.getItem('group_add_privacy')
        || (await get(ref(db, `accounts/${myUsername}/groupAddPrivacy`))).val()
        || 'all';
    const el = document.getElementById('group-add-privacy-select');
    if(el) el.value = saved;
}


let _storyVisibilityContacts = []; // selected contacts for except/only

window.onStoryVisibilityChange = () => {
    const val = document.getElementById('story-visibility-select').value;
    const picker = document.getElementById('story-visibility-picker');
    const label = document.getElementById('story-visibility-picker-label');
    if(val === 'except' || val === 'only') {
        picker.style.display = 'block';
        label.textContent = val === 'except' ? 'Ausgenommene Kontakte:' : 'Sichtbar fÃ¼r:';
    } else {
        picker.style.display = 'none';
    }
};

window.searchStoryVisibilityContact = async () => {
    const q = document.getElementById('story-visibility-search').value.trim().toLowerCase();
    const results = document.getElementById('story-visibility-results');
    results.innerHTML = '';
    if(!q) return;
    const snap = await get(ref(db, `accounts/${myUsername}/contacts`));
    if(!snap.exists()) return;
    const contacts = Object.values(snap.val()).filter(Boolean);
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    contacts
        .filter(c => (c.toLowerCase().includes(q) || (aliases[c]||'').toLowerCase().includes(q)) && !_storyVisibilityContacts.includes(c))
        .slice(0, 8)
        .forEach(c => {
            const chip = document.createElement('div');
            chip.style.cssText = 'padding:4px 10px; background:var(--primary); color:white; border-radius:16px; font-size:12px; cursor:pointer;';
            chip.textContent = aliases[c] || c;
            chip.onclick = () => {
                _storyVisibilityContacts.push(c);
                document.getElementById('story-visibility-search').value = '';
                results.innerHTML = '';
                renderVisibilityChips();
            };
            results.appendChild(chip);
        });
};

function renderVisibilityChips() {
    const list = document.getElementById('story-visibility-contact-list');
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    list.innerHTML = '';
    _storyVisibilityContacts.forEach((c, i) => {
        const chip = document.createElement('div');
        chip.style.cssText = 'display:flex; align-items:center; gap:4px; padding:3px 8px; background:var(--primary); color:white; border-radius:16px; font-size:12px;';
        chip.innerHTML = `${aliases[c]||c} <span style="cursor:pointer; opacity:0.8;" onclick="removeVisibilityContact(${i})">âœ•</span>`;
        list.appendChild(chip);
    });
}

window.removeVisibilityContact = (i) => {
    _storyVisibilityContacts.splice(i, 1);
    renderVisibilityChips();
};

window.saveStoryVisibility = async () => {
    const val = document.getElementById('story-visibility-select').value;
    const data = { mode: val, contacts: (val === 'except' || val === 'only') ? _storyVisibilityContacts : [] };
    await set(ref(db, `accounts/${myUsername}/storyVisibility`), data);
    localStorage.setItem('story_visibility', JSON.stringify(data));
    showNotification('âœ… Sichtbarkeit gespeichert', 'success');
};

// Load saved visibility when opening settings security tab
async function loadStoryVisibilitySettings() {
    const saved = JSON.parse(localStorage.getItem('story_visibility') || 'null')
        || (await get(ref(db, `accounts/${myUsername}/storyVisibility`))).val()
        || { mode: 'all', contacts: [] };
    document.getElementById('story-visibility-select').value = saved.mode || 'all';
    _storyVisibilityContacts = saved.contacts || [];
    onStoryVisibilityChange();
    renderVisibilityChips();
}

// Check if a contact can see my stories
async function canContactSeeMyStories(contact) {
    const saved = JSON.parse(localStorage.getItem('story_visibility') || 'null')
        || { mode: 'all', contacts: [] };
    if(saved.mode === 'none') return false;
    if(saved.mode === 'all') return true;
    if(saved.mode === 'except') return !saved.contacts.includes(contact);
    if(saved.mode === 'only') return saved.contacts.includes(contact);
    return true;
}


/* ------------------------------ */
/* QR LOGIN PDF GENERATOR         */
/* ------------------------------ */
window.openQrPinDialog = () => {
    document.getElementById('qr-pin-input').value = '';
    document.getElementById('qr-pin-error').textContent = '';
    document.getElementById('qr-pin-overlay').style.display = 'flex';
};

window.generateLoginQR = async () => {
    const pinInput = document.getElementById('qr-pin-input').value.trim();
    const errEl = document.getElementById('qr-pin-error');
    errEl.textContent = '';
    if(!pinInput) { errEl.textContent = 'Bitte PIN eingeben.'; return; }

    // Verify PIN against Firebase
    const pinSnap = await get(ref(db, `accounts/${myUsername}/pin`));
    if(!pinSnap.exists() || pinSnap.val() !== pinInput) {
        errEl.textContent = 'âŒ Falscher PIN.';
        return;
    }

    closeOverlay('qr-pin-overlay');
    showNotification('â³ PDF wird erstellt...', 'success');

    // Build login URL
    const baseUrl = window.location.href.split('?')[0];
    const loginUrl = `${baseUrl}?login&name=${encodeURIComponent(myUsername)}&pw=${encodeURIComponent(pinInput)}`;

    // Render QR code to canvas off-screen
    const qrContainer = document.createElement('div');
    qrContainer.style.cssText = 'position:fixed;left:-9999px;top:-9999px;';
    document.body.appendChild(qrContainer);
    await new Promise(resolve => {
        new QRCode(qrContainer, { text: loginUrl, width: 256, height: 256, colorDark: '#000000', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
        setTimeout(resolve, 350);
    });
    const qrCanvas = qrContainer.querySelector('canvas');
    const qrDataUrl = qrCanvas ? qrCanvas.toDataURL('image/png') : null;
    document.body.removeChild(qrContainer);

    // Build PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pageW = 210, pageH = 297, margin = 20;

    // Header
    doc.setFillColor(7, 94, 84);
    doc.rect(0, 0, pageW, 34, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24); doc.setFont('helvetica', 'bold');
    doc.text('VilloChat', margin, 21);
    doc.setFontSize(11); doc.setFont('helvetica', 'normal');
    doc.text('Anmelde-QR-Code', margin, 29);

    // Info box
    doc.setTextColor(30, 30, 30);
    const boxY = 46;
    doc.setFillColor(245, 247, 246);
    doc.roundedRect(margin, boxY, pageW - margin * 2, 46, 4, 4, 'F');
    const labelX = margin + 6, valX = margin + 50;
    doc.setFontSize(11);
    [['Benutzername:', myUsername, 13], ['PIN:', pinInput, 25], ['Erstellt:', new Date().toLocaleString('de-DE'), 37]].forEach(([label, val, dy]) => {
        doc.setFont('helvetica', 'bold'); doc.text(label, labelX, boxY + dy);
        doc.setFont('helvetica', 'normal'); doc.text(val, valX, boxY + dy);
    });

    // QR Code
    const qrSize = 88, qrX = (pageW - qrSize) / 2, qrY = boxY + 58;
    doc.setFillColor(255, 255, 255); doc.setDrawColor(220, 220, 220);
    doc.roundedRect(qrX - 5, qrY - 5, qrSize + 10, qrSize + 10, 4, 4, 'FD');
    if(qrDataUrl) doc.addImage(qrDataUrl, 'PNG', qrX, qrY, qrSize, qrSize);
    doc.setFontSize(10); doc.setTextColor(100, 100, 100); doc.setFont('helvetica', 'normal');
    doc.text('Mit Kamera scannen zum automatischen Einloggen', pageW / 2, qrY + qrSize + 9, { align: 'center' });

    // URL
    doc.setFontSize(7); doc.setTextColor(160, 160, 160);
    const urlLines = doc.splitTextToSize(loginUrl, pageW - margin * 2);
    const urlY = qrY + qrSize + 16;
    doc.text(urlLines, margin, urlY);

    // Warning
    const warnY = urlY + urlLines.length * 3.5 + 8;
    doc.setFillColor(255, 243, 205); doc.setDrawColor(255, 193, 7);
    doc.roundedRect(margin, warnY, pageW - margin * 2, 20, 3, 3, 'FD');
    doc.setFontSize(8.5); doc.setTextColor(120, 85, 0);
    doc.setFont('helvetica', 'bold'); doc.text('âš   Sicherheitshinweis', margin + 5, warnY + 7);
    doc.setFont('helvetica', 'normal');
    doc.text('Dieses Dokument enthÃ¤lt deine Zugangsdaten. Bewahre es sicher auf und teile es nicht.', margin + 5, warnY + 14, { maxWidth: pageW - margin * 2 - 10 });

    // Footer
    doc.setFontSize(8); doc.setTextColor(190, 190, 190);
    doc.text(`VilloChat v5.6  Â·  ${new Date().toLocaleDateString('de-DE')}`, pageW / 2, pageH - 10, { align: 'center' });

    doc.save(`VilloChat_Login_${myUsername}.pdf`);
    showNotification('âœ… PDF heruntergeladen!', 'success');
};

let _storyCtxEntries = [];

window.openStoryContextMenu = async () => {
    const snap = await get(ref(db, `stories/${myUsername}`));
    _storyCtxEntries = snap.exists()
        ? Object.entries(snap.val()).map(([k,v])=>({...v,key:k})).filter(s=>Date.now()-s.createdAt < STORY_TTL)
        : [];

    const list = document.getElementById('story-ctx-slides-list');
    list.innerHTML = '';

    if(_storyCtxEntries.length === 0) {
        list.innerHTML = '<div style="text-align:center; opacity:0.5; padding:12px;">Keine aktiven Geschichten</div>';
    } else {
        _storyCtxEntries.forEach((entry, ei) => {
            const slides = entry.slides || [{ type: entry.type, content: entry.content, bg: entry.bg }];
            slides.forEach((slide, si) => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; gap:10px; padding:8px; border-radius:8px; margin-bottom:4px; background:var(--bg);';

                // Thumbnail
                const thumb = document.createElement('div');
                thumb.style.cssText = `width:36px; height:48px; border-radius:6px; background:${slide.bg||'#075e54'}; flex-shrink:0; display:flex; align-items:center; justify-content:center; overflow:hidden; font-size:${slide.type==='emoji'?'20px':'9px'}; color:white; text-align:center; word-break:break-word;`;
                if(slide.type === 'image') {
                    thumb.innerHTML = `<img src="${slide.content}" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    thumb.textContent = slide.content.substring(0, slide.type==='emoji'?2:20);
                }

                // Label
                const label = document.createElement('div');
                label.style.cssText = 'flex:1; font-size:13px;';
                label.textContent = `Slide ${si+1}${slides.length>1?` / ${slides.length}`:''}`;

                // Delete button
                const del = document.createElement('button');
                del.style.cssText = 'background:#dc3545; color:white; border:none; border-radius:6px; padding:4px 10px; font-size:12px; cursor:pointer;';
                del.textContent = 'ğŸ—‘ï¸';
                del.onclick = async () => {
                    if(slides.length === 1) {
                        // Delete entire entry
                        await remove(ref(db, `stories/${myUsername}/${entry.key}`));
                    } else {
                        // Remove just this slide from entry
                        const newSlides = slides.filter((_,i)=>i!==si);
                        await set(ref(db, `stories/${myUsername}/${entry.key}/slides`), newSlides);
                    }
                    showNotification('ğŸ—‘ï¸ Slide gelÃ¶scht', 'success');
                    closeOverlay('story-ctx-overlay');
                    checkMyActiveStory();
                    loadContactStories();
                };

                row.appendChild(thumb);
                row.appendChild(label);
                row.appendChild(del);
                list.appendChild(row);
            });
        });
    }
    document.getElementById('story-ctx-overlay').style.display = 'flex';
};

window.deleteAllMyStories = async () => {
    await remove(ref(db, `stories/${myUsername}`));
    showNotification('ğŸ—‘ï¸ Alle Geschichten gelÃ¶scht', 'success');
    closeOverlay('story-ctx-overlay');
    checkMyActiveStory();
    loadContactStories();
};

/* ----- Avatar type picker ----- */
let currentAvatarType = 'letter';
let avatarImageData = null;

window.setAvatarType = (type) => {
    currentAvatarType = type;
    ['letter','emoji','image'].forEach(t => {
        document.getElementById(`avs-${t}`).style.display = t === type ? 'block' : 'none';
        const btn = document.getElementById(`avtype-${t}`);
        btn.style.background = t === type ? 'var(--primary)' : 'var(--bg)';
        btn.style.color = t === type ? 'white' : 'var(--text-color)';
        btn.style.border = t === type ? 'none' : '1px solid var(--border-color)';
    });
};

// Bind avatar image input
document.getElementById('avatar-img-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    e.target.value = '';
    if(!file) return;
    avatarImageData = await compressImage(file, 200 * 1024);
    document.getElementById('avatar-img-preview').style.display = 'block';
    document.getElementById('avatar-img-preview-img').src = avatarImageData;
    // Update big preview
    const preview = document.getElementById('settings-avatar-preview');
    if(preview) {
        preview.style.background = '#333';
        preview.innerHTML = `<img src="${avatarImageData}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    }
});

// Bind avatar emoji input live preview
document.getElementById('my-avatar-emoji-input').addEventListener('input', () => {
    const val = document.getElementById('my-avatar-emoji-input').value || 'ğŸ˜';
    document.getElementById('avatar-emoji-display').textContent = val;
    const preview = document.getElementById('settings-avatar-preview');
    if(preview && currentAvatarType === 'emoji') {
        preview.textContent = val;
        preview.style.background = document.getElementById('my-avatar-color-picker-emoji').value;
        preview.style.fontSize = '40px';
    }
});

document.getElementById('my-avatar-color-picker-emoji').addEventListener('input', () => {
    const preview = document.getElementById('settings-avatar-preview');
    if(preview && currentAvatarType === 'emoji') preview.style.background = document.getElementById('my-avatar-color-picker-emoji').value;
});


/* ------------------------------ */
function getScheduledMsgs() {
    return JSON.parse(localStorage.getItem('villo_scheduled') || '[]');
}
function saveScheduledMsgs(arr) {
    localStorage.setItem('villo_scheduled', JSON.stringify(arr));
}

window.openScheduled = () => {
    if(!activeChatId) { showNotification('âš ï¸ Kein Chat geÃ¶ffnet!', 'warning'); return; }
    toggleChatMenu();
    // Set minimum time to now+1min
    const min = new Date(Date.now() + 60000);
    min.setSeconds(0, 0);
    document.getElementById('scheduled-time').min = min.toISOString().slice(0,16);
    document.getElementById('scheduled-time').value = '';
    document.getElementById('scheduled-text').value = '';
    renderScheduledList();
    document.getElementById('scheduled-overlay').style.display = 'flex';
};

window.saveScheduledMsg = () => {
    const text = document.getElementById('scheduled-text').value.trim();
    const timeVal = document.getElementById('scheduled-time').value;
    if(!text) { showNotification('âŒ Bitte Nachricht eingeben', 'error'); return; }
    if(!timeVal) { showNotification('âŒ Bitte Zeit auswÃ¤hlen', 'error'); return; }
    const sendAt = new Date(timeVal).getTime();
    if(sendAt <= Date.now()) { showNotification('âŒ Zeit muss in der Zukunft liegen', 'error'); return; }

    const msgs = getScheduledMsgs();
    msgs.push({ id: Date.now(), chatId: activeChatId, chatName: activeContactName || activeChatId, text, sendAt });
    saveScheduledMsgs(msgs);
    document.getElementById('scheduled-text').value = '';
    document.getElementById('scheduled-time').value = '';
    showNotification('âœ… Nachricht geplant', 'success');
    renderScheduledList();
};

function renderScheduledList() {
    const msgs = getScheduledMsgs().filter(m => m.chatId === activeChatId).sort((a,b) => a.sendAt - b.sendAt);
    const list = document.getElementById('scheduled-list');
    if(!list) return;
    if(msgs.length === 0) {
        list.innerHTML = '<p style="opacity:0.5; text-align:center; padding:10px; font-size:13px;">Keine geplanten Nachrichten</p>';
        return;
    }
    list.innerHTML = '<div style="font-weight:600; font-size:13px; margin-bottom:8px; opacity:0.6;">GEPLANT</div>';
    msgs.forEach(m => {
        const d = document.createElement('div');
        d.style.cssText = 'padding:10px; background:var(--bg); border-radius:10px; margin-bottom:8px; display:flex; gap:10px; align-items:flex-start;';
        d.innerHTML = `
            <div style="flex:1; min-width:0;">
                <div style="font-size:13px; word-break:break-word;">${m.text.substring(0,120)}${m.text.length>120?'...':''}</div>
                <div style="font-size:11px; opacity:0.5; margin-top:4px;">ğŸ• ${new Date(m.sendAt).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
            </div>
            <span style="cursor:pointer; color:#dc3545; font-size:18px; flex-shrink:0;" onclick="deleteScheduledMsg(${m.id})">âœ•</span>
        `;
        list.appendChild(d);
    });
}

window.deleteScheduledMsg = (id) => {
    const msgs = getScheduledMsgs().filter(m => m.id !== id);
    saveScheduledMsgs(msgs);
    renderScheduledList();
    showNotification('ğŸ—‘ï¸ Geplante Nachricht gelÃ¶scht', 'success');
};

// Scheduler tick â€” checks every 30s for messages to send
function startSchedulerTick() {
    setInterval(() => {
        const now = Date.now();
        let msgs = getScheduledMsgs();
        const due = msgs.filter(m => m.sendAt <= now);
        if(due.length === 0) return;
        due.forEach(m => {
            push(ref(db, `chats/${m.chatId}`), {
                sender: myUsername, text: m.text, timestamp: now, read: false
            });
            showNotification(`ğŸ“¨ Geplante Nachricht gesendet`, 'success');
        });
        saveScheduledMsgs(msgs.filter(m => m.sendAt > now));
    }, 30000);
}


function pinMessage(msgKey, msgText) {
    if(!activeChatId) return;
    const pinnedKey = `pinned_${activeChatId}`;
    localStorage.setItem(pinnedKey, msgKey);
    localStorage.setItem(`${pinnedKey}_text`, msgText);
    
    // Also save to Firebase so both users see it
    set(ref(db, `chats/${activeChatId}/_pinned`), { msgKey, text: msgText, pinnedBy: myUsername, pinnedAt: Date.now() });
    
    showPinnedBar(msgKey, msgText);
    showNotification('ğŸ“Œ Nachricht angeheftet', 'success');
}

window.unpinMessage = () => {
    if(!activeChatId) return;
    const pinnedKey = `pinned_${activeChatId}`;
    localStorage.removeItem(pinnedKey);
    localStorage.removeItem(`${pinnedKey}_text`);
    
    remove(ref(db, `chats/${activeChatId}/_pinned`));
    
    const bar = document.getElementById('pinned-msg-bar');
    bar.classList.remove('visible');
    
    // Remove pinned highlight
    document.querySelectorAll('.msg.pinned-msg').forEach(el => el.classList.remove('pinned-msg'));
    showNotification('ğŸ“Œ Nachricht losgelÃ¶st', 'success');
};

function showPinnedBar(msgKey, text) {
    const bar = document.getElementById('pinned-msg-bar');
    document.getElementById('pinned-msg-text').textContent = text.replace(/[*_`~]/g, '').substring(0, 80);
    bar._pinnedKey = msgKey;
    bar.classList.add('visible');
    
    // Highlight the pinned message
    document.querySelectorAll('.msg').forEach(el => el.classList.remove('pinned-msg'));
    const pinnedEl = document.getElementById(`m-${msgKey}`);
    if(pinnedEl) pinnedEl.classList.add('pinned-msg');
}

window.scrollToPinned = () => {
    const bar = document.getElementById('pinned-msg-bar');
    const msgKey = bar._pinnedKey;
    if(!msgKey) return;
    const el = document.getElementById(`m-${msgKey}`);
    if(el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.outline = '2px solid var(--primary)';
        setTimeout(() => el.style.outline = '', 2000);
    }
};

function loadPinnedMessage() {
    if(!activeChatId) return;
    // Listen to Firebase for pin
    get(ref(db, `chats/${activeChatId}/_pinned`)).then(snap => {
        if(snap.exists()) {
            const d = snap.val();
            showPinnedBar(d.msgKey, d.text);
        } else {
            const bar = document.getElementById('pinned-msg-bar');
            if(bar) bar.classList.remove('visible');
        }
    });
}

/* ------------------------------ */
/* DELETE FOR ALL */
/* ------------------------------ */
window.deleteMsgForAll = (mid) => {
    if(!activeChatId) return;
    document.getElementById('confirm-text').innerText = "Nachricht fÃ¼r alle lÃ¶schen? (kann nicht rÃ¼ckgÃ¤ngig gemacht werden)";
    document.getElementById('confirm-overlay').style.display = 'flex';

    const yesBtn = document.getElementById('confirm-yes');
    yesBtn.replaceWith(yesBtn.cloneNode(true));
    const newYes = document.getElementById('confirm-yes');
    newYes.onclick = async () => {
        await update(ref(db, `chats/${activeChatId}/${mid}`), {
            text: '',
            deletedForAll: true,
            deletedAt: Date.now()
        });
        // If this was the pinned message, unpin it too
        const pinnedKey = `pinned_${activeChatId}`;
        if(localStorage.getItem(pinnedKey) === mid) {
            unpinMessage();
        }
        closeOverlay('confirm-overlay');
        showNotification('âœ… Nachricht fÃ¼r alle gelÃ¶scht', 'success');
    };
};

/* ------------------------------ */
/* MY PROFILE */
/* ------------------------------ */
window.openMyProfile = async () => {
    document.getElementById('my-profile-overlay').style.display = 'flex';
    
    const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
    const mySettings = avatarSettings[myUsername] || {};
    const myColor = mySettings.color || (window.avatarCache && window.avatarCache[myUsername]?.color) || stringToColor(myUsername);
    const myFont = mySettings.font || "'Playfair Display', serif";
    
    const avatarEl = document.getElementById('my-profile-avatar');
    avatarEl.style.background = myColor;
    avatarEl.style.fontFamily = myFont;
    avatarEl.textContent = myUsername.charAt(0).toUpperCase();
    
    document.getElementById('my-profile-name').textContent = myUsername;
    
    // Status
    const savedStatus = localStorage.getItem('villo_status') || '';
    document.getElementById('my-profile-status').textContent = savedStatus ? `ğŸ’¬ "${savedStatus}"` : 'Kein Status gesetzt';
    
    // Stats: count messages and contacts
    let totalMessages = 0;
    let emojiCount = {};
    let contactStats = {};
    let firstMessageDate = null;
    
    try {
        const contactsSnap = await get(ref(db, `accounts/${myUsername}/contacts`));
        const contacts = contactsSnap.exists() ? Object.values(contactsSnap.val()).filter(Boolean) : [];
        
        document.getElementById('my-profile-contact-count').textContent = contacts.length;
        
        const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
        
        // Count messages across all chats
        const chatPromises = contacts.map(async (contact) => {
            const chatId = myUsername < contact ? `${myUsername}_${contact}` : `${contact}_${myUsername}`;
            const snap = await get(ref(db, `chats/${chatId}`));
            if(!snap.exists()) return;
            
            let count = 0;
            snap.forEach(child => {
                const m = child.val();
                if(m.sender === myUsername && !m.deletedForAll) {
                    count++;
                    totalMessages++;
                    if(!firstMessageDate || m.timestamp < firstMessageDate) firstMessageDate = m.timestamp;
                    
                    // Count emojis
                    const emojis = m.text?.match(/\p{Emoji}/gu) || [];
                    emojis.forEach(e => { emojiCount[e] = (emojiCount[e] || 0) + 1; });
                }
            });
            if(count > 0) contactStats[contact] = { count, name: aliases[contact] || contact };
        });
        await Promise.all(chatPromises);
        
        document.getElementById('my-profile-msg-count').textContent = totalMessages.toLocaleString('de-DE');
        
        // Favorite emoji
        const topEmoji = Object.entries(emojiCount).sort((a,b) => b[1]-a[1])[0];
        document.getElementById('my-profile-emoji-stat').textContent = topEmoji ? topEmoji[0] : 'â€”';
        
        // Since date
        document.getElementById('my-profile-since').textContent = firstMessageDate 
            ? new Date(firstMessageDate).toLocaleDateString('de-DE', {month:'short', year:'numeric'}) 
            : 'â€”';
        
        // Top contacts
        const topContacts = Object.entries(contactStats).sort((a,b) => b[1].count - a[1].count).slice(0, 5);
        const topEl = document.getElementById('my-profile-top-contacts');
        topEl.innerHTML = '';
        topContacts.forEach(([name, data]) => {
            const div = document.createElement('div');
            div.className = 'top-contact-item';
            div.innerHTML = `
                ${getAvatarHTML(name, false)}
                <span style="flex:1;">${data.name}</span>
                <span style="font-size:12px; opacity:0.5;">${data.count} Nachr.</span>
            `;
            topEl.appendChild(div);
        });
        if(topContacts.length === 0) topEl.innerHTML = '<p style="opacity:0.5; font-size:13px;">Noch keine Nachrichten gesendet</p>';
        
    } catch(e) {
        console.error('Profile stats error:', e);
    }
};

/* ------------------------------ */
/* CHANGE PIN */
/* ------------------------------ */
window.openChangePIN = async () => {
    document.getElementById('pin-current').value = '';
    document.getElementById('pin-new').value = '';
    document.getElementById('pin-confirm').value = '';
    // Pre-fill existing hint
    const hintSnap = await get(ref(db, `accounts/${myUsername}/pinHint`));
    document.getElementById('pin-hint-settings').value = hintSnap.exists() ? hintSnap.val() : '';
    closeOverlay('settings-overlay');
    document.getElementById('change-pin-overlay').style.display = 'flex';
    document.getElementById('pin-current').focus();
};

// Auto-format PIN inputs
['pin-current','pin-new','pin-confirm'].forEach(id => {
    document.addEventListener('DOMContentLoaded', () => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g,'');
            if(v.length>4) v = v.slice(0,4)+'-'+v.slice(4,8);
            e.target.value = v;
        });
    });
});

window.savePINChange = async () => {
    const current = document.getElementById('pin-current').value;
    const newPin  = document.getElementById('pin-new').value;
    const confirm = document.getElementById('pin-confirm').value;

    if(current.length < 9) { showNotification('âš ï¸ Bitte aktuellen PIN eingeben', 'warning'); return; }
    if(newPin.length < 9)  { showNotification('âš ï¸ Neuer PIN muss 8 Ziffern haben', 'warning'); return; }
    if(newPin !== confirm)  { showNotification('â›” PINs stimmen nicht Ã¼berein', 'error'); return; }
    if(newPin === current)  { showNotification('âš ï¸ Neuer PIN ist identisch mit altem', 'warning'); return; }

    // Verify current PIN against Firebase
    const snap = await get(ref(db, `accounts/${myUsername}/pin`));
    if(!snap.exists() || snap.val() !== current) {
        showNotification('â›” Aktueller PIN falsch', 'error');
        return;
    }

    await set(ref(db, `accounts/${myUsername}/pin`), newPin);
    // Save updated hint (can be empty to remove it)
    const hint = document.getElementById('pin-hint-settings').value.trim();
    await set(ref(db, `accounts/${myUsername}/pinHint`), hint || null);
    closeOverlay('change-pin-overlay');
    showNotification('âœ… PIN erfolgreich geÃ¤ndert', 'success');
};

/* ------------------------------ */
/* HELP SYSTEM */
/* ------------------------------ */
const helpArticles = [
    {
        id: 'start',
        icon: 'ğŸš€',
        title: 'Erste Schritte',
        body: `
            <h4>Registrieren & Einloggen</h4>
            <p>WÃ¤hle beim ersten Start <strong>â€Neu"</strong> und gib einen Benutzernamen sowie einen <strong>PIN im Format xxxx-xxxx</strong> (8 Ziffern) ein. Beim nÃ¤chsten Besuch loggst du dich mit â€Login" ein.</p>
            <h4>Kontakte hinzufÃ¼gen</h4>
            <p>Tippe den genauen Benutzernamen in das Suchfeld (linke Sidebar) und drÃ¼cke <strong>+</strong>. Der Kontakt erscheint sofort in deiner Liste.</p>
            <h4>Gruppe erstellen</h4>
            <p>Klicke auf das <strong>ğŸ‘¥-Icon</strong> oben in der Sidebar, gib einen Gruppennamen ein, suche Mitglieder per Username und bestÃ¤tige. Die Gruppe erscheint sofort oben in der Kontaktliste aller Mitglieder.</p>
            <h4>Chatten</h4>
            <p>Klicke auf einen Kontakt oder eine Gruppe, schreibe deine Nachricht und sende mit <strong>Enter</strong>. FÃ¼r eine neue Zeile nutze <strong>Shift+Enter</strong>.</p>
            <h4>Als App installieren (PWA)</h4>
            <p>VilloChat kann als eigenstÃ¤ndige App installiert werden. Nach ein paar Sekunden erscheint der <strong>ğŸ“² Als App installieren</strong> Button in den Einstellungen. Klicke darauf und folge den Anweisungen deines Browsers. Die App funktioniert dann auch offline!</p>
        `
    },
    {
        id: 'groups',
        icon: 'ğŸ‘¥',
        title: 'Gruppen-Chats',
        body: `
            <h4>Gruppe erstellen</h4>
            <p>Klicke auf das <strong>ğŸ‘¥-Icon</strong> oben in der Sidebar. Es Ã¶ffnet sich der Gruppen-Dialog:</p>
            <ol style="line-height:2;">
                <li>Einen <strong>Gruppennamen</strong> eingeben (max. 40 Zeichen)</li>
                <li>Im Suchfeld Mitglieder per Username suchen und mit Klick hinzufÃ¼gen</li>
                <li>HinzugefÃ¼gte Mitglieder erscheinen als grÃ¼ne Tags â€” mit âœ• wieder entfernen</li>
                <li><strong>âœ… Gruppe erstellen</strong> drÃ¼cken</li>
            </ol>
            <p>Die Gruppe wird sofort bei allen Mitgliedern in der Kontaktliste angezeigt (oben, mit ğŸ‘¥-Symbol).</p>

            <h4>In Gruppen schreiben</h4>
            <p>Nachrichten in Gruppen funktionieren genau wie in 1:1-Chats. Ãœber jeder empfangenen Nachricht wird der <strong>Absender-Name in seiner individuellen Farbe</strong> angezeigt, damit du immer weiÃŸt, wer was geschrieben hat.</p>

            <h4>Gruppeninfo Ã¶ffnen</h4>
            <p>Klicke auf den <strong>Gruppen-Header</strong> (oben im Chat) oder Ã¶ffne das â‹®-MenÃ¼ â†’ <strong>ğŸ‘¥ Gruppeninfo</strong>. Dort siehst du:</p>
            <ul style="font-size:13px; line-height:1.8;">
                <li>Gruppenname, Erstellungsdatum und Ersteller</li>
                <li>Alle Mitglieder mit Admin-Kennzeichnung</li>
                <li>Optionen zum Verwalten (als Admin)</li>
            </ul>

            <h4>Mitglieder hinzufÃ¼gen (nur Admin)</h4>
            <p>In der Gruppeninfo erscheint ein Eingabefeld <strong>â€Mitglied hinzufÃ¼gen"</strong>. Gib den genauen Username ein und drÃ¼cke <strong>+</strong>. Das neue Mitglied sieht die Gruppe sofort in seiner Kontaktliste. Im Gruppen-Chat erscheint eine automatische <strong>System-Nachricht</strong>.</p>

            <h4>Mitglied entfernen (nur Admin)</h4>
            <p>In der Gruppeninfo erscheint neben jedem Mitglied (auÃŸer dir selbst) ein <strong>â€Entfernen"</strong>-Button. Das entfernte Mitglied verliert sofort den Zugriff auf die Gruppe. Eine System-Nachricht informiert alle anderen.</p>

            <h4>Gruppe verlassen</h4>
            <p>Gruppeninfo Ã¶ffnen â†’ <strong>ğŸšª Gruppe verlassen</strong>. Du verlÃ¤sst die Gruppe sofort und sie verschwindet aus deiner Kontaktliste. Die anderen Mitglieder sehen eine System-Nachricht. Deine bisherigen Nachrichten bleiben im Chatverlauf sichtbar.</p>

            <h4>Tipp-Indikator in Gruppen</h4>
            <p>Wenn mehrere Mitglieder gleichzeitig schreiben, zeigt der Tipp-Indikator alle Namen an â€” z.B. <em>â€Alice, Bob schreiben..."</em></p>

            <h4>Benachrichtigungen</h4>
            <p>Neue Gruppen-Nachrichten zeigen einen <strong>roten Badge</strong> neben der Gruppe und eine Popup-Benachrichtigung mit Absender-Name und Gruppenname.</p>

            <h4>Wer ist Admin?</h4>
            <p>Der Ersteller der Gruppe ist immer Admin â€” auch bei bereits bestehenden Gruppen wird dies automatisch beim Ã–ffnen der Gruppeninfo gesetzt. Jeder Admin kann weitere Mitglieder zum Admin ernennen (ğŸ‘‘ Admin) oder ihnen den Status entziehen (ğŸ‘‘ Entziehen). Mindestens ein Admin muss immer Ã¼brig bleiben.</p>

            <h4>Gruppe stummschalten</h4>
            <p>Gruppeninfo Ã¶ffnen â†’ <strong>ğŸ”‡ Stumm</strong>. Stummgeschaltete Gruppen zeigen kein ğŸ”‡-Icon in der Sidebar und senden keine TÃ¶ne oder Popup-Benachrichtigungen mehr. Nachrichten kommen weiterhin an.</p>

            <h4>Gruppe archivieren</h4>
            <p>Gruppeninfo Ã¶ffnen â†’ <strong>ğŸ—‚ï¸ Archivieren</strong>. Archivierte Gruppen verschwinden aus der Hauptliste und erscheinen im ausklappbaren Archiv-Bereich unten in der Sidebar.</p>
        `
    },
    {
        id: 'messages',
        icon: 'ğŸ’¬',
        title: 'Nachrichten & Funktionen',
        body: `
            <h4>KontextmenÃ¼</h4>
            <p>Rechtsklick (Desktop) oder langer Druck (Mobil) auf eine Nachricht Ã¶ffnet das MenÃ¼ mit: Kopieren, Reagieren, Antworten, Weiterleiten, Bearbeiten, LÃ¶schen, FÃ¼r alle lÃ¶schen, Anpinnen.</p>
            <h4>Formatierung (Markdown)</h4>
            <ul>
                <li><strong>**fett**</strong> â†’ <strong>fett</strong></li>
                <li><em>_kursiv_</em> â†’ <em>kursiv</em></li>
                <li><code>\`code\`</code> â†’ <code>code</code></li>
                <li>~~durchgestrichen~~ â†’ <del>durchgestrichen</del></li>
            </ul>
            <h4>Bilder & Embeds</h4>
            <p>Sende einfach eine URL, die auf <code>.jpg .png .gif .webp</code> endet â€” das Bild wird direkt angezeigt. YouTube- und Vimeo-Links werden als einbettbare Vorschau dargestellt. Klick auf Bilder Ã¶ffnet eine Vollbild-Ansicht.</p>
            <h4>Abstimmungen erstellen</h4>
            <p>Klicke auf das <strong>ğŸ“Š-Icon</strong> links neben dem Eingabefeld. Gib eine Frage und 2â€“6 Optionen ein. Auch in Gruppen nutzbar â€” jedes Mitglied kann abstimmen und die Ergebnisse werden live angezeigt.</p>
            <h4>Nachrichten bearbeiten</h4>
            <p>Rechtsklick auf deine eigene Nachricht â†’ <strong>Bearbeiten</strong>. Der Text wird ins Eingabefeld geladen, bearbeite ihn und drÃ¼cke Enter. Die Nachricht zeigt dann "(bearbeitet)" an.</p>
            <h4>FÃ¼r alle lÃ¶schen</h4>
            <p>Rechtsklick auf eigene Nachricht â†’ <strong>FÃ¼r alle lÃ¶schen</strong>. Die Nachricht wird bei allen Nutzern (auch in Gruppen) durch "ğŸ—‘ï¸ Nachricht gelÃ¶scht" ersetzt.</p>
            <h4>Nachrichten weiterleiten</h4>
            <p>Rechtsklick â†’ <strong>Weiterleiten</strong> â†’ Kontakte auswÃ¤hlen â†’ senden. Die Nachricht wird mit "â†ªï¸ Weitergeleitet" markiert.</p>
            <h4>Gepinnte Nachricht</h4>
            <p>Angeheftete Nachrichten erscheinen als Banner unter dem Chat-Header. Klicke darauf, um zur Nachricht zu springen. âœ• lÃ¶st die Nachricht wieder. Nur eine Nachricht pro Chat kann gepinnt sein.</p>
        `
    },
    {
        id: 'contacts',
        icon: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘',
        title: 'Kontakte verwalten',
        body: `
            <h4>Kontakt anpassen</h4>
            <p>Klicke âœ neben einem Kontakt, um einen <strong>Alias</strong> (Anzeigenamen) zu vergeben. Der echte Benutzername bleibt unverÃ¤ndert.</p>
            <h4>Kontakt anpinnen</h4>
            <p>Gepinnte Kontakte erscheinen immer oben in der Liste. Klicke auf ğŸ“Œ im Alias-Dialog.</p>
            <h4>Kontakt stummschalten</h4>
            <p>Ã–ffne die User-Info (Klick auf Chat-Header) â†’ ğŸ”‡ Stumm. Stummgeschaltete Kontakte senden keine Benachrichtigungen oder TÃ¶ne mehr.</p>
            <h4>Chat archivieren</h4>
            <p>User-Info â†’ ğŸ—‚ï¸ Archivieren. Archivierte Chats verschwinden aus der Hauptliste und erscheinen im ausklappbaren <strong>Archiv-Bereich</strong> am Ende der Kontaktliste.</p>
            <h4>Kontakt-Notizen</h4>
            <p>In der User-Info findest du ganz unten ein <strong>Notiz-Feld</strong>. Hier kannst du private Notizen zu diesem Kontakt speichern (z.B. Telefonnummer, Geburtstag). Diese Notizen sind <strong>nur fÃ¼r dich sichtbar</strong> und werden lokal gespeichert.</p>
            <h4>Bubble-Farbe pro Kontakt</h4>
            <p>Klicke auf den Chat-Header â†’ User-Info â†’ <strong>Chat-Bubble-Farbe</strong> â†’ Color-Picker â†’ speichern. Die Nachrichten dieses Kontakts erscheinen dann in deiner gewÃ¤hlten Farbe.</p>
        `
    },
    {
        id: 'design',
        icon: 'ğŸ¨',
        title: 'Design & Personalisierung',
        body: `
            <h4>Theme</h4>
            <p>Einstellungen â†’ Design: <strong>System</strong> (folgt deinem Betriebssystem), <strong>Hell</strong> oder <strong>Dunkel</strong>.</p>
            <h4>Akzentfarbe</h4>
            <p>Einstellungen â†’ Akzentfarbe â†’ <strong>13 Farben</strong> wÃ¤hlbar (Rot, Orange, Gold, Gelb, Limette, GrÃ¼n, Himmelblau, Indigo, Blau, Violett, Pink, Pfirsich, Schwarz). Betrifft Header, Buttons und Highlights.</p>
            <h4>Bubble-Stil</h4>
            <p>Einstellungen â†’ Bubble-Stil: <strong>Rund</strong> (Standard mit 12px Radius), <strong>Eckig</strong> (4px, scharf) oder <strong>Minimal</strong> (6px, kein Schatten).</p>
            <h4>SchriftgrÃ¶ÃŸe</h4>
            <p>Einstellungen â†’ SchriftgrÃ¶ÃŸe: <strong>Klein</strong> (13px), <strong>Normal</strong> (15px), <strong>GroÃŸ</strong> (17px) oder <strong>XL</strong> (20px).</p>
            <h4>Mein Avatar</h4>
            <p>Einstellungen â†’ Mein Avatar: Eigene <strong>Farbe</strong> und <strong>Schriftart</strong> wÃ¤hlen. Wird in Firebase gespeichert und ist fÃ¼r alle Kontakte sichtbar.</p>
            <h4>Eigene Bubble-Farbe</h4>
            <p>Einstellungen â†’ <strong>Meine Bubble-Farbe</strong> â†’ Color-Picker â†’ alle deine gesendeten Nachrichten erscheinen in dieser Farbe (Standard: grÃ¼n).</p>
            <h4>Chat-Hintergrund</h4>
            <p>Einstellungen â†’ <strong>Chat-Hintergrund</strong> â†’ Color-Picker â†’ Ã¤ndert die Hintergrundfarbe des Chat-Bereichs.</p>
            <h4>Status-Text</h4>
            <p>Einstellungen â†’ <strong>Mein Status</strong> â†’ z.B. "VerfÃ¼gbar", "BeschÃ¤ftigt" oder eine eigene Nachricht. Wird in Firebase gespeichert und andere sehen es in deiner User-Info.</p>
        `
    },
    {
        id: 'search',
        icon: 'ğŸ”',
        title: 'Suche & Navigation',
        body: `
            <h4>Globale Suche</h4>
            <p>ğŸ”-Button in der Sidebar durchsucht <strong>alle deine Chats gleichzeitig</strong>. Klick auf ein Ergebnis Ã¶ffnet den Chat und springt zur Nachricht (die wird kurz hervorgehoben).</p>
            <h4>In Chat suchen</h4>
            <p>Dreipunkt-MenÃ¼ (â‹®) â†’ Nachricht suchen, oder drÃ¼cke <strong>Ctrl+F</strong> im Chat.</p>
            <h4>Mobile: Swipe zurÃ¼ck</h4>
            <p>Auf MobilgerÃ¤ten kannst du den Chat nach <strong>rechts wischen</strong> um ihn zu schlieÃŸen. Der Chat folgt deinem Finger und schlieÃŸt sich ab ~80px Bewegung.</p>
            <h4>Keyboard Shortcuts</h4>
            <ul>
                <li><strong>Ctrl+K</strong> â€” Kontaktsuche fokussieren</li>
                <li><strong>Ctrl+F</strong> â€” In Chat suchen</li>
                <li><strong>Ctrl+E</strong> â€” Chat exportieren</li>
                <li><strong>Ctrl+B</strong> â€” User-Info Ã¶ffnen</li>
                <li><strong>Ctrl+D</strong> â€” Letzte eigene Nachricht lÃ¶schen</li>
                <li><strong>Ctrl+R</strong> â€” Auf letzte Nachricht antworten</li>
                <li><strong>Ctrl+P</strong> â€” Letzte Nachricht anpinnen / loslÃ¶sen</li>
                <li><strong>Ctrl+,</strong> â€” Einstellungen Ã¶ffnen</li>
                <li><strong>Escape</strong> â€” Bearbeiten/Antworten abbrechen, Overlays/Chat schlieÃŸen</li>
            </ul>
            <p style="font-size:12px; opacity:0.6; margin-top:8px;"><em>Hinweis: Shortcuts funktionieren nicht wÃ¤hrend du in einem Eingabefeld tippst (auÃŸer Escape).</em></p>
        `
    },
    {
        id: 'security',
        icon: 'ğŸ”',
        title: 'Sicherheit & Datenschutz',
        body: `
            <h4>PIN Ã¤ndern</h4>
            <p>Einstellungen â†’ <strong>ğŸ”‘ PIN Ã¤ndern</strong>. Du brauchst deinen aktuellen PIN zur Verifikation. Das Format ist <strong>xxxx-xxxx</strong> (8 Ziffern).</p>
            <h4>VerschlÃ¼sselung</h4>
            <p>âš ï¸ VilloChat verwendet <strong>keine Ende-zu-Ende-VerschlÃ¼sselung</strong>. Nachrichten werden unverschlÃ¼sselt in der Firebase Realtime Database gespeichert. Teile keine hochsensiblen Informationen wie PasswÃ¶rter oder Kreditkartendaten.</p>
            <h4>Lokale Daten</h4>
            <p>Folgende Daten werden im <strong>localStorage</strong> deines Browsers gespeichert und gehen verloren, wenn du den Browser-Cache lÃ¶schst:</p>
            <ul style="font-size:13px;">
                <li>Einstellungen (Theme, Farben, SchriftgrÃ¶ÃŸe, Bubble-Stil)</li>
                <li>Kontakt-Aliase und Pinning-Status</li>
                <li>Chat-Farben pro Kontakt</li>
                <li>Stummgeschaltete & archivierte Chats</li>
                <li>Kontakt-Notizen (nur lokal!)</li>
                <li>Session-Token fÃ¼r Auto-Login</li>
            </ul>
            <h4>Firebase-Daten</h4>
            <p>In Firebase werden gespeichert: Nachrichten, Gruppeninformationen & Mitgliederlisten, Abstimmungen, Avatar-Einstellungen, Status-Text, Online-Status, Kontaktliste.</p>
            <h4>Abmelden</h4>
            <p>Einstellungen â†’ <strong>Abmelden</strong>. Dein Account, deine Nachrichten und deine Gruppen bleiben in Firebase erhalten. Du kannst dich jederzeit wieder einloggen.</p>
        `
    },
    {
        id: 'profile',
        icon: 'ğŸ‘¤',
        title: 'Mein Profil & Statistiken',
        body: `
            <h4>Profilseite Ã¶ffnen</h4>
            <p>Klicke auf deinen <strong>Namen in der Sidebar</strong> (oben links) um dein Profil zu Ã¶ffnen.</p>
            <h4>Statistiken</h4>
            <p>Dein Profil zeigt live:</p>
            <ul style="font-size:13px;">
                <li><strong>Gesendete Nachrichten</strong> â€” Gesamt Ã¼ber alle Chats</li>
                <li><strong>Anzahl Kontakte</strong> â€” Wie viele Personen in deiner Liste</li>
                <li><strong>Lieblings-Emoji</strong> â€” Das am hÃ¤ufigsten verwendete Emoji</li>
                <li><strong>Dabei seit</strong> â€” Datum deiner ersten gesendeten Nachricht</li>
            </ul>
            <h4>Top 5 Kontakte</h4>
            <p>Die 5 Kontakte, mit denen du am meisten geschrieben hast, werden mit Nachrichtenanzahl aufgelistet.</p>
            <h4>Kontakt-Profile</h4>
            <p>Klicke auf den Chat-Header oder drÃ¼cke <strong>Ctrl+B</strong> um die User-Info eines Kontakts zu sehen. Dort siehst du:</p>
            <ul style="font-size:13px;">
                <li>Avatar, Name, Alias, Online-Status</li>
                <li>Status-Text (falls gesetzt)</li>
                <li><strong>Statistiken</strong>: Anzahl Nachrichten, Lieblings-Emoji, erste Nachricht, durchschnittliche Zeichenanzahl</li>
                <li>Verwaltungsoptionen: Stumm, Archivieren, Farbe, Notizen</li>
            </ul>
            <h4>Bearbeiten</h4>
            <p>Klicke auf den Avatar in deinem Profil oder â€âœï¸ Bearbeiten" um zu den Einstellungen zu gelangen und Avatar, Status-Text oder andere Optionen zu Ã¤ndern.</p>
        `
    },
    {
        id: 'stories',
        icon: 'ğŸ“–',
        title: 'Geschichten',
        body: `
            <h4>Was sind Geschichten?</h4>
            <p>Geschichten sind temporÃ¤re BeitrÃ¤ge die <strong>48 Stunden</strong> sichtbar sind und dann automatisch verschwinden. Sie erscheinen als Bubbles mit farbigem Ring oben in der Sidebar.</p>
            <h4>Geschichte erstellen</h4>
            <p>Klicke auf deinen eigenen Avatar-Ring oben in der Sidebar. Im Creator wÃ¤hlst du zwischen drei Typen:</p>
            <ul style="font-size:13px; line-height:1.8;">
                <li><strong>âœï¸ Text</strong> â€” Eigenen Text mit Hintergrundfarbe und Schriftart wÃ¤hlen</li>
                <li><strong>ğŸ˜Š Emoji</strong> â€” Ein groÃŸes Emoji auf Farbhintergrund</li>
                <li><strong>ğŸ–¼ï¸ Bild</strong> â€” Ein Foto (max. 500 KB, wird komprimiert)</li>
            </ul>
            <h4>Mehrere Slides</h4>
            <p>DrÃ¼cke <strong>ğŸ’¾ Slide speichern</strong> um den aktuellen Inhalt als Slide hinzuzufÃ¼gen. Du siehst die Slides als kleine Thumbnails â€” klicke darauf zum Bearbeiten oder tippe âœ• zum LÃ¶schen. Du kannst bis zu <strong>15 Slides</strong> pro Geschichte hinzufÃ¼gen. Beim Klick auf <strong>ğŸ“– VerÃ¶ffentlichen</strong> wird die ganze Geschichte auf einmal geteilt.</p>
            <h4>Geschichten ansehen</h4>
            <p>Klicke auf den farbigen Ring eines Kontakts. Der Viewer zeigt Slides nacheinander mit Fortschrittsbalken â€” jeder Slide wird 5 Sekunden angezeigt, danach geht es automatisch zum nÃ¤chsten. Mit â€¹ und â€º kannst du auch manuell navigieren.</p>
            <h4>Reagieren</h4>
            <p>Beim Ansehen einer fremden Geschichte erscheint eine Reaktionsleiste mit 6 Emojis (â¤ï¸ ğŸ˜‚ ğŸ˜® ğŸ”¥ ğŸ‘ ğŸ˜¢). Die Reaktion wird dem Autor als Nachricht zugestellt und unter der Geschichte angezeigt.</p>
            <h4>Geschichte verwalten (Rechtsklick / Langtipp)</h4>
            <p>Rechtsklick auf deinen eigenen Ring (Desktop) oder langer Tipp (Mobile) Ã¶ffnet das VerwaltungsmenÃ¼. Dort kannst du <strong>alle Geschichten auf einmal lÃ¶schen</strong> oder einzelne Slides entfernen â€” mit Thumbnail-Vorschau fÃ¼r jeden Slide.</p>
            <h4>Sichtbarkeit einschrÃ¤nken</h4>
            <p>Einstellungen â†’ Sicherheit â†’ <strong>Wer sieht meine Geschichten?</strong></p>
            <ul style="font-size:13px; line-height:1.8;">
                <li><strong>Alle Kontakte</strong> â€” Standard, jeder in deiner Kontaktliste sieht sie</li>
                <li><strong>Kontakte auÃŸer...</strong> â€” Alle auÃŸer bestimmten Personen</li>
                <li><strong>Nur teilen fÃ¼r...</strong> â€” Nur ausgewÃ¤hlte Kontakte sehen sie</li>
                <li><strong>Niemand</strong> â€” Geschichten werden fÃ¼r niemanden angezeigt</li>
            </ul>
        `
    },
    {
        id: 'avatar',
        icon: 'ğŸ–¼ï¸',
        title: 'Profilbild',
        body: `
            <h4>Profilbild Ã¤ndern</h4>
            <p>Einstellungen â†’ Profil â†’ wÃ¤hle einen der drei Typen:</p>
            <ul style="font-size:13px; line-height:1.8;">
                <li><strong>ğŸ”¤ Zeichen</strong> â€” Erster Buchstabe deines Namens, mit eigener Farbe und Schriftart. Wird in Firebase gespeichert und ist fÃ¼r alle Kontakte sichtbar.</li>
                <li><strong>ğŸ˜Š Emoji</strong> â€” Ein beliebiges Emoji auf Hintergrundfarbe. Ideal als persÃ¶nliches Symbol.</li>
                <li><strong>ğŸ–¼ï¸ Bild</strong> â€” Ein Foto als rundes Profilbild (max. 200 KB, wird automatisch komprimiert und als Base64 in Firebase gespeichert).</li>
            </ul>
            <h4>Speichern & Sync</h4>
            <p>Nach Klick auf <strong>Avatar speichern</strong> wird das Profilbild in Firebase hochgeladen. Deine Kontakte sehen die Ã„nderung beim nÃ¤chsten Laden. Avatar-Typen werden Ã¼berall gerendert: Sidebar, Chat-Header, Nachrichten, Gruppen, Geschichten.</p>
        `
    },
    {
        id: 'features',
        icon: 'âœ¨',
        title: 'Alle Features im Ãœberblick',
        body: `
            <h4>ğŸ’¬ Nachrichten</h4>
            <p>Senden, Bearbeiten, LÃ¶schen, FÃ¼r alle lÃ¶schen, Kopieren, Weiterleiten, Antworten, Reaktionen, Markdown, Bilder (Base64), Anpinnen, Bild herunterladen</p>
            <h4>ğŸ“– Geschichten</h4>
            <p>Text/Emoji/Bild-Slides (bis zu 15), Schriftart wÃ¤hlen, 48h Laufzeit, Reaktionen, Sichtbarkeit (alle / auÃŸer / nur / niemand), Slides einzeln oder alle lÃ¶schen</p>
            <h4>ğŸ‘¥ Gruppen</h4>
            <p>Erstellen, Admin/Moderator, Einladungslink, Beschreibung, Gruppen-Pin, Tippindikator, System-Nachrichten, Unread-Badges</p>
            <h4>ğŸ“Š Abstimmungen</h4>
            <p>Polls mit 2â€“6 Optionen (auch in Gruppen), abstimmen, Stimme Ã¤ndern, Live-Ergebnisse</p>
            <h4>ğŸ§‘â€ğŸ¤â€ğŸ§‘ Kontakte</h4>
            <p>Suchen, HinzufÃ¼gen, Aliase, Anpinnen, Stummschalten, Archivieren, Farbe, private Notizen</p>
            <h4>ğŸ–¼ï¸ Profilbild</h4>
            <p>Zeichen (Farbe + Schrift), Emoji (auf Farbe), Bild (Base64) â€” fÃ¼r alle Kontakte sichtbar</p>
            <h4>ğŸ¨ Design</h4>
            <p>3 Themes, 13 Akzentfarben, 3 Bubble-Stile, 4 SchriftgrÃ¶ÃŸen, Bubble-Farbe, Chat-Hintergrund, Status-Text, Schnellreaktionen</p>
            <h4>ğŸ• Geplante Nachrichten</h4>
            <p>Zeitpunkt festlegen, automatischer Versand, Ãœbersicht & LÃ¶schen</p>
            <h4>ğŸ” Suche</h4>
            <p>Globale Suche, Chat-interne Suche, Spring-zu-Nachricht</p>
            <h4>ğŸ‘¤ Profile</h4>
            <p>Statistiken, Top-Kontakte, Kontakt-Profile mit Stats</p>
            <h4>âŒ¨ï¸ Shortcuts</h4>
            <p>Ctrl+K/F/E/B/D/R/P/,, Escape</p>
            <h4>ğŸ“² PWA Â· ğŸ“± Mobile Â· ğŸ” Sicherheit</h4>
            <p>Installierbar, Offline, Swipe-zurÃ¼ck, PIN-Login, PIN-Hinweis, Geschichten-Sichtbarkeit</p>
            <h4>ğŸ“¥ Sonstiges</h4>
            <p>Chat-Export, Online-Status, Read-Receipts, Typing-Indikator, Emoji-Picker (900+), Changelog, Hilfe</p>
        `
    }
];

window.openHelp = () => {
    closeOverlay('settings-overlay');
    document.getElementById('help-overlay').style.display = 'flex';
    document.getElementById('help-search').value = '';
    showHelpNav();
    renderHelpList(helpArticles);
};
// Expose for early login-screen access (before module fully runs)
window._helpArticles = helpArticles;
window._renderHelpList = renderHelpList;

window.showHelpNav = () => {
    document.getElementById('help-nav').style.display = 'block';
    document.getElementById('help-article-view').style.display = 'none';
};

window.filterHelp = (query) => {
    const q = query.toLowerCase();
    const filtered = helpArticles.filter(a =>
        a.title.toLowerCase().includes(q) || a.body.toLowerCase().includes(q)
    );
    renderHelpList(filtered);
};

function renderHelpList(articles) {
    const list = document.getElementById('help-articles-list');
    list.innerHTML = '';
    if(articles.length === 0) {
        list.innerHTML = '<p style="opacity:0.5; text-align:center; padding:10px;">Keine Artikel gefunden</p>';
        return;
    }
    articles.forEach(article => {
        const div = document.createElement('div');
        div.style.cssText = 'display:flex; align-items:center; gap:12px; padding:12px 5px; border-bottom:1px solid var(--border-color); cursor:pointer;';
        div.innerHTML = `
            <span style="font-size:22px;">${article.icon}</span>
            <span style="font-weight:500;">${article.title}</span>
            <span style="margin-left:auto; opacity:0.4;">â€º</span>
        `;
        div.onclick = () => showHelpArticle(article);
        list.appendChild(div);
    });
}

function showHelpArticle(article) {
    document.getElementById('help-nav').style.display = 'none';
    document.getElementById('help-article-view').style.display = 'block';
    document.getElementById('help-article-title').innerHTML = `${article.icon} ${article.title}`;
    document.getElementById('help-article-body').innerHTML = article.body;
}

/* ------------------------------ */
/* POLLS */
/* ------------------------------ */
window.openPollCreator = () => {
    if(!activeChatId) { showNotification('âš ï¸ Bitte zuerst einen Chat Ã¶ffnen', 'warning'); return; }
    document.getElementById('poll-question').value = '';
    const list = document.getElementById('poll-options-list');
    list.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="Option 1" maxlength="60" style="width:100%; margin-bottom:8px;">
        <input type="text" class="poll-option-input" placeholder="Option 2" maxlength="60" style="width:100%; margin-bottom:8px;">
    `;
    document.getElementById('poll-overlay').style.display = 'flex';
    document.getElementById('poll-question').focus();
};

window.addPollOption = () => {
    const list = document.getElementById('poll-options-list');
    const count = list.querySelectorAll('.poll-option-input').length;
    if(count >= 6) { showNotification('âš ï¸ Maximal 6 Optionen', 'warning'); return; }
    const inp = document.createElement('input');
    inp.type = 'text'; inp.className = 'poll-option-input';
    inp.placeholder = `Option ${count + 1}`; inp.maxLength = 60;
    inp.style.cssText = 'width:100%; margin-bottom:8px;';
    list.appendChild(inp); inp.focus();
};

window.sendPoll = () => {
    const question = document.getElementById('poll-question').value.trim();
    if(!question) { showNotification('âš ï¸ Bitte eine Frage eingeben', 'warning'); return; }
    const options = [...document.querySelectorAll('.poll-option-input')].map(el => el.value.trim()).filter(Boolean);
    if(options.length < 2) { showNotification('âš ï¸ Mindestens 2 Optionen nÃ¶tig', 'warning'); return; }
    const pollData = { question, options: {}, createdBy: myUsername, closed: false };
    options.forEach((opt, i) => { pollData.options[`opt${i}`] = { text: opt, votes: {} }; });
    push(ref(db, `chats/${activeChatId}`), {
        sender: myUsername, text: '', timestamp: Date.now(), read: false, poll: pollData
    });
    closeOverlay('poll-overlay');
    showNotification('ğŸ“Š Abstimmung gesendet', 'success');
};

function renderPoll(msgKey, poll) {
    const totalVotes = Object.values(poll.options).reduce((sum, opt) => sum + Object.keys(opt.votes || {}).length, 0);
    const myVote = Object.keys(poll.options).find(k => (poll.options[k].votes || {})[myUsername]);
    const isClosed = poll.closed === true;
    const isCreator = poll.createdBy === myUsername;
    
    let html = `<div class="msg-poll">`;
    html += `<div class="poll-question">ğŸ“Š ${poll.question}`;
    if(isClosed) html += ` <span style="font-size:11px; opacity:0.6; font-weight:400; margin-left:6px;">ğŸ”’ Geschlossen</span>`;
    html += `</div>`;
    
    Object.entries(poll.options).forEach(([key, opt]) => {
        const voteCount = Object.keys(opt.votes || {}).length;
        const pct = totalVotes > 0 ? Math.round(voteCount / totalVotes * 100) : 0;
        const isMyVote = myVote === key;
        const clickable = !isClosed ? `onclick="votePoll('${msgKey}','${key}')"` : '';
        html += `
            <div class="poll-option ${isMyVote ? 'voted' : ''} ${isClosed ? 'closed' : ''}" ${clickable}>
                <div class="poll-option-bar" style="width:${pct}%"></div>
                <div class="poll-option-label">
                    <span>${isMyVote ? 'âœ“ ' : ''}${opt.text}</span>
                    <span class="poll-option-pct">${pct}%</span>
                </div>
            </div>`;
    });
    html += `<div class="poll-meta">`;
    html += `${totalVotes} Stimme${totalVotes !== 1 ? 'n' : ''}`;
    if(isCreator && !isClosed) {
        html += ` Â· <span style="color:var(--primary); cursor:pointer; font-weight:600;" onclick="closePoll('${msgKey}')">SchlieÃŸen</span>`;
    }
    html += `</div></div>`;
    return html;
}

window.votePoll = async (msgKey, optionKey) => {
    if(!activeChatId) return;
    const pollRef = ref(db, `chats/${activeChatId}/${msgKey}/poll`);
    const snap = await get(pollRef);
    if(!snap.exists()) return;
    const poll = snap.val();
    if(poll.closed) { showNotification('ğŸ”’ Diese Umfrage ist geschlossen', 'warning'); return; }
    const updates = {};
    Object.keys(poll.options).forEach(k => {
        if((poll.options[k].votes || {})[myUsername]) updates[`options/${k}/votes/${myUsername}`] = null;
    });
    if(!(poll.options[optionKey].votes || {})[myUsername]) updates[`options/${optionKey}/votes/${myUsername}`] = true;
    await update(pollRef, updates);
};

window.closePoll = async (msgKey) => {
    if(!activeChatId) return;
    await update(ref(db, `chats/${activeChatId}/${msgKey}/poll`), { closed: true });
    showNotification('ğŸ”’ Umfrage geschlossen', 'success');
};

/* ------------------------------ */
/* QUICK REACTIONS CUSTOMIZATION */
/* ------------------------------ */
function initQuickReactions() {
    const saved = JSON.parse(localStorage.getItem('villo_quick_reactions') || 'null');
    const defaults = ['â¤ï¸', 'ğŸ‘', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ™'];
    const reactions = saved || defaults;
    reactions.forEach((emoji, i) => {
        const input = document.getElementById(`quick-reaction-${i + 1}`);
        if(input) input.value = emoji;
    });
}

window.saveQuickReactions = () => {
    const reactions = [];
    for(let i = 1; i <= 6; i++) {
        const val = document.getElementById(`quick-reaction-${i}`).value.trim();
        reactions.push(val || ['â¤ï¸', 'ğŸ‘', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ™'][i-1]);
    }
    localStorage.setItem('villo_quick_reactions', JSON.stringify(reactions));
    showNotification('âœ… Schnellreaktionen gespeichert', 'success');
};

/* ------------------------------ */
/* EMOJI PICKER TABS */
/* ------------------------------ */
let currentEmojiTab = 'emoji';
const symbols = [
    'â†','â†’','â†‘','â†“','â†”','â†•','â‡','â‡’','â‡‘','â‡“','â‡”','â‡•',
    'âœ“','âœ”','âœ—','âœ˜','â˜','â˜‘','â˜’','âŠ™','âŠ•','âŠ—','âŠ˜',
    'â˜…','â˜†','â™¥','â™¦','â™£','â™ ','â™¡','â™¢','â™¤','â™§','â—','â—‹','â—†','â—‡','â– ','â–¡','â–²','â–³','â–¼','â–½','â—€','â—','â–¶','â–·',
    'Â©','Â®','â„¢','Â§','Â¶','â€ ','â€¡','â€¢','â€£','â‚','â€»','â„ƒ','â„‰','â„ ','â„–',
    'â€¦','Â·','â€§','âˆ™','â‹…','â–','âœ¦','âœ§','âœª','âœ«','âœ¬','âœ­','âœ®','âœ¯','âœ°','âœ±',
    'Â½','â…“','Â¼','â…•','â…™','â…','â…›','â…‘','â…’','Â¾','â…–','â…—','â…˜','â…š','â…œ','â…','â…',
    'â†','â†’','â†‘','â†“','â†–','â†—','â†˜','â†™','âŸµ','âŸ¶','âŸ·','âŸ¸','âŸ¹','âŸº',
    'âˆ','â‰ˆ','â‰ ','â‰¡','â‰¤','â‰¥','Â±','Ã—','Ã·','âˆ“','âˆš','âˆ›','âˆœ','âˆ','âˆŸ','âˆ ','âˆ¡','âˆ¢',
    'Î±','Î²','Î³','Î´','Îµ','Î¶','Î·','Î¸','Î»','Î¼','Ï€','Ïƒ','Ï†','Ïˆ','Ï‰','Î©'
];

window.switchEmojiTab = (tab) => {
    currentEmojiTab = tab;
    document.getElementById('tab-emoji').style.borderBottom = tab === 'emoji' ? '2px solid var(--primary)' : '2px solid transparent';
    document.getElementById('tab-emoji').style.fontWeight = tab === 'emoji' ? '600' : '400';
    document.getElementById('tab-emoji').style.opacity = tab === 'emoji' ? '1' : '0.5';
    document.getElementById('tab-symbols').style.borderBottom = tab === 'symbols' ? '2px solid var(--primary)' : '2px solid transparent';
    document.getElementById('tab-symbols').style.fontWeight = tab === 'symbols' ? '600' : '400';
    document.getElementById('tab-symbols').style.opacity = tab === 'symbols' ? '1' : '0.5';
    
    const grid = document.getElementById('emoji-grid');
    const searchVal = document.getElementById('emoji-search').value.toLowerCase();
    
    if(tab === 'symbols') {
        const filtered = searchVal ? symbols.filter(s => s.includes(searchVal)) : symbols;
        grid.innerHTML = filtered.map(s => 
            `<span style="font-size:24px; cursor:pointer; text-align:center; padding:8px;" onclick="insertSymbol('${s}')">${s}</span>`
        ).join('');
    } else {
        populateEmojiGrid(searchVal);
    }
};

window.insertSymbol = (symbol) => {
    const input = document.getElementById('msg-input');
    input.value += symbol;
    input.focus();
    closeOverlay('emoji-overlay');
};

/* ------------------------------ */
/* CONTACT NOTES */
/* ------------------------------ */
function getContactNotes() { return JSON.parse(localStorage.getItem('contact_notes') || '{}'); }

window.saveContactNote = () => {
    const contactName = document.getElementById('info-username').textContent;
    const note = document.getElementById('contact-note-input').value.trim();
    const notes = getContactNotes();
    if(note) { notes[contactName] = note; } else { delete notes[contactName]; }
    localStorage.setItem('contact_notes', JSON.stringify(notes));
    showNotification('âœ… Notiz gespeichert', 'success');
};

function loadContactNote(contactName) {
    const notes = getContactNotes();
    const input = document.getElementById('contact-note-input');
    if(input) input.value = notes[contactName] || '';
}

/* ------------------------------ */
/* SWIPE BACK (MOBILE) */
/* ------------------------------ */
function initSwipeBack() {
    const mainChat = document.getElementById('main-chat');
    let startX = 0, startY = 0, dragging = false;
    mainChat.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        dragging = true;
    }, { passive: true });
    mainChat.addEventListener('touchmove', (e) => {
        if(!dragging || !activeChatId) return;
        const dx = e.touches[0].clientX - startX;
        const dy = Math.abs(e.touches[0].clientY - startY);
        if(dx > 0 && dy < 60 && dx > dy) {
            mainChat.style.transform = `translateX(${Math.min(dx * 0.5, 80)}px)`;
            mainChat.style.opacity = String(1 - Math.min(dx / 200, 1) * 0.2);
        }
    }, { passive: true });
    mainChat.addEventListener('touchend', (e) => {
        if(!dragging) return;
        dragging = false;
        const dx = e.changedTouches[0].clientX - startX;
        const dy = Math.abs(e.changedTouches[0].clientY - startY);
        mainChat.style.transform = '';
        mainChat.style.opacity = '';
        if(dx > 80 && dy < 60) closeChat();
    }, { passive: true });
}

/* ------------------------------ */
/* FORWARD MESSAGE */
/* ------------------------------ */
let forwardText = '';
let forwardSelectedContacts = new Set();

window.openForwardDialog = async (text) => {
    forwardText = text;
    forwardSelectedContacts.clear();
    
    document.getElementById('forward-preview').textContent = text.substring(0, 150) + (text.length > 150 ? '...' : '');
    document.getElementById('forward-send-btn').textContent = 'Weiterleiten (0 ausgewÃ¤hlt)';
    document.getElementById('forward-send-btn').disabled = true;
    
    const list = document.getElementById('forward-contacts-list');
    list.innerHTML = '<p style="padding:15px; text-align:center; opacity:0.5;">Lade...</p>';
    document.getElementById('forward-overlay').style.display = 'flex';
    
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    list.innerHTML = '';

    // Load contacts
    let contacts = [];
    try {
        const snap = await get(ref(db, `accounts/${myUsername}/contacts`));
        if(snap.exists()) contacts = Object.values(snap.val()).filter(Boolean);
    } catch(e) { contacts = window._contactsCache || []; }

    // Load groups
    let groups = [];
    try {
        const gSnap = await get(ref(db, `accounts/${myUsername}/groups`));
        if(gSnap.exists()) {
            const gids = Object.values(gSnap.val());
            for(const gid of gids) {
                const gs = await get(ref(db, `groups/${gid}`));
                if(gs.exists()) groups.push({ gid, name: gs.val().name, avatar: gs.val().avatar || 'ğŸ‘¥' });
            }
        }
    } catch(e) {}

    if(contacts.length === 0 && groups.length === 0) {
        list.innerHTML = '<p style="padding:15px; text-align:center; opacity:0.5;">Keine Kontakte oder Gruppen</p>';
        return;
    }

    const updateBtn = () => {
        const count = forwardSelectedContacts.size;
        const btn = document.getElementById('forward-send-btn');
        btn.textContent = count > 0 ? `Weiterleiten (${count})` : 'Weiterleiten (0 ausgewÃ¤hlt)';
        btn.disabled = count === 0;
    };

    // Section header helper
    const addSection = (label) => {
        const h = document.createElement('div');
        h.style.cssText = 'padding:8px 12px 4px; font-size:11px; font-weight:600; opacity:0.4; text-transform:uppercase; letter-spacing:0.5px;';
        h.textContent = label;
        list.appendChild(h);
    };

    // Groups
    if(groups.length > 0) {
        addSection('Gruppen');
        groups.sort((a,b) => a.name.localeCompare(b.name));
        groups.forEach(({ gid, name, avatar }) => {
            const key = `group:${gid}`;
            const item = document.createElement('div');
            item.className = 'forward-contact-item';
            item.innerHTML = `
                <div class="avatar" style="background:${stringToColor(name)};font-size:18px;width:36px;height:36px;">${avatar}</div>
                <span style="flex:1;">${name}</span>
                <div class="fwd-check"></div>`;
            item.onclick = () => {
                if(forwardSelectedContacts.has(key)) { forwardSelectedContacts.delete(key); item.classList.remove('selected'); item.querySelector('.fwd-check').textContent=''; }
                else { forwardSelectedContacts.add(key); item.classList.add('selected'); item.querySelector('.fwd-check').textContent='âœ“'; }
                updateBtn();
            };
            list.appendChild(item);
        });
    }

    // Contacts
    if(contacts.length > 0) {
        addSection('Kontakte');
        contacts.sort((a,b) => (aliases[a]||a).localeCompare(aliases[b]||b));
        contacts.forEach(name => {
            const displayName = aliases[name] || name;
            const item = document.createElement('div');
            item.className = 'forward-contact-item';
            item.dataset.contact = name;
            item.innerHTML = `${getAvatarHTML(displayName, false)}<span style="flex:1;">${displayName}</span><div class="fwd-check"></div>`;
            item.onclick = () => {
                if(forwardSelectedContacts.has(name)) { forwardSelectedContacts.delete(name); item.classList.remove('selected'); item.querySelector('.fwd-check').textContent=''; }
                else { forwardSelectedContacts.add(name); item.classList.add('selected'); item.querySelector('.fwd-check').textContent='âœ“'; }
                updateBtn();
            };
            list.appendChild(item);
        });
    }
};

window.sendForward = async () => {
    if(forwardSelectedContacts.size === 0) return;
    
    const promises = [...forwardSelectedContacts].map(async (key) => {
        const isGroup = key.startsWith('group:');
        const chatId = isGroup ? key.slice(6) : (myUsername < key ? `${myUsername}_${key}` : `${key}_${myUsername}`);
        await push(ref(db, `chats/${chatId}`), {
            sender: myUsername,
            text: forwardText,
            timestamp: Date.now(),
            read: false,
            forwarded: true
        });
    });
    
    await Promise.all(promises);
    closeOverlay('forward-overlay');
    showNotification(`âœ… An ${forwardSelectedContacts.size} EmpfÃ¤nger weitergeleitet`, 'success');
};

/* ------------------------------ */
/* IMAGE & EMBED DETECTION */
/* ------------------------------ */
function isImageUrl(url) {
    return /\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url.trim());
}

function getYouTubeId(url) {
    const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([A-Za-z0-9_-]{11})/);
    return m ? m[1] : null;
}

function getVimeoId(url) {
    const m = url.match(/vimeo\.com\/(\d+)/);
    return m ? m[1] : null;
}

function isTwitterUrl(url) {
    return /twitter\.com\/\S+\/status\/\d+/.test(url) || /x\.com\/\S+\/status\/\d+/.test(url);
}

function renderMessageContent(text) {
    if(!text) return '';
    // Base64 image (from upload)
    if(text.startsWith('data:image/')) {
        return `<img class="msg-image" src="${text}" alt="Bild" onclick="openLightbox(this.src)" style="max-width:100%; max-height:300px; border-radius:8px; cursor:pointer; display:block;">`;
    }

    // Check for plain image URL (whole message or standalone line)
    const lines = text.trim().split('\n');
    const results = [];
    
    for(const line of lines) {
        const trimmed = line.trim();
        
        if(isImageUrl(trimmed)) {
            results.push(`<img class="msg-image" src="${trimmed}" alt="Bild" onclick="openLightbox('${trimmed}')" onerror="this.style.display='none'">`);
            continue;
        }
        
        const ytId = getYouTubeId(trimmed);
        if(ytId) {
            results.push(`
                <div class="msg-embed">
                    <div class="msg-embed-thumb" onclick="this.innerHTML='<iframe src=\\'https://www.youtube.com/embed/${ytId}?autoplay=1\\' allowfullscreen allow=\\'autoplay\\'></iframe>'">
                        <img src="https://img.youtube.com/vi/${ytId}/mqdefault.jpg" onerror="this.style.background='#000'">
                        <div class="msg-embed-play"><span>â–¶ï¸</span></div>
                    </div>
                    <div class="msg-embed-info">â–¶ YouTube</div>
                </div>
            `);
            continue;
        }
        
        const vimeoId = getVimeoId(trimmed);
        if(vimeoId) {
            results.push(`
                <div class="msg-embed">
                    <div class="msg-embed-thumb" onclick="this.innerHTML='<iframe src=\\'https://player.vimeo.com/video/${vimeoId}?autoplay=1\\' allowfullscreen allow=\\'autoplay\\'></iframe>'">
                        <img src="https://vumbnail.com/${vimeoId}.jpg" onerror="this.style.background='#1ab7ea'; this.style.height='180px'">
                        <div class="msg-embed-play"><span>â–¶ï¸</span></div>
                    </div>
                    <div class="msg-embed-info">â–¶ Vimeo</div>
                </div>
            `);
            continue;
        }
        
        if(isTwitterUrl(trimmed)) {
            results.push(`
                <div class="msg-embed" style="padding:10px;">
                    <div style="font-size:13px; display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <span style="font-size:18px;">ğŸ¦</span>
                        <strong>Twitter / X</strong>
                    </div>
                    <a href="${trimmed}" target="_blank" style="color:var(--primary); font-size:12px; word-break:break-all;">${trimmed}</a>
                </div>
            `);
            continue;
        }
        
        results.push(marked.parse(line));
    }
    
    return results.join('');
}

window.openLightbox = (src) => {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('show');
};

window.closeLightbox = () => {
    document.getElementById('lightbox').classList.remove('show');
};

/* ------------------------------ */
/* STATUS TEXT */
/* ------------------------------ */
window.saveStatusText = async () => {
    const statusText = document.getElementById('status-text-input').value.trim();
    localStorage.setItem('villo_status', statusText);
    try {
        await set(ref(db, `accounts/${myUsername}/status`), statusText);
        showNotification('âœ… Status gespeichert', 'success');
    } catch(e) {
        showNotification('âœ… Status lokal gespeichert', 'success');
    }
};

function initStatusText() {
    const savedStatus = localStorage.getItem('villo_status') || '';
    const input = document.getElementById('status-text-input');
    if(input) input.value = savedStatus;
}

/* ------------------------------ */
/* BUBBLE STYLE */
/* ------------------------------ */
function setBubbleStyle(style) {
    localStorage.setItem('villo_bubble_style', style);
    applyBubbleStyle(style);
    document.querySelectorAll('[data-style]').forEach(el => {
        el.classList.toggle('active', el.dataset.style === style);
    });
    const names = { rounded: 'Rund', square: 'Eckig', minimal: 'Minimal' };
    showNotification(`âœ… Bubble-Stil: ${names[style]}`, 'success');
}

function applyBubbleStyle(style) {
    document.body.classList.remove('bubble-minimal');
    if(style === 'square') {
        document.documentElement.style.setProperty('--bubble-radius', '4px');
    } else if(style === 'minimal') {
        document.documentElement.style.setProperty('--bubble-radius', '6px');
        document.body.classList.add('bubble-minimal');
    } else {
        document.documentElement.style.setProperty('--bubble-radius', '12px');
    }
}

function initBubbleStyle() {
    const saved = localStorage.getItem('villo_bubble_style') || 'rounded';
    applyBubbleStyle(saved);
    document.querySelectorAll('[data-style]').forEach(el => {
        el.classList.toggle('active', el.dataset.style === saved);
    });
}

/* ------------------------------ */
/* MUTE & ARCHIVE */
/* ------------------------------ */
function getMutedChats() { return JSON.parse(localStorage.getItem('villo_muted') || '[]'); }
function getArchivedChats() { return JSON.parse(localStorage.getItem('villo_archived') || '[]'); }

function isContactMuted(name) { return getMutedChats().includes(name); }
function isContactArchived(name) { return getArchivedChats().includes(name); }

window.toggleMuteContact = () => {
    const name = document.getElementById('info-username').textContent;
    const muted = getMutedChats();
    const idx = muted.indexOf(name);
    if(idx === -1) { muted.push(name); } else { muted.splice(idx, 1); }
    localStorage.setItem('villo_muted', JSON.stringify(muted));
    updateUserInfoButtons(name);
    showNotification(idx === -1 ? `ğŸ”‡ ${name} stummgeschaltet` : `ğŸ”Š ${name} nicht mehr stumm`, 'success');
    showApp();
};

window.toggleArchiveContact = () => {
    const name = document.getElementById('info-username').textContent;
    const archived = getArchivedChats();
    const idx = archived.indexOf(name);
    if(idx === -1) { archived.push(name); } else { archived.splice(idx, 1); }
    localStorage.setItem('villo_archived', JSON.stringify(archived));
    updateUserInfoButtons(name);
    showNotification(idx === -1 ? `ğŸ—‚ï¸ Chat archiviert` : `ğŸ“¤ Chat aus Archiv`, 'success');
    closeOverlay('user-info-overlay');
    showApp();
};

function updateUserInfoButtons(name) {
    const muteBtn = document.getElementById('btn-mute-contact');
    const archiveBtn = document.getElementById('btn-archive-contact');
    if(muteBtn) {
        const isMuted = isContactMuted(name);
        muteBtn.textContent = isMuted ? 'ğŸ”Š Laut' : 'ğŸ”‡ Stumm';
        muteBtn.style.background = isMuted ? 'var(--primary)' : 'var(--bg)';
        muteBtn.style.color = isMuted ? 'white' : 'var(--text-color)';
    }
    if(archiveBtn) {
        const isArc = isContactArchived(name);
        archiveBtn.textContent = isArc ? 'ğŸ“¤ Aus Archiv' : 'ğŸ—‚ï¸ Archivieren';
        archiveBtn.style.background = isArc ? 'var(--primary)' : 'var(--bg)';
        archiveBtn.style.color = isArc ? 'white' : 'var(--text-color)';
    }
}

/* ------------------------------ */
/* SCROLL BADGE WITH UNREAD COUNT */
/* ------------------------------ */
let unreadScrollCount = 0;

function updateScrollBadge(count) {
    unreadScrollCount = count;
    const btn = document.getElementById('scroll-to-bottom');
    if(!btn) return;
    
    let badge = btn.querySelector('.scroll-badge');
    if(count > 0) {
        if(!badge) {
            badge = document.createElement('span');
            badge.className = 'scroll-badge';
            btn.appendChild(badge);
        }
        badge.textContent = count > 99 ? '99+' : count;
        btn.classList.add('show');
    } else {
        if(badge) badge.remove();
    }
}

/* ------------------------------ */
/* GLOBAL SEARCH */
/* ------------------------------ */
window.openGlobalSearch = () => {
    document.getElementById('global-search-overlay').style.display = 'flex';
    document.getElementById('global-search-input').focus();
    document.getElementById('global-search-results').innerHTML = '';
    document.getElementById('global-search-input').value = '';
};

document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('global-search-input');
    if(input) {
        let searchTimeout;
        input.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if(query.length < 2) {
                document.getElementById('global-search-results').innerHTML = '<p style="padding:15px; opacity:0.5; text-align:center;">Mindestens 2 Zeichen eingeben</p>';
                return;
            }
            searchTimeout = setTimeout(() => globalSearch(query), 300);
        });
    }
});

async function globalSearch(query) {
    const results = document.getElementById('global-search-results');
    results.innerHTML = '<p style="padding:15px; text-align:center; opacity:0.5;">Suche lÃ¤uft<span class="loading-spinner"></span></p>';
    
    // Load contacts from Firebase
    let contacts = [];
    try {
        const snap = await get(ref(db, `accounts/${myUsername}/contacts`));
        if(snap.exists()) {
            contacts = Object.values(snap.val()).filter(Boolean);
        }
    } catch(e) {
        contacts = window._contactsCache || [];
    }
    
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    const found = [];
    const queryLower = query.toLowerCase();
    
    const searchPromises = contacts.map(async (contact) => {
        const chatId = myUsername < contact ? `${myUsername}_${contact}` : `${contact}_${myUsername}`;
        try {
            const snap = await get(ref(db, `chats/${chatId}`));
            if(snap.exists()) {
                snap.forEach(child => {
                    const m = child.val();
                    if(m.text && m.text.toLowerCase().includes(queryLower)) {
                        found.push({ contact, chatId, msgKey: child.key, text: m.text, sender: m.sender, timestamp: m.timestamp });
                    }
                });
            }
        } catch(e) {}
    });
    
    await Promise.all(searchPromises);
    
    if(found.length === 0) {
        results.innerHTML = '<p style="padding:15px; text-align:center; opacity:0.5;">Keine Ergebnisse fÃ¼r "' + query + '"</p>';
        return;
    }
    
    results.innerHTML = `<p style="padding:8px 15px; font-size:12px; opacity:0.5;">${found.length} Ergebnis${found.length !== 1 ? 'se' : ''}</p>`;
    
    found.sort((a,b) => b.timestamp - a.timestamp).slice(0, 50).forEach(item => {
        const displayName = aliases[item.contact] || item.contact;
        const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const hl = item.text.replace(new RegExp(`(${escaped})`, 'gi'), '<mark style="background:#ffeb3b; border-radius:2px;">$1</mark>');
        const preview = hl.length > 120 ? hl.substring(0, 120) + '...' : hl;
        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.innerHTML = `
            <div class="search-result-chat">${getAvatarHTML(displayName, false)} <span style="font-weight:500;">${displayName}</span></div>
            <div class="search-result-text" style="margin-top:4px;">${preview}</div>
            <div style="font-size:10px; opacity:0.4; margin-top:3px;">${new Date(item.timestamp).toLocaleString('de-DE')}</div>
        `;
        div.onclick = () => {
            closeOverlay('global-search-overlay');
            startChat(item.contact);
            setTimeout(() => {
                const el = document.getElementById(`m-${item.msgKey}`);
                if(el) {
                    el.scrollIntoView({ behavior:'smooth', block:'center' });
                    el.style.outline = '2px solid var(--primary)';
                    el.style.transition = 'outline 0.5s';
                    setTimeout(() => el.style.outline = '', 2000);
                }
            }, 1200);
        };
        results.appendChild(div);
    });
}

/* ------------------------------ */
/* USER INFO */
/* ------------------------------ */
window.openChangelog = () => {
    document.getElementById('changelog-overlay').style.display = 'flex';
};

window.openUserInfo = async (contactName) => {
    const aliases = JSON.parse(localStorage.getItem('contact_aliases') || '{}');
    const displayName = aliases[contactName] || contactName;
    const contactColors = JSON.parse(localStorage.getItem('contact_colors') || '{}');
    const avatarSettings = JSON.parse(localStorage.getItem('avatar_settings') || '{}');
    const settings = avatarSettings[contactName] || avatarCache[contactName] || {};
    
    document.getElementById('info-username').textContent = contactName;
    document.getElementById('info-alias').textContent = displayName;
    document.getElementById('info-online-status').textContent = 'â€”';
    document.getElementById('info-status-text').textContent = '';
    
    // Reset stats to loading state
    ['info-msg-count','info-emoji-stat','info-since','info-avg-len'].forEach(id => {
        document.getElementById(id).textContent = 'â€¦';
    });

    const avatar = document.getElementById('info-avatar');
    const avatarColor = settings.color || stringToColor(displayName);
    const avatarFont = settings.font || "'Playfair Display', serif";
    avatar.style.background = avatarColor;
    avatar.style.fontFamily = avatarFont;
    avatar.textContent = displayName.charAt(0).toUpperCase();
    
    const colorPicker = document.getElementById('contact-color-picker');
    colorPicker.value = contactColors[contactName] || '#ffffff';
    colorPicker.dataset.contactName = contactName;
    
    updateUserInfoButtons(contactName);
    loadContactNote(contactName);
    document.getElementById('user-info-overlay').style.display = 'flex';

    // Load online status + status text in parallel
    get(ref(db, `online/${contactName}`)).then(snap => {
        if(snap.exists()) {
            const data = snap.val();
            const isOnline = data.status && (Date.now() - data.lastSeen < 60000);
            document.getElementById('info-online-status').textContent = isOnline ? 'ğŸŸ¢ Online' : 'âš« Offline';
        } else {
            document.getElementById('info-online-status').textContent = 'âš« Offline';
        }
    });
    
    get(ref(db, `accounts/${contactName}/status`)).then(snap => {
        if(snap.exists() && snap.val()) {
            document.getElementById('info-status-text').textContent = `ğŸ’¬ "${snap.val()}"`;
        }
    });

    // Load chat stats for this contact
    const chatId = myUsername < contactName
        ? `${myUsername}_${contactName}`
        : `${contactName}_${myUsername}`;
    
    try {
        const snap = await get(ref(db, `chats/${chatId}`));
        if(!snap.exists()) {
            ['info-msg-count','info-since','info-avg-len'].forEach(id => {
                document.getElementById(id).textContent = 'â€”';
            });
            document.getElementById('info-emoji-stat').textContent = 'â€”';
            return;
        }

        let msgCount = 0;
        let totalChars = 0;
        let firstTs = null;
        const emojiCount = {};

        snap.forEach(child => {
            const m = child.val();
            if(m.sender !== contactName || m.deletedForAll) return;
            msgCount++;
            totalChars += (m.text || '').length;
            if(!firstTs || m.timestamp < firstTs) firstTs = m.timestamp;

            const emojis = (m.text || '').match(/\p{Emoji_Presentation}|\p{Extended_Pictographic}/gu) || [];
            emojis.forEach(e => { emojiCount[e] = (emojiCount[e] || 0) + 1; });
        });

        document.getElementById('info-msg-count').textContent =
            msgCount > 0 ? msgCount.toLocaleString('de-DE') : '0';

        document.getElementById('info-avg-len').textContent =
            msgCount > 0 ? Math.round(totalChars / msgCount) : 'â€”';

        document.getElementById('info-since').textContent = firstTs
            ? new Date(firstTs).toLocaleDateString('de-DE', { day:'2-digit', month:'short', year:'numeric' })
            : 'â€”';

        const topEmoji = Object.entries(emojiCount).sort((a,b) => b[1]-a[1])[0];
        document.getElementById('info-emoji-stat').textContent = topEmoji ? topEmoji[0] : 'â€”';

    } catch(e) {
        console.error('Stats error:', e);
    }
};

window.saveAvatarSettings = () => {
    // Removed - not used anymore
};

window.saveContactColor = () => {
    const picker = document.getElementById('contact-color-picker');
    const contactName = picker.dataset.contactName;
    const color = picker.value;
    
    const contactColors = JSON.parse(localStorage.getItem('contact_colors') || '{}');
    contactColors[contactName] = color;
    localStorage.setItem('contact_colors', JSON.stringify(contactColors));
    
    showNotification('âœ… Farbe gespeichert', 'success');
    closeOverlay('user-info-overlay');
    
    // Refresh chat to apply color
    if(activeContactName === contactName) {
        startChat(contactName);
    }
};

/* ------------------------------ */
/* EMOJI PICKER */
/* ------------------------------ */
const emojiCategories = {
    'Smileys': ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','ğŸ˜š','ğŸ˜™','ğŸ¥²','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ¥¸','ğŸ˜','ğŸ¤“','ğŸ§'],
    'Gesten': ['ğŸ‘‹','ğŸ¤š','ğŸ–ï¸','âœ‹','ğŸ––','ğŸ‘Œ','ğŸ¤Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡','â˜ï¸','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ‘','ğŸ¤²','ğŸ¤','ğŸ™'],
    'Herzen': ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â¤ï¸â€ğŸ”¥','â¤ï¸â€ğŸ©¹','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’'],
    'Tiere': ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸ','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦–','ğŸ¦•','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦','ğŸ¦€','ğŸ¡','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸŠ','ğŸ…','ğŸ†','ğŸ¦“','ğŸ¦','ğŸ¦§','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ¦™','ğŸ','ğŸ¦Œ','ğŸ•','ğŸ©','ğŸ¦®','ğŸˆ','ğŸ“','ğŸ¦ƒ','ğŸ¦š','ğŸ¦œ','ğŸ¦¢','ğŸ¦©','ğŸ•Šï¸','ğŸ‡','ğŸ¦','ğŸ¦¨','ğŸ¦¡','ğŸ¦¦','ğŸ¦¥','ğŸ','ğŸ€','ğŸ¿ï¸','ğŸ¦”'],
    'Essen': ['ğŸ‡','ğŸˆ','ğŸ‰','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ','ğŸ¥­','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ’','ğŸ“','ğŸ¥','ğŸ…','ğŸ¥¥','ğŸ¥‘','ğŸ†','ğŸ¥”','ğŸ¥•','ğŸŒ½','ğŸŒ¶ï¸','ğŸ¥’','ğŸ¥¬','ğŸ¥¦','ğŸ§„','ğŸ§…','ğŸ„','ğŸ¥œ','ğŸŒ°','ğŸ','ğŸ¥','ğŸ¥–','ğŸ¥¨','ğŸ¥¯','ğŸ¥','ğŸ§‡','ğŸ§€','ğŸ–','ğŸ—','ğŸ¥©','ğŸ¥“','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ¥™','ğŸ§†','ğŸ¥š','ğŸ³','ğŸ¥˜','ğŸ²','ğŸ¥£','ğŸ¥—','ğŸ¿','ğŸ§ˆ','ğŸ§‚','ğŸ¥«','ğŸ±','ğŸ˜','ğŸ™','ğŸš','ğŸ›','ğŸœ','ğŸ','ğŸ ','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¥®','ğŸ¡','ğŸ¥Ÿ','ğŸ¥ ','ğŸ¥¡','ğŸ¦€','ğŸ¦','ğŸ¦','ğŸ¦‘','ğŸ¦ª','ğŸ¦','ğŸ§','ğŸ¨','ğŸ©','ğŸª','ğŸ‚','ğŸ°','ğŸ§','ğŸ¥§','ğŸ«','ğŸ¬','ğŸ­','ğŸ®','ğŸ¯','ğŸ¼','ğŸ¥›','â˜•','ğŸµ','ğŸ¶','ğŸ¾','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥‚','ğŸ¥ƒ','ğŸ¥¤','ğŸ§ƒ','ğŸ§‰','ğŸ§Š'],
    'Sport': ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ‘','ğŸ¥','ğŸ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ£','ğŸ¤¿','ğŸ¥Š','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ‹ï¸','ğŸ¤¼','ğŸ¤¸','ğŸ¤º','â›¹ï¸','ğŸ¤¾','ğŸŒï¸','ğŸ‡','ğŸ§˜','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ§—','ğŸšµ','ğŸš´','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸','ğŸ—ï¸'],
    'Reisen': ['ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸï¸','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›','ğŸšœ','ğŸ¦¯','ğŸ¦½','ğŸ¦¼','ğŸ›´','ğŸš²','ğŸ›µ','ğŸï¸','ğŸ›º','ğŸš¨','ğŸš”','ğŸš','ğŸš˜','ğŸš–','ğŸš¡','ğŸš ','ğŸšŸ','ğŸšƒ','ğŸš‹','ğŸš','ğŸš','ğŸš„','ğŸš…','ğŸšˆ','ğŸš‚','ğŸš†','ğŸš‡','ğŸšŠ','ğŸš‰','âœˆï¸','ğŸ›«','ğŸ›¬','ğŸ›©ï¸','ğŸ’º','ğŸ›°ï¸','ğŸš','ğŸ›¸','ğŸš€','ğŸ›¶','â›µ','ğŸš¤','ğŸ›¥ï¸','ğŸ›³ï¸','â›´ï¸','ğŸš¢','âš“','â›½','ğŸš§','ğŸš¦','ğŸš¥','ğŸ—ºï¸','ğŸ—¿','ğŸ—½','ğŸ—¼','ğŸ°','ğŸ¯','ğŸŸï¸','ğŸ¡','ğŸ¢','ğŸ ','â›²','â›±ï¸','ğŸ–ï¸','ğŸï¸','ğŸœï¸','ğŸŒ‹','â›°ï¸','ğŸ”ï¸','ğŸ—»','ğŸ•ï¸','â›º','ğŸ ','ğŸ¡','ğŸ˜ï¸','ğŸšï¸','ğŸ—ï¸','ğŸ­','ğŸ¢','ğŸ¬','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸª','ğŸ«','ğŸ©','ğŸ’’','ğŸ›ï¸','â›ª','ğŸ•Œ','ğŸ•','ğŸ›•','ğŸ•‹'],
    'Objekte': ['âŒš','ğŸ“±','ğŸ“²','ğŸ’»','âŒ¨ï¸','ğŸ–¥ï¸','ğŸ–¨ï¸','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ•¹ï¸','ğŸ—œï¸','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ“¼','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ¥','ğŸ“½ï¸','ğŸï¸','ğŸ“','â˜ï¸','ğŸ“Ÿ','ğŸ“ ','ğŸ“º','ğŸ“»','ğŸ™ï¸','ğŸšï¸','ğŸ›ï¸','ğŸ§­','â±ï¸','â²ï¸','â°','ğŸ•°ï¸','âŒ›','â³','ğŸ“¡','ğŸ”‹','ğŸ”Œ','ğŸ’¡','ğŸ”¦','ğŸ•¯ï¸','ğŸª”','ğŸ§¯','ğŸ›¢ï¸','ğŸ’¸','ğŸ’µ','ğŸ’´','ğŸ’¶','ğŸ’·','ğŸ’°','ğŸ’³','ğŸ’','âš–ï¸','ğŸªœ','ğŸ§°','ğŸ”§','ğŸ”¨','âš’ï¸','ğŸ› ï¸','â›ï¸','ğŸ”©','âš™ï¸','ğŸ§±','â›“ï¸','ğŸ§²','ğŸ”«','ğŸ’£','ğŸ§¨','ğŸª“','ğŸ”ª','ğŸ—¡ï¸','âš”ï¸','ğŸ›¡ï¸','ğŸš¬','âš°ï¸','âš±ï¸','ğŸº','ğŸ”®','ğŸ“¿','ğŸ§¿','ğŸ’ˆ','âš—ï¸','ğŸ”­','ğŸ”¬','ğŸ•³ï¸','ğŸ©¹','ğŸ©º','ğŸ’Š','ğŸ’‰','ğŸ©¸','ğŸ§¬','ğŸ¦ ','ğŸ§«','ğŸ§ª','ğŸŒ¡ï¸','ğŸ§¹','ğŸ§º','ğŸ§»','ğŸš½','ğŸš°','ğŸš¿','ğŸ›','ğŸ›€','ğŸ§¼','ğŸª’','ğŸ§½','ğŸ§´','ğŸ›ï¸','ğŸ”‘','ğŸ—ï¸','ğŸšª','ğŸª‘','ğŸ›‹ï¸','ğŸ›ï¸','ğŸ›Œ','ğŸ§¸','ğŸ–¼ï¸','ğŸ›ï¸','ğŸ›’','ğŸ','ğŸˆ','ğŸ','ğŸ€','ğŸŠ','ğŸ‰','ğŸ','ğŸ®','ğŸ','ğŸ§§','âœ‰ï¸','ğŸ“©','ğŸ“¨','ğŸ“§','ğŸ’Œ','ğŸ“¥','ğŸ“¤','ğŸ“¦','ğŸ·ï¸','ğŸ“ª','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ“¯','ğŸ“œ','ğŸ“ƒ','ğŸ“„','ğŸ“‘','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ—’ï¸','ğŸ—“ï¸','ğŸ“†','ğŸ“…','ğŸ“‡','ğŸ—ƒï¸','ğŸ—³ï¸','ğŸ—„ï¸','ğŸ“‹','ğŸ“','ğŸ“‚','ğŸ—‚ï¸','ğŸ—ï¸','ğŸ“°','ğŸ““','ğŸ“”','ğŸ“’','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“š','ğŸ“–','ğŸ”–','ğŸ§·','ğŸ”—','ğŸ“','ğŸ–‡ï¸','ğŸ“','ğŸ“','ğŸ§®','ğŸ“Œ','ğŸ“','âœ‚ï¸','ğŸ–Šï¸','ğŸ–‹ï¸','âœ’ï¸','ğŸ–Œï¸','ğŸ–ï¸','ğŸ“','âœï¸','ğŸ”','ğŸ”','ğŸ”','ğŸ”','ğŸ”’','ğŸ”“'],
    'Symbole': ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ†”','âš›ï¸','ğŸ‰‘','â˜¢ï¸','â˜£ï¸','ğŸ“´','ğŸ“³','ğŸˆ¶','ğŸˆš','ğŸˆ¸','ğŸˆº','ğŸˆ·ï¸','âœ´ï¸','ğŸ†š','ğŸ’®','ğŸ‰','ãŠ™ï¸','ãŠ—ï¸','ğŸˆ´','ğŸˆµ','ğŸˆ¹','ğŸˆ²','ğŸ…°ï¸','ğŸ…±ï¸','ğŸ†','ğŸ†‘','ğŸ…¾ï¸','ğŸ†˜','âŒ','â­•','ğŸ›‘','â›”','ğŸ“›','ğŸš«','ğŸ’¯','ğŸ’¢','â™¨ï¸','ğŸš·','ğŸš¯','ğŸš³','ğŸš±','ğŸ”','ğŸ“µ','ğŸš­','â—','â•','â“','â”','â€¼ï¸','â‰ï¸','ğŸ”…','ğŸ”†','ã€½ï¸','âš ï¸','ğŸš¸','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','ğŸˆ¯','ğŸ’¹','â‡ï¸','âœ³ï¸','â','ğŸŒ','ğŸ’ ','â“‚ï¸','ğŸŒ€','ğŸ’¤','ğŸ§','ğŸš¾','â™¿','ğŸ…¿ï¸','ğŸˆ³','ğŸˆ‚ï¸','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','ğŸš¹','ğŸšº','ğŸš¼','ğŸš»','ğŸš®','ğŸ¦','ğŸ“¶','ğŸˆ','ğŸ”£','â„¹ï¸','ğŸ”¤','ğŸ”¡','ğŸ” ','ğŸ†–','ğŸ†—','ğŸ†™','ğŸ†’','ğŸ†•','ğŸ†“','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ','ğŸ”¢','#ï¸âƒ£','*ï¸âƒ£','âï¸','â–¶ï¸','â¸ï¸','â¯ï¸','â¹ï¸','âºï¸','â­ï¸','â®ï¸','â©','âª','â«','â¬','â—€ï¸','ğŸ”¼','ğŸ”½','â¡ï¸','â¬…ï¸','â¬†ï¸','â¬‡ï¸','â†—ï¸','â†˜ï¸','â†™ï¸','â†–ï¸','â†•ï¸','â†”ï¸','â†ªï¸','â†©ï¸','â¤´ï¸','â¤µï¸','ğŸ”€','ğŸ”','ğŸ”‚','ğŸ”„','ğŸ”ƒ','ğŸµ','ğŸ¶','â•','â–','â—','âœ–ï¸','â™¾ï¸','ğŸ’²','ğŸ’±','â„¢ï¸','Â©ï¸','Â®ï¸','ã€°ï¸','â°','â¿','ğŸ”š','ğŸ”™','ğŸ”›','ğŸ”','ğŸ”œ','âœ”ï¸','â˜‘ï¸','ğŸ”˜','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âš«','âšª','ğŸŸ¤','ğŸ”º','ğŸ”»','ğŸ”¸','ğŸ”¹','ğŸ”¶','ğŸ”·','ğŸ”³','ğŸ”²','â–ªï¸','â–«ï¸','â—¾','â—½','â—¼ï¸','â—»ï¸','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','â¬›','â¬œ','ğŸŸ«','ğŸ”ˆ','ğŸ”‡','ğŸ”‰','ğŸ”Š','ğŸ””','ğŸ”•','ğŸ“£','ğŸ“¢','ğŸ’¬','ğŸ’­','ğŸ—¯ï¸','â™ ï¸','â™£ï¸','â™¥ï¸','â™¦ï¸','ğŸƒ','ğŸ´','ğŸ€„','ğŸ•','ğŸ•‘','ğŸ•’','ğŸ•“','ğŸ•”','ğŸ••','ğŸ•–','ğŸ•—','ğŸ•˜','ğŸ•™','ğŸ•š','ğŸ•›','ğŸ•œ','ğŸ•','ğŸ•','ğŸ•Ÿ','ğŸ• ','ğŸ•¡','ğŸ•¢','ğŸ•£','ğŸ•¤','ğŸ•¥','ğŸ•¦','ğŸ•§'],
    'Flaggen': ['ğŸ³ï¸','ğŸ´','ğŸ´â€â˜ ï¸','ğŸ','ğŸš©','ğŸ³ï¸â€ğŸŒˆ','ğŸ³ï¸â€âš§ï¸','ğŸ‡¦ğŸ‡¨','ğŸ‡¦ğŸ‡©','ğŸ‡¦ğŸ‡ª','ğŸ‡¦ğŸ‡«','ğŸ‡¦ğŸ‡¬','ğŸ‡¦ğŸ‡®','ğŸ‡¦ğŸ‡±','ğŸ‡¦ğŸ‡²','ğŸ‡¦ğŸ‡´','ğŸ‡¦ğŸ‡¶','ğŸ‡¦ğŸ‡·','ğŸ‡¦ğŸ‡¸','ğŸ‡¦ğŸ‡¹','ğŸ‡¦ğŸ‡º','ğŸ‡¦ğŸ‡¼','ğŸ‡¦ğŸ‡½','ğŸ‡¦ğŸ‡¿','ğŸ‡§ğŸ‡¦','ğŸ‡§ğŸ‡§','ğŸ‡§ğŸ‡©','ğŸ‡§ğŸ‡ª','ğŸ‡§ğŸ‡«','ğŸ‡§ğŸ‡¬','ğŸ‡§ğŸ‡­','ğŸ‡§ğŸ‡®','ğŸ‡§ğŸ‡¯','ğŸ‡§ğŸ‡±','ğŸ‡§ğŸ‡²','ğŸ‡§ğŸ‡³','ğŸ‡§ğŸ‡´','ğŸ‡§ğŸ‡¶','ğŸ‡§ğŸ‡·','ğŸ‡§ğŸ‡¸','ğŸ‡§ğŸ‡¹','ğŸ‡§ğŸ‡»','ğŸ‡§ğŸ‡¼','ğŸ‡§ğŸ‡¾','ğŸ‡§ğŸ‡¿','ğŸ‡¨ğŸ‡¦','ğŸ‡¨ğŸ‡¨','ğŸ‡¨ğŸ‡©','ğŸ‡¨ğŸ‡«','ğŸ‡¨ğŸ‡¬','ğŸ‡¨ğŸ‡­','ğŸ‡¨ğŸ‡®','ğŸ‡¨ğŸ‡°','ğŸ‡¨ğŸ‡±','ğŸ‡¨ğŸ‡²','ğŸ‡¨ğŸ‡³','ğŸ‡¨ğŸ‡´','ğŸ‡¨ğŸ‡µ','ğŸ‡¨ğŸ‡·','ğŸ‡¨ğŸ‡º','ğŸ‡¨ğŸ‡»','ğŸ‡¨ğŸ‡¼','ğŸ‡¨ğŸ‡½','ğŸ‡¨ğŸ‡¾','ğŸ‡¨ğŸ‡¿','ğŸ‡©ğŸ‡ª','ğŸ‡©ğŸ‡¬','ğŸ‡©ğŸ‡¯','ğŸ‡©ğŸ‡°','ğŸ‡©ğŸ‡²','ğŸ‡©ğŸ‡´','ğŸ‡©ğŸ‡¿','ğŸ‡ªğŸ‡¦','ğŸ‡ªğŸ‡¨','ğŸ‡ªğŸ‡ª','ğŸ‡ªğŸ‡¬','ğŸ‡ªğŸ‡­','ğŸ‡ªğŸ‡·','ğŸ‡ªğŸ‡¸','ğŸ‡ªğŸ‡¹','ğŸ‡ªğŸ‡º','ğŸ‡«ğŸ‡®','ğŸ‡«ğŸ‡¯','ğŸ‡«ğŸ‡°','ğŸ‡«ğŸ‡²','ğŸ‡«ğŸ‡´','ğŸ‡«ğŸ‡·','ğŸ‡¬ğŸ‡¦','ğŸ‡¬ğŸ‡§','ğŸ‡¬ğŸ‡©','ğŸ‡¬ğŸ‡ª','ğŸ‡¬ğŸ‡«','ğŸ‡¬ğŸ‡¬','ğŸ‡¬ğŸ‡­','ğŸ‡¬ğŸ‡®','ğŸ‡¬ğŸ‡±','ğŸ‡¬ğŸ‡²','ğŸ‡¬ğŸ‡³','ğŸ‡¬ğŸ‡µ','ğŸ‡¬ğŸ‡¶','ğŸ‡¬ğŸ‡·','ğŸ‡¬ğŸ‡¸','ğŸ‡¬ğŸ‡¹','ğŸ‡¬ğŸ‡º','ğŸ‡¬ğŸ‡¼','ğŸ‡¬ğŸ‡¾','ğŸ‡­ğŸ‡°','ğŸ‡­ğŸ‡²','ğŸ‡­ğŸ‡³','ğŸ‡­ğŸ‡·','ğŸ‡­ğŸ‡¹','ğŸ‡­ğŸ‡º','ğŸ‡®ğŸ‡¨','ğŸ‡®ğŸ‡©','ğŸ‡®ğŸ‡ª','ğŸ‡®ğŸ‡±','ğŸ‡®ğŸ‡²','ğŸ‡®ğŸ‡³','ğŸ‡®ğŸ‡´','ğŸ‡®ğŸ‡¶','ğŸ‡®ğŸ‡·','ğŸ‡®ğŸ‡¸','ğŸ‡®ğŸ‡¹','ğŸ‡¯ğŸ‡ª','ğŸ‡¯ğŸ‡²','ğŸ‡¯ğŸ‡´','ğŸ‡¯ğŸ‡µ','ğŸ‡°ğŸ‡ª','ğŸ‡°ğŸ‡¬','ğŸ‡°ğŸ‡­','ğŸ‡°ğŸ‡®','ğŸ‡°ğŸ‡²','ğŸ‡°ğŸ‡³','ğŸ‡°ğŸ‡µ','ğŸ‡°ğŸ‡·','ğŸ‡°ğŸ‡¼','ğŸ‡°ğŸ‡¾','ğŸ‡°ğŸ‡¿','ğŸ‡±ğŸ‡¦','ğŸ‡±ğŸ‡§','ğŸ‡±ğŸ‡¨','ğŸ‡±ğŸ‡®','ğŸ‡±ğŸ‡°','ğŸ‡±ğŸ‡·','ğŸ‡±ğŸ‡¸','ğŸ‡±ğŸ‡¹','ğŸ‡±ğŸ‡º','ğŸ‡±ğŸ‡»','ğŸ‡±ğŸ‡¾','ğŸ‡²ğŸ‡¦','ğŸ‡²ğŸ‡¨','ğŸ‡²ğŸ‡©','ğŸ‡²ğŸ‡ª','ğŸ‡²ğŸ‡«','ğŸ‡²ğŸ‡¬','ğŸ‡²ğŸ‡­','ğŸ‡²ğŸ‡°','ğŸ‡²ğŸ‡±','ğŸ‡²ğŸ‡²','ğŸ‡²ğŸ‡³','ğŸ‡²ğŸ‡´','ğŸ‡²ğŸ‡µ','ğŸ‡²ğŸ‡¶','ğŸ‡²ğŸ‡·','ğŸ‡²ğŸ‡¸','ğŸ‡²ğŸ‡¹','ğŸ‡²ğŸ‡º','ğŸ‡²ğŸ‡»','ğŸ‡²ğŸ‡¼','ğŸ‡²ğŸ‡½','ğŸ‡²ğŸ‡¾','ğŸ‡²ğŸ‡¿','ğŸ‡³ğŸ‡¦','ğŸ‡³ğŸ‡¨','ğŸ‡³ğŸ‡ª','ğŸ‡³ğŸ‡«','ğŸ‡³ğŸ‡¬','ğŸ‡³ğŸ‡®','ğŸ‡³ğŸ‡±','ğŸ‡³ğŸ‡´','ğŸ‡³ğŸ‡µ','ğŸ‡³ğŸ‡·','ğŸ‡³ğŸ‡º','ğŸ‡³ğŸ‡¿','ğŸ‡´ğŸ‡²','ğŸ‡µğŸ‡¦','ğŸ‡µğŸ‡ª','ğŸ‡µğŸ‡«','ğŸ‡µğŸ‡¬','ğŸ‡µğŸ‡­','ğŸ‡µğŸ‡°','ğŸ‡µğŸ‡±','ğŸ‡µğŸ‡²','ğŸ‡µğŸ‡³','ğŸ‡µğŸ‡·','ğŸ‡µğŸ‡¸','ğŸ‡µğŸ‡¹','ğŸ‡µğŸ‡¼','ğŸ‡µğŸ‡¾','ğŸ‡¶ğŸ‡¦','ğŸ‡·ğŸ‡ª','ğŸ‡·ğŸ‡´','ğŸ‡·ğŸ‡¸','ğŸ‡·ğŸ‡º','ğŸ‡·ğŸ‡¼','ğŸ‡¸ğŸ‡¦','ğŸ‡¸ğŸ‡§','ğŸ‡¸ğŸ‡¨','ğŸ‡¸ğŸ‡©','ğŸ‡¸ğŸ‡ª','ğŸ‡¸ğŸ‡¬','ğŸ‡¸ğŸ‡­','ğŸ‡¸ğŸ‡®','ğŸ‡¸ğŸ‡¯','ğŸ‡¸ğŸ‡°','ğŸ‡¸ğŸ‡±','ğŸ‡¸ğŸ‡²','ğŸ‡¸ğŸ‡³','ğŸ‡¸ğŸ‡´','ğŸ‡¸ğŸ‡·','ğŸ‡¸ğŸ‡¸','ğŸ‡¸ğŸ‡¹','ğŸ‡¸ğŸ‡»','ğŸ‡¸ğŸ‡½','ğŸ‡¸ğŸ‡¾','ğŸ‡¸ğŸ‡¿','ğŸ‡¹ğŸ‡¦','ğŸ‡¹ğŸ‡¨','ğŸ‡¹ğŸ‡©','ğŸ‡¹ğŸ‡«','ğŸ‡¹ğŸ‡¬','ğŸ‡¹ğŸ‡­','ğŸ‡¹ğŸ‡¯','ğŸ‡¹ğŸ‡°','ğŸ‡¹ğŸ‡±','ğŸ‡¹ğŸ‡²','ğŸ‡¹ğŸ‡³','ğŸ‡¹ğŸ‡´','ğŸ‡¹ğŸ‡·','ğŸ‡¹ğŸ‡¹','ğŸ‡¹ğŸ‡»','ğŸ‡¹ğŸ‡¼','ğŸ‡¹ğŸ‡¿','ğŸ‡ºğŸ‡¦','ğŸ‡ºğŸ‡¬','ğŸ‡ºğŸ‡²','ğŸ‡ºğŸ‡³','ğŸ‡ºğŸ‡¸','ğŸ‡ºğŸ‡¾','ğŸ‡ºğŸ‡¿','ğŸ‡»ğŸ‡¦','ğŸ‡»ğŸ‡¨','ğŸ‡»ğŸ‡ª','ğŸ‡»ğŸ‡¬','ğŸ‡»ğŸ‡®','ğŸ‡»ğŸ‡³','ğŸ‡»ğŸ‡º','ğŸ‡¼ğŸ‡«','ğŸ‡¼ğŸ‡¸','ğŸ‡½ğŸ‡°','ğŸ‡¾ğŸ‡ª','ğŸ‡¾ğŸ‡¹','ğŸ‡¿ğŸ‡¦','ğŸ‡¿ğŸ‡²','ğŸ‡¿ğŸ‡¼','ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿','ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿','ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿']
};

let allEmojis = [];
Object.values(emojiCategories).forEach(cat => allEmojis.push(...cat));

function populateEmojiGrid(search = '') {
    const grid = document.getElementById('emoji-grid');
    grid.innerHTML = '';
    
    const filtered = search ? allEmojis.filter(e => e.includes(search)) : allEmojis;
    
    filtered.forEach(emoji => {
        const span = document.createElement('span');
        span.className = 'emoji-item';
        span.textContent = emoji;
        span.onclick = () => insertEmoji(emoji);
        grid.appendChild(span);
    });
}

window.openEmojiPicker = () => {
    document.getElementById('emoji-overlay').style.display = 'flex';
    document.getElementById('emoji-search').value = '';
    
    // Reset to emoji tab
    currentEmojiTab = 'emoji';
    document.getElementById('tab-emoji').style.borderBottom = '2px solid var(--primary)';
    document.getElementById('tab-emoji').style.fontWeight = '600';
    document.getElementById('tab-emoji').style.opacity = '1';
    document.getElementById('tab-symbols').style.borderBottom = '2px solid transparent';
    document.getElementById('tab-symbols').style.fontWeight = '400';
    document.getElementById('tab-symbols').style.opacity = '0.5';
    
    populateEmojiGrid();
};

let emojiTarget = null; // null = default msg-input, otherwise target element id

function insertEmoji(emoji) {
    const targetId = emojiTarget || 'msg-input';
    const input = document.getElementById(targetId);
    emojiTarget = null;
    closeOverlay('emoji-overlay');
    if(!input) return;
    const start = input.selectionStart ?? input.value.length;
    const end = input.selectionEnd ?? input.value.length;
    input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
    input.focus();
    input.selectionStart = input.selectionEnd = start + emoji.length;
    // Trigger oninput handlers
    input.dispatchEvent(new Event('input'));
}

// Emoji search
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('emoji-search');
    if(searchInput) {
        searchInput.addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            if(currentEmojiTab === 'symbols') {
                const grid = document.getElementById('emoji-grid');
                const filtered = search ? symbols.filter(s => s.includes(search)) : symbols;
                grid.innerHTML = filtered.map(s => 
                    `<span style="font-size:24px; cursor:pointer; text-align:center; padding:8px;" onclick="insertSymbol('${s}')">${s}</span>`
                ).join('');
            } else {
                populateEmojiGrid(search);
            }
        });
    }
});

/* ------------------------------ */
/* AUTO-LOGIN */
/* ------------------------------ */
/* ========================================= */
/* V4 DESKTOP FEATURES */
/* ========================================= */

/* RESIZABLE SIDEBAR */
let isResizing = false;
function initResizableSidebar() {
    const handle = document.getElementById('resize-handle');
    const sidebar = document.getElementById('sidebar');
    if(!handle || window.innerWidth < 768) return;
    
    // Load saved width
    const saved = localStorage.getItem('villo_sidebar_width');
    if(saved) {
        document.documentElement.style.setProperty('--sidebar-width', saved + 'px');
    }
    
    handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    });
    
    document.addEventListener('mousemove', (e) => {
        if(!isResizing) return;
        const newWidth = Math.max(250, Math.min(600, e.clientX));
        document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
    });
    
    document.addEventListener('mouseup', () => {
        if(isResizing) {
            const width = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
            localStorage.setItem('villo_sidebar_width', parseInt(width));
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });
}

/* FOCUS MODE */
window.toggleFocusMode = () => {
    document.body.classList.toggle('focus-mode');
    const isFocus = document.body.classList.contains('focus-mode');
    showNotification(isFocus ? 'ğŸ¯ Focus-Modus aktiv' : 'â†©ï¸ Focus-Modus deaktiviert', 'success');
};

/* ENHANCED KEYBOARD SHORTCUTS FOR V4 */
function initV4Shortcuts() {
    document.addEventListener('keydown', (e) => {
        // Ctrl+Shift+F: Toggle focus mode
        if(e.ctrlKey && e.shiftKey && e.key === 'F') {
            e.preventDefault();
            if(window.innerWidth >= 768) toggleFocusMode();
        }
    });
}

window.onload = () => {
    // Initialize theme
    const theme = localStorage.getItem('villo_theme') || 'system';
    applyTheme(theme);
    
    // Initialize accent color
    initAccentColorPicker();
    
    // Initialize font size
    initFontSize();
    
    // Initialize bubble color
    initBubbleColor();
    
    // Initialize sound
    initSound();
    
    // Initialize bubble style
    initBubbleStyle();
    
    // Initialize status text
    initStatusText();
    
    // Initialize quick reactions
    initQuickReactions();
    
    // Initialize V4 desktop features
    initResizableSidebar();
    initV4Shortcuts();
    
    // Initialize swipe back gesture
    initSwipeBack();
    
    // QR Auto-Login via ?login&name=...&pw=...
    const qrParams = new URLSearchParams(location.search);
    if(location.search.includes('login') && qrParams.get('name') && qrParams.get('pw')) {
        const qrName = qrParams.get('name');
        const qrPw = qrParams.get('pw');
        history.replaceState({}, '', location.pathname); // Clean URL
        (async () => {
            const snap = await get(ref(db, `accounts/${qrName}`));
            if(snap.exists() && snap.val().pin === qrPw) {
                await signInAnonymously(auth);
                myUsername = qrName;
                localStorage.setItem('villo_session', qrName);
                updateOnlineStatus();
                showApp();
                showNotification(`âœ… Willkommen, ${qrName}!`, 'success');
            } else {
                showNotification('âŒ QR-Login ungÃ¼ltig', 'error');
            }
        })();
        return; // Skip session restore below
    }

    const s = localStorage.getItem('villo_session');
    if(s){ 
        myUsername = s; 
        signInAnonymously(auth).then(() => {
            updateOnlineStatus();
            showApp();
        });
    }
    
    // Setup auth tab listeners
    document.getElementById('t-login').addEventListener('click', () => setAuth('login'));
    document.getElementById('t-reg').addEventListener('click', () => setAuth('register'));
    
    // Initialize scroll button
    setTimeout(initScrollButton, 1000);
    
    // Global keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in input fields (except ESC)
        const inInput = ['INPUT','TEXTAREA'].includes(e.target.tagName);
        
        // Ctrl/Cmd + K: Focus search
        if((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('search-input').focus();
        }
        
        // Ctrl/Cmd + F: Search in chat
        if((e.ctrlKey || e.metaKey) && e.key === 'f' && activeChatId) {
            e.preventDefault();
            searchInChat();
        }
        
        // Ctrl/Cmd + E: Export chat
        if((e.ctrlKey || e.metaKey) && e.key === 'e' && activeChatId) {
            e.preventDefault();
            exportChat();
        }
        
        // Ctrl/Cmd + B: Open user info
        if((e.ctrlKey || e.metaKey) && e.key === 'b' && activeChatId && activeContactName) {
            e.preventDefault();
            openUserInfo(activeContactName);
        }
        
        // Ctrl/Cmd + D: Delete last own message in active chat
        if((e.ctrlKey || e.metaKey) && e.key === 'd' && activeChatId && !inInput) {
            e.preventDefault();
            const msgs = document.querySelectorAll('.msg.sent');
            if(msgs.length > 0) {
                const lastMsg = msgs[msgs.length - 1];
                const msgKey = lastMsg.dataset.msgKey;
                if(msgKey) deleteMsg(msgKey);
            }
        }
        
        // Ctrl/Cmd + R: Reply to last message in active chat
        if((e.ctrlKey || e.metaKey) && e.key === 'r' && activeChatId && !inInput) {
            e.preventDefault();
            const msgs = document.querySelectorAll('.msg');
            if(msgs.length > 0) {
                const lastMsg = msgs[msgs.length - 1];
                const msgKey = lastMsg.dataset.msgKey;
                const msgText = lastMsg.dataset.msgText;
                const msgSender = lastMsg.dataset.msgSender;
                if(msgKey && msgText) replyToMsg(msgKey, msgSender, msgText);
            }
        }
        
        // Ctrl/Cmd + P: Toggle pin on last message
        if((e.ctrlKey || e.metaKey) && e.key === 'p' && activeChatId && !inInput) {
            e.preventDefault();
            const msgs = document.querySelectorAll('.msg');
            if(msgs.length > 0) {
                const lastMsg = msgs[msgs.length - 1];
                const msgKey = lastMsg.dataset.msgKey;
                const msgText = lastMsg.dataset.msgText;
                if(!msgKey || !msgText) return;
                const pinnedKey = `pinned_${activeChatId}`;
                const currentPinned = localStorage.getItem(pinnedKey);
                if(currentPinned === msgKey) unpinMessage();
                else pinMessage(msgKey, msgText);
            }
        }
        
        // Escape: Close overlays, edit mode, reply bar, or chat
        if(e.key === 'Escape') {
            // Cancel edit mode first
            if(editingMessageKey) {
                cancelEdit();
                return;
            }
            // Cancel reply
            if(replyingTo) {
                cancelReply();
                return;
            }
            // Close context menu
            const ctxMenu = document.getElementById('msg-context-menu');
            if(ctxMenu && ctxMenu.classList.contains('show')) {
                ctxMenu.classList.remove('show');
                return;
            }
            // Close overlays
            const overlays = ['settings-overlay', 'confirm-overlay', 'search-overlay', 'chat-search-overlay', 
                              'alias-overlay', 'user-info-overlay', 'emoji-picker', 'poll-overlay', 
                              'change-pin-overlay', 'help-overlay', 'global-search-overlay', 
                              'forward-overlay', 'my-profile-overlay', 'changelog-overlay',
                              'group-create-overlay', 'group-info-overlay', 'msg-info-overlay', 'scheduled-overlay', 'story-create-overlay', 'qr-pin-overlay'];
            let anyOpen = false;
            overlays.forEach(id => {
                const el = document.getElementById(id);
                if(el && el.style.display === 'flex') {
                    closeOverlay(id);
                    anyOpen = true;
                }
            });
            if(anyOpen) return;
            
            // Close chat menu
            if(document.getElementById('chat-menu').classList.contains('show')) {
                toggleChatMenu();
                return;
            }
            
            // Finally close chat if in chat
            if(activeChatId) closeChat();
        }
        
        // Ctrl/Cmd + ,: Open settings
        if((e.ctrlKey || e.metaKey) && e.key === ',') {
            e.preventDefault();
            openSettings();
        }
    });
    
    // PWA Service Worker Registration & Install Prompt
    if('serviceWorker' in navigator) {
        const swCode = `
            self.addEventListener('install', e => { self.skipWaiting(); });
            self.addEventListener('activate', e => { self.clients.claim(); });
            self.addEventListener('fetch', e => { 
                if(e.request.method === 'GET') {
                    e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
                }
            });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).then(() => {
            console.log('âœ… Service Worker registered');
        }).catch(e => console.log('SW failed:', e));
    }
    

    // â”€â”€ Gruppen-Chat Ã¶ffnen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.startGroupChat = async function(gid, gname) {
        if(chatRef) off(chatRef);
        if(typingRef) off(typingRef);
        if(onlineStatusListener) off(onlineStatusListener);

        activeChatId = gid;
        activeGroupId = gid;
        activeContactName = gname;

        // Hide badge
        const badge = document.getElementById(`group-badge-${gid}`);
        if(badge) badge.style.display = 'none';

        // Show group info menu item
        const groupMenuItem = document.getElementById('menu-group-info');
        if(groupMenuItem) groupMenuItem.style.display = '';

        // Header (initially with fallback, updated after Firebase load)
        document.getElementById('chat-header').innerHTML = `
            <div style="display:flex;align-items:center; flex:1; cursor:pointer;" onclick="openGroupInfo()">
                <div class="avatar" id="group-chat-avatar" style="background:${stringToColor(gname)}; font-size:20px; width:36px; height:36px; margin-right:10px;">ğŸ‘¥</div>
                <div>
                    <div>${gname}</div>
                    <div id="group-member-count" style="font-size:11px; opacity:0.6;"></div>
                </div>
            </div>
        `;

        // Load group data for header count + avatar
        const gSnap = await get(ref(db, `groups/${gid}`));
        if(gSnap.exists()) {
            const gData = gSnap.val();
            const members = Object.keys(gData.members || {});
            const countEl = document.getElementById('group-member-count');
            if(countEl) countEl.textContent = `${members.length} Mitglieder`;
            const avatarEl = document.getElementById('group-chat-avatar');
            if(avatarEl) avatarEl.textContent = gData.avatar || 'ğŸ‘¥';
        }

        // Reset encryption notice
        const encNotice = document.getElementById('encryption-notice');
        if(encNotice) { encNotice.classList.remove('hidden'); setTimeout(() => encNotice.classList.add('hidden'), 4000); }

        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = '';
        const emptyState = document.getElementById('empty-chat-state');
        if(emptyState) emptyState.style.display = 'none';

        document.getElementById('chat-area').classList.add('chat-open');
        document.title = `VilloChat - ${gname}`;

        const contactColors = JSON.parse(localStorage.getItem('contact_colors') || '{}');
        let lastDate = '';
        let isInitialLoad = true;
        const shouldAutoScroll = () => {
            const c = messagesContainer;
            return isInitialLoad || (c.scrollHeight - c.scrollTop - c.clientHeight < 120);
        };

        chatRef = ref(db, `chats/${gid}`);

        onChildAdded(chatRef, (s) => {
            const m = s.val();
            const msgDate = getDateLabel(m.timestamp);

            if(msgDate !== lastDate) {
                const sep = document.createElement('div');
                sep.className = 'date-separator';
                sep.innerHTML = `<span>${msgDate}</span>`;
                messagesContainer.appendChild(sep);
                lastDate = msgDate;
            }

            const d = document.createElement('div');
            d.className = 'msg ' + (m.sender === myUsername ? 'sent' : 'received');
            d.id = 'm-' + s.key;
            d.dataset.msgKey = s.key;
            d.dataset.msgText = m.text || '';
            d.dataset.msgSender = m.sender;

            const time = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const fullDate = new Date(m.timestamp).toLocaleString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});

            // Group: show sender name above received messages
            if(m.sender !== myUsername) {
                const senderLabel = document.createElement('div');
                senderLabel.style.cssText = `font-size:11px; font-weight:600; color:${stringToColor(m.sender)}; margin-bottom:2px; margin-left:4px;`;
                senderLabel.textContent = m.sender;
                d.prepend(senderLabel); // temporary, renderMessageEl will overwrite
            }

            renderGroupMessageEl(d, m, s.key, time, fullDate, contactColors);

            d.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, s.key, m.text, m.sender);
            });
            let pressTimer;
            d.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => showMessageContextMenu(e.touches[0], s.key, m.text, m.sender), 500);
            });
            d.addEventListener('touchend', () => clearTimeout(pressTimer));
            d.addEventListener('touchmove', () => clearTimeout(pressTimer));

            messagesContainer.appendChild(d);
            if(shouldAutoScroll()) messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Mark as read in Firebase (track per-user read timestamps)
            if(m.sender !== myUsername) {
                update(ref(db, `chats/${gid}/${s.key}/readBy`), { [myUsername]: Date.now() });
            }
        });

        onChildChanged(chatRef, (s) => {
            const m = s.val();
            const el = document.getElementById(`m-${s.key}`);
            if(!el) return;
            const time = new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            const fullDate = new Date(m.timestamp).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
            el.dataset.msgText = m.text || '';
            renderGroupMessageEl(el, m, s.key, time, fullDate, contactColors);
        });

        onChildRemoved(chatRef, s => {
            const el = document.getElementById('m-' + s.key);
            if(el) el.remove();
        });

        // Group typing indicator â€” show all who are typing
        typingRef = ref(db, `typing/${gid}`);
        onValue(typingRef, s => {
            if(!s.exists()) { document.getElementById('typing-status').innerText = ''; return; }
            const typing = Object.entries(s.val())
                .filter(([user, v]) => v && user !== myUsername)
                .map(([user]) => user);
            document.getElementById('typing-status').innerText = typing.length
                ? typing.join(', ') + (typing.length === 1 ? ' schreibt...' : ' schreiben...')
                : '';
        });

        requestAnimationFrame(() => { isInitialLoad = false; });
        setTimeout(initScrollButton, 100);
        setTimeout(loadPinnedMessage, 300);
    }

    // â”€â”€ Render group message (with sender label for received) â”€â”€â”€â”€â”€
    window.renderGroupMessageEl = function(d, m, msgKey, time, fullDate, contactColors) {
        if(m.deletedForAll) {
            d.innerHTML = `<em style="opacity:0.4; font-size:12px;">ğŸ—‘ï¸ Nachricht gelÃ¶scht</em>`;
            d.style.background = 'transparent';
            d.style.boxShadow = 'none';
            return;
        }
        d.style.background = '';
        d.style.boxShadow = '';

        let senderLabel = '';
        if(m.sender !== myUsername) {
            senderLabel = `<div style="font-size:11px; font-weight:600; color:${stringToColor(m.sender)}; margin-bottom:2px;">${m.sender}</div>`;
        }

        let replyHTML = '';
        if(m.replyTo) {
            replyHTML = `<div class="reply-quote"><div class="reply-sender">${m.replyTo.sender}</div><div>${m.replyTo.text.substring(0,50)}${m.replyTo.text.length>50?'...':''}</div></div>`;
        }

        let reactionsHTML = '';
        if(m.reactions) {
            reactionsHTML = '<div class="msg-reactions">';
            Object.entries(m.reactions).forEach(([emoji, users]) => {
                const hasMyReaction = users.includes(myUsername);
                const escapedEmoji = emoji.replace(/'/g, '&apos;');
                reactionsHTML += `<span class="msg-reaction ${hasMyReaction?'my-reaction':''}" data-msgkey="${msgKey}" data-emoji="${escapedEmoji}">${emoji} ${users.length}</span>`;
            });
            reactionsHTML += '</div>';
        }

        const checkmark = m.sender === myUsername ? `<span class="msg-status check-sent">âœ“</span>` : '';
        const editedMark = m.edited ? '<span class="msg-edited">(bearbeitet)</span>' : '';
        const safeText = (m.text||'').replace(/`/g,'\\`');
        const replyIcon = `<span class="msg-menu" onclick="replyToMsg('${msgKey}','${m.sender}',\`${safeText}\`)">â†©ï¸</span>`;
        const delIcon = m.sender === myUsername ? `<span class="del-msg" style="cursor:pointer;" onclick="deleteMsg('${msgKey}')">ğŸ—‘</span>` : '';

        if(m.poll) {
            d.innerHTML = `${senderLabel}${replyHTML}${renderPoll(msgKey, m.poll)}${reactionsHTML}<span class="msg-time"><span class="full-date">${fullDate}</span>${time} ${checkmark} ${replyIcon} ${delIcon}</span>`;
            return;
        }

        d.innerHTML = `${senderLabel}${replyHTML}${renderMessageContent(m.text||'')}${reactionsHTML}<span class="msg-time"><span class="full-date">${fullDate}</span>${time} ${editedMark} ${checkmark} ${replyIcon} ${delIcon}</span>`;
    }

    // â”€â”€ Gruppe erstellen Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.openGroupCreate = () => {
        selectedGroupMembers = [];
        document.getElementById('group-name-input').value = '';
        document.getElementById('group-member-results').innerHTML = '';
        document.getElementById('group-selected-members').innerHTML = '';
        document.getElementById('group-create-overlay').style.display = 'flex';
    };

    document.getElementById('group-member-search').addEventListener('input', async (e) => {
        const s = e.target.value.trim();
        const results = document.getElementById('group-member-results');
        if(!s) { results.innerHTML = ''; return; }
        const found = await searchContactsPartial(s, [myUsername, ...selectedGroupMembers]);
        renderContactSearchResults(found, results, (name) => {
            window.addGroupMember(name);
        });
    });

    document.getElementById('btn-group-member-search').onclick = () => {}; // kept for layout, search is now live

    // Allow enter to pick first result
    document.getElementById('group-member-search').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
            const first = document.querySelector('#group-member-results .contact-item');
            if(first) first.click();
        }
    });

    window.addGroupMember = function(name) {
        if(selectedGroupMembers.includes(name)) return;
        selectedGroupMembers.push(name);
        window.renderSelectedMembers();
        document.getElementById('group-member-results').innerHTML = '';
        document.getElementById('group-member-search').value = '';
    }

    window.renderSelectedMembers = function() {
        const container = document.getElementById('group-selected-members');
        container.innerHTML = '';
        selectedGroupMembers.forEach(name => {
            const tag = document.createElement('div');
            tag.style.cssText = `display:flex; align-items:center; gap:5px; background:var(--primary); color:white; border-radius:20px; padding:4px 10px; font-size:13px;`;
            tag.innerHTML = `${name} <span style="cursor:pointer; opacity:0.8;" onclick="removeGroupMember('${name}')">âœ•</span>`;
            container.appendChild(tag);
        });
    }

    window.removeGroupMember = (name) => {
        selectedGroupMembers = selectedGroupMembers.filter(m => m !== name);
        window.renderSelectedMembers();
    };

    document.getElementById('btn-group-create-confirm').onclick = async () => {
        const name = document.getElementById('group-name-input').value.trim();
        if(!name) { showNotification('âŒ Bitte Gruppenname eingeben', 'error'); return; }
        if(selectedGroupMembers.length === 0) { showNotification('âŒ Mindestens 1 Mitglied hinzufÃ¼gen', 'error'); return; }

        const btn = document.getElementById('btn-group-create-confirm');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>';

        try {
            const allMembers = [myUsername, ...selectedGroupMembers];
            const groupRef_new = push(ref(db, 'groups'));
            const gid = groupRef_new.key;

            await set(groupRef_new, {
                name,
                createdBy: myUsername,
                createdAt: Date.now(),
                members: Object.fromEntries(allMembers.map(m => [m, true])),
                admins: { [myUsername]: true }
            });

            // Add group to all members' accounts
            for(const member of allMembers) {
                await push(ref(db, `accounts/${member}/groups`), gid);
            }

            closeOverlay('group-create-overlay');
            showNotification(`âœ… Gruppe "${name}" erstellt!`, 'success');

            // Open the new group chat
            setTimeout(() => window.startGroupChat(gid, name), 300);
        } catch(e) {
            showNotification('âŒ Fehler beim Erstellen', 'error');
        }
        btn.disabled = false;
        btn.innerHTML = 'âœ… Gruppe erstellen';
    };

    // â”€â”€ Gruppeninfo anzeigen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.openGroupInfo = async () => {
        if(!activeGroupId) return;
        const gSnap = await get(ref(db, `groups/${activeGroupId}`));
        if(!gSnap.exists()) return;
        const g = gSnap.val();
        const members = Object.keys(g.members || {}).filter(m => g.members[m] === true);
        const admins = g.admins ? Object.keys(g.admins).filter(a => g.admins[a] === true) : [];
        // Ersteller ist immer Admin, auch bei alten Gruppen ohne admins-Feld
        if(g.createdBy && !admins.includes(g.createdBy)) admins.push(g.createdBy);
        const moderators = g.moderators ? Object.keys(g.moderators).filter(m => g.moderators[m] === true) : [];
        const isAdmin = admins.includes(myUsername);
        const isModerator = moderators.includes(myUsername);
        const canManage = isAdmin || isModerator;
        const avatar = g.avatar || 'ğŸ‘¥';

        const GROUP_EMOJIS = ['ğŸ‘¥','ğŸ®','ğŸµ','ğŸ€','ğŸ•','âœˆï¸','ğŸ’¼','ğŸ“','â¤ï¸','âš½','ğŸŒ','ğŸ”¥','ğŸ‰','ğŸ ','ğŸ¤','ğŸ¨','ğŸ“š','ğŸ¯','ğŸ¦','ğŸ¶'];

        let membersHTML = members.map(m => {
            const isMemberAdmin = admins.includes(m);
            const isMemberMod = moderators.includes(m);
            const canRemoveAdmin = isAdmin && isMemberAdmin && m !== myUsername && admins.length > 1;
            const roleBadge = isMemberAdmin
                ? `<span style="font-size:11px;background:var(--primary);color:white;border-radius:10px;padding:1px 7px;">Admin</span>`
                : isMemberMod
                ? `<span style="font-size:11px;background:#f39c12;color:white;border-radius:10px;padding:1px 7px;">Mod</span>`
                : '';
            return `
            <div class="contact-item" style="padding:10px 0; border-bottom:1px solid var(--border-color);">
                ${getAvatarHTML(m)}
                <span style="flex:1;">${m} ${roleBadge}</span>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                    ${isAdmin && m !== myUsername && !isMemberAdmin && !isMemberMod ? `<span style="cursor:pointer; color:var(--primary); font-size:12px;" onclick="makeAdmin('${m}')">ğŸ‘‘</span>` : ''}
                    ${isAdmin && m !== myUsername && !isMemberMod && !isMemberAdmin ? `<span style="cursor:pointer; color:#f39c12; font-size:12px;" onclick="makeModerator('${m}')">ğŸ›¡ï¸</span>` : ''}
                    ${canRemoveAdmin ? `<span style="cursor:pointer; color:#999; font-size:12px;" onclick="removeAdmin('${m}')">ğŸ‘‘âœ•</span>` : ''}
                    ${isAdmin && isMemberMod && m !== myUsername ? `<span style="cursor:pointer; color:#999; font-size:12px;" onclick="removeModerator('${m}')">ğŸ›¡ï¸âœ•</span>` : ''}
                    ${canManage && m !== myUsername && !isMemberAdmin ? `<span style="cursor:pointer; color:#dc3545; font-size:12px;" onclick="removeMemberFromGroup('${m}')">Entfernen</span>` : ''}
                </div>
            </div>
        `}).join('');

        document.getElementById('group-info-content').innerHTML = `
            <div style="text-align:center; margin-bottom:16px;">
                <div class="avatar" style="background:${stringToColor(g.name)}; width:70px; height:70px; margin:0 auto 8px; font-size:36px; cursor:${isAdmin?'pointer':'default'};" 
                     ${isAdmin ? `onclick="document.getElementById('group-avatar-picker').style.display=document.getElementById('group-avatar-picker').style.display==='flex'?'none':'flex'" title="Avatar Ã¤ndern"` : ''}>
                    ${avatar}
                </div>
                ${isAdmin ? `
                <div id="group-avatar-picker" style="display:none; flex-wrap:wrap; justify-content:center; gap:6px; margin:8px 0; background:var(--bg); border-radius:12px; padding:10px;">
                    ${GROUP_EMOJIS.map(e => `<span style="font-size:24px; cursor:pointer; padding:4px; border-radius:6px;" onclick="setGroupAvatar('${e}')">${e}</span>`).join('')}
                </div>
                ` : ''}
                <div style="font-size:20px; font-weight:700;">${g.name}</div>
                <div style="font-size:12px; opacity:0.5;">Erstellt von ${g.createdBy} Â· ${new Date(g.createdAt).toLocaleDateString('de-DE')}</div>
                ${g.description ? `<div style="font-size:13px; opacity:0.7; margin-top:6px; font-style:italic;">${g.description}</div>` : ''}
            </div>
            ${isAdmin ? `
            <div style="display:flex; gap:6px; margin-bottom:10px;">
                <input type="text" id="group-rename-input" placeholder="Gruppe umbenennen..." value="${g.name}" style="flex:1; margin:0;">
                <button onclick="renameGroup()" style="width:50px; margin:0;">âœï¸</button>
            </div>
            <div style="display:flex; gap:6px; margin-bottom:14px;">
                <input type="text" id="group-desc-input" placeholder="Beschreibung..." value="${g.description || ''}" style="flex:1; margin:0;">
                <button onclick="saveGroupDescription()" style="width:50px; margin:0;">ğŸ’¾</button>
            </div>
            ` : ''}
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <button id="btn-group-mute" onclick="toggleMuteGroup('${activeGroupId}')" style="flex:1; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">
                    ${getMutedChats().includes(activeGroupId) ? 'ğŸ”Š Laut' : 'ğŸ”‡ Stumm'}
                </button>
                <button id="btn-group-archive" onclick="toggleArchiveGroup('${activeGroupId}')" style="flex:1; background:var(--bg); color:var(--text-color); border:1px solid var(--border-color);">
                    ${getArchivedChats().includes(activeGroupId) ? 'ğŸ“¤ Aus Archiv' : 'ğŸ—‚ï¸ Archivieren'}
                </button>
            </div>
            <div style="margin-bottom:14px; padding:10px 12px; background:var(--bg); border-radius:10px; border:1px solid var(--border-color);">
                <div style="font-size:11px; opacity:0.5; margin-bottom:4px;">EINLADUNGSLINK</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <code style="flex:1; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; opacity:0.7;">${location.origin}${location.pathname}?join=${activeGroupId}</code>
                    <button onclick="copyInviteLink('${activeGroupId}')" style="padding:4px 10px; margin:0; font-size:12px; white-space:nowrap;">ğŸ“‹ Kopieren</button>
                </div>
            </div>
            <div style="font-weight:600; margin-bottom:8px;">${members.length} Mitglieder</div>
            ${membersHTML}
            ${isAdmin ? `
            <div style="margin-top:16px; border-top:1px solid var(--border-color); padding-top:14px;">
                <div style="font-weight:600; margin-bottom:8px;">Mitglied hinzufÃ¼gen:</div>
                <div style="display:flex; gap:6px; margin-bottom:4px;">
                    <input type="text" id="group-add-member-input" placeholder="Kontakt suchen..." style="flex:1; margin:0;" oninput="liveSearchGroupAddMember()">
                    <button onclick="addMemberToGroup()" style="width:50px; margin:0;">+</button>
                </div>
                <div id="group-add-member-results" style="margin-bottom:8px;"></div>
            </div>
            ` : ''}
            <button onclick="leaveGroup('${activeGroupId}')" style="width:100%; margin-top:14px; background:#dc3545;">ğŸšª Gruppe verlassen</button>
        `;

        document.getElementById('group-info-overlay').style.display = 'flex';
    };

    window.saveGroupDescription = async () => {
        if(!activeGroupId) return;
        const input = document.getElementById('group-desc-input');
        const desc = input ? input.value.trim() : '';
        await update(ref(db, `groups/${activeGroupId}`), { description: desc });
        showNotification('âœ… Beschreibung gespeichert', 'success');
        window.openGroupInfo();
    };

    window.copyInviteLink = (gid) => {
        const link = `${location.origin}${location.pathname}?join=${gid}`;
        navigator.clipboard.writeText(link).then(() => {
            showNotification('ğŸ“‹ Einladungslink kopiert!', 'success');
        });
    };

    window.makeModerator = async (memberName) => {
        if(!activeGroupId) return;
        await update(ref(db, `groups/${activeGroupId}/moderators`), { [memberName]: true });
        push(ref(db, `chats/${activeGroupId}`), {
            sender: 'ğŸ¤– System',
            text: `${memberName} wurde von ${myUsername} zum Moderator ernannt.`,
            timestamp: Date.now(), read: false, isSystem: true
        });
        showNotification(`âœ… ${memberName} ist jetzt Moderator`, 'success');
        window.openGroupInfo();
    };

    window.removeModerator = async (memberName) => {
        if(!activeGroupId) return;
        await update(ref(db, `groups/${activeGroupId}/moderators`), { [memberName]: null });
        push(ref(db, `chats/${activeGroupId}`), {
            sender: 'ğŸ¤– System',
            text: `${memberName} ist kein Moderator mehr.`,
            timestamp: Date.now(), read: false, isSystem: true
        });
        showNotification(`âœ… Moderator-Rolle entzogen`, 'success');
        window.openGroupInfo();
    };

    window.makeAdmin = async (memberName) => {
        if(!activeGroupId) return;
        await update(ref(db, `groups/${activeGroupId}/admins`), { [memberName]: true });
        push(ref(db, `chats/${activeGroupId}`), {
            sender: 'ğŸ¤– System',
            text: `${memberName} wurde von ${myUsername} zum Admin ernannt.`,
            timestamp: Date.now(),
            read: false,
            isSystem: true
        });
        showNotification(`âœ… ${memberName} ist jetzt Admin`, 'success');
        window.openGroupInfo();
    };

    window.removeAdmin = async (memberName) => {
        if(!activeGroupId) return;
        // Safety check: at least one admin must remain
        const gSnap = await get(ref(db, `groups/${activeGroupId}/admins`));
        const currentAdmins = gSnap.exists() ? Object.keys(gSnap.val()).filter(a => gSnap.val()[a] === true) : [];
        if(currentAdmins.length <= 1) {
            showNotification('âš ï¸ Mindestens ein Admin muss Ã¼brig bleiben', 'error');
            return;
        }
        await update(ref(db, `groups/${activeGroupId}/admins`), { [memberName]: null });
        push(ref(db, `chats/${activeGroupId}`), {
            sender: 'ğŸ¤– System',
            text: `${memberName} wurden die Admin-Rechte von ${myUsername} entzogen.`,
            timestamp: Date.now(),
            read: false,
            isSystem: true
        });
        showNotification(`âœ… Admin-Rechte von ${memberName} entzogen`, 'success');
        window.openGroupInfo();
    };

    window.toggleMuteGroup = (gid) => {
        const muted = getMutedChats();
        const idx = muted.indexOf(gid);
        if(idx === -1) { muted.push(gid); } else { muted.splice(idx, 1); }
        localStorage.setItem('villo_muted', JSON.stringify(muted));
        const btn = document.getElementById('btn-group-mute');
        if(btn) btn.textContent = idx === -1 ? 'ğŸ”Š Laut' : 'ğŸ”‡ Stumm';
        showNotification(idx === -1 ? 'ğŸ”‡ Gruppe stummgeschaltet' : 'ğŸ”Š Gruppe nicht mehr stumm', 'success');
        loadGroups();
    };

    window.toggleArchiveGroup = (gid) => {
        const archived = getArchivedChats();
        const idx = archived.indexOf(gid);
        if(idx === -1) { archived.push(gid); } else { archived.splice(idx, 1); }
        localStorage.setItem('villo_archived', JSON.stringify(archived));
        const btn = document.getElementById('btn-group-archive');
        if(btn) btn.textContent = idx === -1 ? 'ğŸ“¤ Aus Archiv' : 'ğŸ—‚ï¸ Archivieren';
        showNotification(idx === -1 ? 'ğŸ—‚ï¸ Gruppe archiviert' : 'ğŸ“¤ Gruppe aus Archiv', 'success');
        closeOverlay('group-info-overlay');
        if(idx === -1) closeChat();
        loadGroups();
    };

    window.liveSearchGroupAddMember = async () => {
        const q = document.getElementById('group-add-member-input').value.trim();
        const resultsEl = document.getElementById('group-add-member-results');
        if(!resultsEl) return;
        if(!q) { resultsEl.innerHTML = ''; return; }
        // Get current group members to exclude
        const gSnap = await get(ref(db, `groups/${activeGroupId}/members`));
        const currentMembers = gSnap.exists() ? Object.keys(gSnap.val()) : [];
        const found = await searchContactsPartial(q, currentMembers);
        renderContactSearchResults(found, resultsEl, (name) => {
            document.getElementById('group-add-member-input').value = name;
            resultsEl.innerHTML = '';
        });
    };

    window.addMemberToGroup = async () => {
        const input = document.getElementById('group-add-member-input');
        const newMember = input.value.trim();
        if(!newMember || !activeGroupId) return;

        // Check group add permission
        const targetPrivSnap = await get(ref(db, `accounts/${newMember}/groupAddPrivacy`));
        const priv = targetPrivSnap.val() || 'all';
        if(priv === 'none') { showNotification('âŒ Dieser User lÃ¤sst keine Gruppeneinladungen zu', 'error'); return; }
        if(priv === 'contacts') {
            const theirContactsSnap = await get(ref(db, `accounts/${newMember}/contacts`));
            const theirContacts = theirContactsSnap.exists() ? Object.values(theirContactsSnap.val()).filter(Boolean) : [];
            if(!theirContacts.includes(myUsername)) { showNotification('âŒ Dieser User nimmt nur Einladungen von Kontakten an', 'error'); return; }
        }

        // Try contacts first, then Firebase fallback
        const accSnap = await get(ref(db, `accounts/${newMember}`));
        if(!accSnap.exists()) { showNotification('âŒ User nicht gefunden', 'error'); return; }

        await update(ref(db, `groups/${activeGroupId}/members`), { [newMember]: true });
        await push(ref(db, `accounts/${newMember}/groups`), activeGroupId);

        push(ref(db, `chats/${activeGroupId}`), {
            sender: 'ğŸ¤– System',
            text: `${newMember} wurde von ${myUsername} hinzugefÃ¼gt.`,
            timestamp: Date.now(),
            read: false,
            isSystem: true
        });

        input.value = '';
        const resultsEl = document.getElementById('group-add-member-results');
        if(resultsEl) resultsEl.innerHTML = '';
        showNotification(`âœ… ${newMember} hinzugefÃ¼gt`, 'success');
        openGroupInfo();
    };

    window.removeMemberFromGroup = async (memberName) => {
        if(!activeGroupId) return;
        await update(ref(db, `groups/${activeGroupId}/members`), { [memberName]: null });

        // Remove group from member's account list
        const gSnap = await get(ref(db, `accounts/${memberName}/groups`));
        if(gSnap.exists()) {
            Object.entries(gSnap.val()).forEach(([key, val]) => {
                if(val === activeGroupId) remove(ref(db, `accounts/${memberName}/groups/${key}`));
            });
        }

        push(ref(db, `chats/${activeGroupId}`), {
            sender: 'ğŸ¤– System',
            text: `${memberName} wurde von ${myUsername} entfernt.`,
            timestamp: Date.now(),
            read: false,
            isSystem: true
        });

        showNotification(`âœ… ${memberName} entfernt`, 'success');
        openGroupInfo(); // Refresh
    };

    window.leaveGroup = async (gid) => {
        if(!gid) return;
        closeOverlay('group-info-overlay');

        await update(ref(db, `groups/${gid}/members`), { [myUsername]: null });
        const myGroupsSnap = await get(ref(db, `accounts/${myUsername}/groups`));
        if(myGroupsSnap.exists()) {
            Object.entries(myGroupsSnap.val()).forEach(([key, val]) => {
                if(val === gid) remove(ref(db, `accounts/${myUsername}/groups/${key}`));
            });
        }

        push(ref(db, `chats/${gid}`), {
            sender: 'ğŸ¤– System',
            text: `${myUsername} hat die Gruppe verlassen.`,
            timestamp: Date.now(),
            read: false,
            isSystem: true
        });

        showNotification('ğŸ‘‹ Gruppe verlassen', 'success');
        closeChat();
    };

    // â”€â”€ Patch closeChat to reset group state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origCloseChat = window.closeChat;
    window.closeChat = () => {
        activeGroupId = null;
        const groupMenuItem = document.getElementById('menu-group-info');
        if(groupMenuItem) groupMenuItem.style.display = 'none';
        _origCloseChat();
    };

    // â”€â”€ Patch showApp to also load groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origShowApp = showApp;
    // We hook into the contacts listener callback â€” groups load separately
    // Call loadGroups after showApp runs
    const origShowAppFn = window.showApp;

    // Override the exported showApp reference used inside closeChat
    // Since showApp is a local function, we call loadGroups after auth
    // This is done by hooking into the auth success path below


    // Problem: Safari auf iOS verschiebt das Layout nicht korrekt,
    //          wenn die Tastatur aufgeht â†’ Input-Bereich verschwindet.
    // LÃ¶sung:  visualViewport API messen und #main-chat exakt
    //          auf die sichtbare FlÃ¤che beschrÃ¤nken.
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function iosKeyboardFix() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (!isIOS && !isSafari) return; // Nur auf iOS/Safari aktiv
        
        const mainChat = document.getElementById('main-chat');
        const chatArea = document.getElementById('chat-area');
        
        function applyViewport() {
            if (!window.visualViewport) return;
            
            const vv = window.visualViewport;
            const offsetTop = vv.offsetTop || 0;
            const visibleHeight = vv.height;
            
            // Setze die HÃ¶he von #chat-area auf die sichtbare HÃ¶he
            // (d.h. Bildschirm minus Tastatur minus Statusbar)
            if (chatArea) {
                chatArea.style.height = visibleHeight + 'px';
                chatArea.style.top = offsetTop + 'px';
            }
            
            // Nachrichten ans Ende scrollen, damit der Fokus stimmt
            const msgContainer = document.getElementById('messages-container');
            if (msgContainer) {
                requestAnimationFrame(() => {
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                });
            }
        }
        
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', applyViewport);
            window.visualViewport.addEventListener('scroll', applyViewport);
        }
        
        // ZusÃ¤tzlich: Wenn Input fokussiert wird, kurz warten bis
        // Tastatur offen ist, dann ans Ende scrollen
        document.addEventListener('focusin', (e) => {
            if (e.target.id === 'msg-input' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                setTimeout(() => {
                    applyViewport();
                    // Sicherstellen dass Input sichtbar ist
                    e.target.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }, 350); // ~Zeit bis Tastatur offen
            }
        });
        
        document.addEventListener('focusout', (e) => {
            if (e.target.id === 'msg-input' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                setTimeout(applyViewport, 100);
            }
        });
        
        // CSS-Fix: verhindert Bounce/Overscroll auf iOS
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        document.body.style.overflowY = 'hidden';
        
        console.log('ğŸ“± iOS Keyboard Fix aktiv');
    })();
    
    // Install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        setTimeout(() => {
            const settingsBody = document.querySelector('#settings-overlay .modal-body');
            if(settingsBody && !document.getElementById('pwa-install-btn')) {
                const btn = document.createElement('button');
                btn.id = 'pwa-install-btn';
                btn.textContent = 'ğŸ“² Als App installieren';
                btn.style.cssText = 'width:100%; margin-top:10px; background:var(--primary);';
                btn.onclick = async () => {
                    if(!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const result = await deferredPrompt.userChoice;
                    if(result.outcome === 'accepted') {
                        showNotification('âœ… App installiert!', 'success');
                        btn.remove();
                    }
                    deferredPrompt = null;
                };
                const logoutBtn = settingsBody.querySelector('button[onclick="logout()"]');
                settingsBody.insertBefore(btn, logoutBtn);
            }
        }, 3000);
    });
};
</script>

    <!-- Hilfe-Funktion frÃ¼h verfÃ¼gbar machen (vor Module-Script-Load) -->
    <script>
        function openHelp() {
            const overlay = document.getElementById('help-overlay');
            if(!overlay) return;
            overlay.style.display = 'flex';
            const search = document.getElementById('help-search');
            if(search) search.value = '';
            // showHelpNav & renderHelpList werden vom Module-Script Ã¼bernommen sobald geladen
            const nav = document.getElementById('help-nav');
            const view = document.getElementById('help-article-view');
            if(nav) nav.style.display = 'block';
            if(view) view.style.display = 'none';
            // Artikel-Liste rendern falls Module schon geladen
            if(window._renderHelpList && window._helpArticles) {
                window._renderHelpList(window._helpArticles);
            }
        }
    </script>
</body>
</html>
