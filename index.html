<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VilloChat</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        #login-area { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        #chat-area { display: none; height: 100vh; display: flex; }
        
        /* Sidebar */
        #sidebar { width: 300px; border-right: 1px solid #ddd; background: white; display: flex; flex-direction: column; }
        .contact { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .contact:hover { background: #f9f9f9; }

        /* Chat Window */
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; }
        #messages-container { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background: #e5ddd5; }
        .msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; max-width: 70%; word-wrap: break-word; }
        .sent { align-self: flex-end; background: #dcf8c6; }
        .received { align-self: flex-start; background: white; }

        /* Input */
        #input-area { padding: 10px; background: #f0f0f0; display: flex; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        #msg-input { flex-grow: 1; margin-right: 10px; }
        button { padding: 10px 20px; background: #075e54; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-area">
        <svg width="60" height="60" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#075e54" stroke-width="5"/><path d="M30 40 L50 70 L70 30" fill="none" stroke="#075e54" stroke-width="8" stroke-linecap="round"/></svg>
        <h2>VilloChat</h2>
        <input type="text" id="v-username" placeholder="Benutzerkennung (z.B. Max88)" style="margin-bottom:10px; width: 250px;">
        <input type="email" id="v-email" placeholder="E-Mail (optional)" style="margin-bottom:10px; width: 250px;">
        <button id="btn-login">Chat starten</button>
    </div>

    <div id="chat-area" style="display:none;">
        <div id="sidebar">
            <div style="padding: 20px; background: #075e54; color: white; font-weight: bold;">VilloChat</div>
            <div style="padding: 10px; border-bottom: 1px solid #ddd;">
                <input type="text" id="search-input" placeholder="Kennung suchen..." style="width: 70%;">
                <button id="btn-search" style="padding: 5px 10px;">+</button>
            </div>
            <div id="contacts-list"></div>
        </div>
        <div id="main-chat">
            <div id="chat-header" style="padding: 15px; background: #eee; border-bottom: 1px solid #ddd;">Wähle einen Kontakt</div>
            <div id="messages-container"></div>
            <div id="input-area">
                <input type="text" id="msg-input" placeholder="Nachricht...">
                <button id="btn-send">Senden</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onChildAdded, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3wZU09SzNh7xZFPFjPHR9nhDCWkGzj7E",
            authDomain: "villochat.firebaseapp.com",
            databaseURL: "https://villochat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "villochat",
            storageBucket: "villochat.firebasestorage.app",
            messagingSenderId: "257561919332",
            appId: "1:257561919332:web:712d942c2f2e07169e8471"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let activeChatId = null;

        // LOGIN LOGIK
        document.getElementById('btn-login').onclick = async () => {
            const user = document.getElementById('v-username').value;
            const mail = document.getElementById('v-email').value;
            if(!user) return alert("Kennung wählen!");

            const cred = await signInAnonymously(auth);
            await set(ref(db, 'users/' + cred.user.uid), {
                username: user,
                email: mail,
                id: user.toLowerCase()
            });
            location.reload(); // Seite neu laden um State zu triggern
        };

        // AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await get(ref(db, `users/${user.uid}`));
                if(snap.exists()) {
                    document.getElementById('login-area').style.display = 'none';
                    document.getElementById('chat-area').style.display = 'flex';
                }
            }
        });

        // KONTAKT SUCHEN
        document.getElementById('btn-search').onclick = async () => {
            const name = document.getElementById('search-input').value.toLowerCase();
            const q = query(ref(db, 'users'), orderByChild('id'), equalTo(name));
            const snap = await get(q);
            if(snap.exists()) {
                const uid = Object.keys(snap.val())[0];
                const data = snap.val()[uid];
                const div = document.createElement('div');
                div.className = 'contact';
                div.innerText = data.username;
                div.onclick = () => startChat(uid, data.username);
                document.getElementById('contacts-list').appendChild(div);
            } else { alert("Nicht gefunden!"); }
        };

        // CHAT STARTEN
        function startChat(targetUid, name) {
            activeChatId = auth.currentUser.uid < targetUid ? auth.currentUser.uid+"_"+targetUid : targetUid+"_"+auth.currentUser.uid;
            document.getElementById('chat-header').innerText = "Chat mit " + name;
            document.getElementById('messages-container').innerHTML = "";
            
            onChildAdded(ref(db, 'chats/' + activeChatId), (snap) => {
                const m = snap.val();
                const d = document.createElement('div');
                d.className = 'msg ' + (m.sender === auth.currentUser.uid ? 'sent' : 'received');
                d.innerText = m.text;
                document.getElementById('messages-container').appendChild(d);
            });
        }

        // SENDEN
        document.getElementById('btn-send').onclick = () => {
            const txt = document.getElementById('msg-input').value;
            if(!txt || !activeChatId) return;
            push(ref(db, 'chats/' + activeChatId), {
                sender: auth.currentUser.uid,
                text: txt
            });
            document.getElementById('msg-input').value = "";
        };
    </script>
</body>
</html>
