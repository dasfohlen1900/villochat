<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
    getDatabase, ref, set, get, push,
    onChildAdded, onChildRemoved,
    remove, onValue, off,
    query, orderByChild, startAt, endAt
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyB3wZU09SzNh7xZFPFjPHR9nhDCWkGzj7E",
    authDomain: "villochat.firebaseapp.com",
    databaseURL: "https://villochat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "villochat",
    storageBucket: "villochat.firebasestorage.app",
    messagingSenderId: "257561919332",
    appId: "1:257561919332:web:712d942c2f2e07169e8471"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let myUsername = "",
    activeChatId = null,
    currentMode = 'login',
    chatRef = null,
    typingRef = null;

marked.setOptions({ breaks: true });

/* ------------------------------------------------ */
/* AVATAR */
/* ------------------------------------------------ */

function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++)
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash) % 360},65%,40%)`;
}

function getAvatarHTML(name) {
    return `<div class="avatar"
        style="background:${stringToColor(name)}">
        ${name.charAt(0)}
    </div>`;
}

/* ------------------------------------------------ */
/* AUTH */
/* ------------------------------------------------ */

window.setAuth = (m) => currentMode = m;

document.getElementById('v-pin').addEventListener('input', e => {
    let v = e.target.value.replace(/\D/g, '');
    if (v.length > 4)
        v = v.slice(0, 4) + '-' + v.slice(4, 8);
    e.target.value = v;
});

document.getElementById('btn-auth').onclick = async () => {
    const u = document.getElementById('v-username').value.trim();
    const p = document.getElementById('v-pin').value;
    if (!u || p.length < 9) return alert("Daten unvollstÃ¤ndig!");

    const s = await get(ref(db, 'accounts/' + u));

    if (currentMode === 'register') {
        if (s.exists()) return alert("Name belegt!");
        await set(ref(db, 'accounts/' + u), {
            username: u,
            pin: p,
            id: u.toLowerCase()
        });
        alert("Registriert âœ”");
        return;
    }

    if (!s.exists() || s.val().pin !== p)
        return alert("Login falsch!");

    await signInAnonymously(auth);
    myUsername = u;
    localStorage.setItem('villo_session', u);
    showApp();
};

/* ------------------------------------------------ */
/* APP START */
/* ------------------------------------------------ */

function showApp() {
    document.getElementById('auth-area').style.display = 'none';
    document.getElementById('chat-area').style.display = 'flex';
    document.getElementById('my-name-display').innerText = myUsername;

    onValue(ref(db, `accounts/${myUsername}/contacts`), snap => {
        const list = document.getElementById('contacts-list');
        list.innerHTML = "";
        if (!snap.exists()) return;

        Object.values(snap.val()).forEach(n => {
            const d = document.createElement('div');
            d.className = 'contact-item';
            d.innerHTML =
                `${getAvatarHTML(n)}
                 <span>${n}</span>
                 <span class="del-contact"
                   onclick="removeContact('${n}')">âœ•</span>`;
            d.onclick = () => startChat(n);
            list.appendChild(d);
        });
    });
}

/* ------------------------------------------------ */
/* CHAT */
/* ------------------------------------------------ */

function startChat(n) {

    if (chatRef) off(chatRef);
    if (typingRef) off(typingRef);

    activeChatId =
        myUsername < n
            ? `${myUsername}_${n}`
            : `${n}_${myUsername}`;

    document.getElementById('messages-container').innerHTML = "";
    document.getElementById('chat-area')
        .classList.add('chat-open');

    chatRef = ref(db, 'chats/' + activeChatId);

    onChildAdded(chatRef, s => {
        const m = s.val();
        const d = document.createElement('div');
        d.className =
            'msg ' +
            (m.sender === myUsername ? 'sent' : 'received');
        d.id = "m-" + s.key;

        const time = new Date(m.timestamp)
            .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const del =
            m.sender === myUsername
                ? `<span class="del-msg"
                   onclick="deleteMsg('${s.key}')">ðŸ—‘</span>`
                : "";

        d.innerHTML =
            `<div>${marked.parse(m.text)}</div>
             <span class="msg-time">${time} ${del}</span>`;

        const c = document.getElementById('messages-container');
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    });

    onChildRemoved(chatRef, s => {
        const el = document.getElementById("m-" + s.key);
        if (el) el.remove();
    });

    typingRef = ref(db, `typing/${activeChatId}/${n}`);
    onValue(typingRef, s => {
        document.getElementById('typing-status')
            .innerText =
            s.val() ? `${n} schreibt gerade...` : "";
    });
}

window.deleteMsg = (mid) => {
    if (!activeChatId) return;
    remove(ref(db, `chats/${activeChatId}/${mid}`));
};

window.removeContact = async (n) => {
    const snap = await get(
        ref(db, `accounts/${myUsername}/contacts`)
    );
    if (!snap.exists()) return;

    Object.entries(snap.val()).forEach(([key, val]) => {
        if (val === n)
            remove(ref(db,
                `accounts/${myUsername}/contacts/${key}`));
    });
};

document.getElementById('btn-send').onclick = () => {
    const input = document.getElementById('msg-input');
    if (!input.value.trim() || !activeChatId) return;

    push(ref(db, 'chats/' + activeChatId), {
        sender: myUsername,
        text: input.value,
        timestamp: Date.now()
    });

    input.value = "";
};

window.onload = () => {
    const s = localStorage.getItem('villo_session');
    if (s) {
        myUsername = s;
        showApp();
    }
};
</script>
